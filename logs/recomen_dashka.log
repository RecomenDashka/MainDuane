2025-06-17 04:18:49,569 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:18:49,569 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:18:49,569 - agents.genre_mapper - INFO - Loaded 0 unique genres from database.
2025-06-17 04:18:49,570 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:19:37,986 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:19:37,986 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:19:37,987 - agents.genre_mapper - INFO - Loaded 0 unique genres from database.
2025-06-17 04:19:37,987 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:20:31,413 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:20:31,413 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:20:31,413 - agents.genre_mapper - INFO - Loaded 0 unique genres from database.
2025-06-17 04:20:31,413 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:20:31,445 - __main__ - INFO - Запуск Telegram-бота...
2025-06-17 04:20:44,177 - recommendation_engine - INFO - Generating recommendations for user 577976124 with query: 'привет'
2025-06-17 04:20:44,179 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 04:20:52,462 - recommendation_engine - INFO - Searching TMDB for movie: '(Ищейка)' parsed from LLM response.
2025-06-17 04:20:53,020 - movie_database - INFO - Фильм 'The Hound of London' (TMDB ID: 558898) добавлен в базу данных.
2025-06-17 04:20:53,021 - recommendation_engine - INFO - Added new movie 'The Hound of London' to database with local ID: 1
2025-06-17 04:20:53,025 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=1, action_type='recommendation'.
2025-06-17 04:20:53,026 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 1
2025-06-17 04:20:53,026 - recommendation_engine - INFO - Searching TMDB for movie: '(Форт Боярд)' parsed from LLM response.
2025-06-17 04:20:53,270 - tmdb_agent - WARNING - Фильм '(Форт Боярд)' не найден в TMDB.
2025-06-17 04:20:53,270 - recommendation_engine - WARNING - Could not find or enrich movie data for title: '(Форт Боярд)'. Skipping this recommendation.
2025-06-17 04:20:53,271 - recommendation_engine - INFO - Searching TMDB for movie: '(Начало)' parsed from LLM response.
2025-06-17 04:20:54,043 - movie_database - INFO - Фильм 'Gogol. The Beginning' (TMDB ID: 468988) добавлен в базу данных.
2025-06-17 04:20:54,043 - recommendation_engine - INFO - Added new movie 'Gogol. The Beginning' to database with local ID: 2
2025-06-17 04:20:54,044 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=2, action_type='recommendation'.
2025-06-17 04:20:54,044 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 2
2025-06-17 04:20:54,044 - recommendation_engine - INFO - Searching TMDB for movie: '(Матрица)' parsed from LLM response.
2025-06-17 04:20:54,534 - movie_database - INFO - Фильм 'Sexual Matrix' (TMDB ID: 51767) добавлен в базу данных.
2025-06-17 04:20:54,534 - recommendation_engine - INFO - Added new movie 'Sexual Matrix' to database with local ID: 3
2025-06-17 04:20:54,535 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=3, action_type='recommendation'.
2025-06-17 04:20:54,535 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 3
2025-06-17 04:20:54,535 - recommendation_engine - INFO - Searching TMDB for movie: '(Останкино)' parsed from LLM response.
2025-06-17 04:20:55,015 - movie_database - INFO - Фильм 'Советская Империя - Останкино' (TMDB ID: 456825) добавлен в базу данных.
2025-06-17 04:20:55,016 - recommendation_engine - INFO - Added new movie 'Советская Империя - Останкино' to database with local ID: 4
2025-06-17 04:20:55,019 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=4, action_type='recommendation'.
2025-06-17 04:20:55,020 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 4
2025-06-17 04:21:26,818 - recommendation_engine - INFO - Generating recommendations for user 577976124 with query: 'порекомендуй фильм про человека паука'
2025-06-17 04:21:26,819 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'порекомендуй фильм про человека паука...'
2025-06-17 04:21:29,447 - recommendation_engine - INFO - Searching TMDB for movie: '(Человек-)Паук: Дом Дьявола' parsed from LLM response.
2025-06-17 04:21:29,684 - tmdb_agent - WARNING - Фильм '(Человек-)Паук: Дом Дьявола' не найден в TMDB.
2025-06-17 04:21:29,684 - recommendation_engine - WARNING - Could not find or enrich movie data for title: '(Человек-)Паук: Дом Дьявола'. Skipping this recommendation.
2025-06-17 04:21:29,684 - recommendation_engine - INFO - Searching TMDB for movie: '(Человек-)Паук: Вдали от дома' parsed from LLM response.
2025-06-17 04:21:30,140 - movie_database - INFO - Фильм 'Spider-Man: Far From Home' (TMDB ID: 429617) добавлен в базу данных.
2025-06-17 04:21:30,140 - recommendation_engine - INFO - Added new movie 'Spider-Man: Far From Home' to database with local ID: 5
2025-06-17 04:21:30,142 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=5, action_type='recommendation'.
2025-06-17 04:21:30,142 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 5
2025-06-17 04:21:30,142 - recommendation_engine - INFO - Searching TMDB for movie: 'День судного приговора (2002)' parsed from LLM response.
2025-06-17 04:21:30,458 - tmdb_agent - WARNING - Фильм 'День судного приговора (2002)' не найден в TMDB.
2025-06-17 04:21:30,458 - recommendation_engine - WARNING - Could not find or enrich movie data for title: 'День судного приговора (2002)'. Skipping this recommendation.
2025-06-17 04:30:17,531 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:30:17,531 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:30:17,531 - agents.genre_mapper - INFO - Loaded 11 unique genres from database.
2025-06-17 04:30:17,531 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:30:19,503 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:30:19,503 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:30:19,504 - agents.genre_mapper - INFO - Loaded 11 unique genres from database.
2025-06-17 04:30:19,504 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:31:15,718 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:31:15,718 - movie_database - INFO - Соединение с базой данных movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:31:15,718 - agents.genre_mapper - INFO - Loaded 11 unique genres from database.
2025-06-17 04:31:15,719 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:35:27,225 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:35:27,225 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:35:27,226 - agents.genre_mapper - INFO - Loaded 81 unique genres from database.
2025-06-17 04:35:27,226 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:35:27,245 - __main__ - INFO - Запуск Telegram-бота...
2025-06-17 04:35:41,473 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 04:35:41,475 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:35:42,871 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 04:35:45,456 - recommendation_engine - INFO - LLM candidate response: "Марселлок" (1962), "Список шулеров" (2000), "Логан" (2017), "Инception" (2010), "Джентльмены преступники" (2019)
2025-06-17 04:35:45,459 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'привет': 'coroutine' object is not subscriptable
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 224, in generate_recommendations
    for title_ru, year in candidate_titles_with_years[:5]:  # Ограничиваем количество кандидатов
                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^
TypeError: 'coroutine' object is not subscriptable
2025-06-17 04:37:09,318 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 04:37:09,318 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 04:37:09,319 - agents.genre_mapper - INFO - Loaded 81 unique genres from database.
2025-06-17 04:37:09,320 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 04:37:09,339 - __main__ - INFO - Запуск Telegram-бота...
2025-06-17 04:37:15,073 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 04:37:15,074 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:37:16,260 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 04:37:17,892 - recommendation_engine - INFO - LLM candidate response: «Инception» (2010), «Гравитация» (2013), «Интерстеллар» (2014), «Логика империума» (2016), «Тень боя» (2018)
2025-06-17 04:37:17,892 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Гравитация', 2013), ('Интерстеллар', 2014), ('Логика империума', 2016), ('Тень боя', 2018)]
2025-06-17 04:37:17,892 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:37:19,170 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 04:37:19,170 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 04:37:20,070 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'привет'

Детали фильма: Название: Inception. Оригинальное название: Inception....'
2025-06-17 04:37:21,728 - recommendation_engine - INFO - Validation for 'Inception' against 'привет...': Not Relevant
2025-06-17 04:37:21,729 - recommendation_engine - WARNING - Movie 'Inception' deemed not relevant to original query: 'привет...'. Skipping.
2025-06-17 04:37:21,729 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:37:23,541 - recommendation_engine - INFO - Translated Russian title 'Гравитация' to English for TMDB search: 'Gravity'
2025-06-17 04:37:23,542 - recommendation_engine - INFO - Searching TMDB for movie: 'Gravity' (original: 'Гравитация')
2025-06-17 04:37:24,134 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'привет'

Детали фильма: Название: Gravity. Оригинальное название: Gravity. Год...'
2025-06-17 04:37:25,453 - recommendation_engine - INFO - Validation for 'Gravity' against 'привет...': Relevant
2025-06-17 04:37:25,458 - movie_database - INFO - Фильм 'Gravity' (TMDB ID: 49047) добавлен в базу данных.
2025-06-17 04:37:25,458 - recommendation_engine - INFO - Added movie 'Gravity' to DB as ID 96
2025-06-17 04:37:25,459 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=96, action_type='recommendation'.
2025-06-17 04:37:25,460 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 96
2025-06-17 04:37:25,460 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:37:26,586 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 04:37:26,586 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 04:37:27,260 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'привет'

Детали фильма: Название: Interstellar. Оригинальное название: Interst...'
2025-06-17 04:37:28,285 - recommendation_engine - INFO - Validation for 'Interstellar' against 'привет...': Not Relevant
2025-06-17 04:37:28,286 - recommendation_engine - WARNING - Movie 'Interstellar' deemed not relevant to original query: 'привет...'. Skipping.
2025-06-17 04:37:28,287 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:37:29,854 - recommendation_engine - INFO - Translated Russian title 'Логика империума' to English for TMDB search: 'Imperial Logic'
2025-06-17 04:37:29,854 - recommendation_engine - INFO - Searching TMDB for movie: 'Imperial Logic' (original: 'Логика империума')
2025-06-17 04:37:30,216 - tmdb_agent - WARNING - Фильм 'Imperial Logic' не найден в TMDB.
2025-06-17 04:37:30,216 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Imperial Logic' (original: 'Логика империума'). Skipping.
2025-06-17 04:37:30,216 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:37:32,005 - recommendation_engine - INFO - Translated Russian title 'Тень боя' to English for TMDB search: 'Shadow of battle'
2025-06-17 04:37:32,006 - recommendation_engine - INFO - Searching TMDB for movie: 'Shadow of battle' (original: 'Тень боя')
2025-06-17 04:37:32,683 - recommendation_engine - WARNING - Год LLM (2018) не совпал с годом TMDB (1939) для 'Battles in the Shadow'. Пропускаем.
2025-06-17 04:37:32,683 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"Gravity"** (2013...'
2025-06-17 04:38:31,820 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'хочу фильм про киборга убийца'
2025-06-17 04:38:31,822 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:38:33,272 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'хочу фильм про киборга убийца...'
2025-06-17 04:38:35,432 - recommendation_engine - INFO - LLM candidate response: "Терминатор" (1984), "Терминатор 2: Судный день" (1991), "Терминатор 3: Восстание машин" (2003)
2025-06-17 04:38:35,433 - recommendation_engine - INFO - Extracted initial candidate titles: [('Терминатор', 1984), ('Терминатор 2: Судный день', 1991), ('Терминатор 3: Восстание машин', 2003)]
2025-06-17 04:38:35,433 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:38:36,993 - recommendation_engine - INFO - Translated Russian title 'Терминатор' to English for TMDB search: 'Terminator'
2025-06-17 04:38:36,994 - recommendation_engine - INFO - Searching TMDB for movie: 'Terminator' (original: 'Терминатор')
2025-06-17 04:38:37,483 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'хочу фильм про киборга убийца'

Детали фильма: Название: The Terminator. Ориги...'
2025-06-17 04:38:38,740 - recommendation_engine - INFO - Validation for 'The Terminator' against 'хочу фильм про киборга убийца...': Relevant
2025-06-17 04:38:38,743 - movie_database - INFO - Фильм 'The Terminator' (TMDB ID: 218) добавлен в базу данных.
2025-06-17 04:38:38,743 - recommendation_engine - INFO - Added movie 'The Terminator' to DB as ID 97
2025-06-17 04:38:38,744 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=97, action_type='recommendation'.
2025-06-17 04:38:38,744 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 97
2025-06-17 04:38:38,744 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:38:39,610 - recommendation_engine - INFO - Translated Russian title 'Терминатор 2: Судный день' to English for TMDB search: 'Terminator 2: Judgment Day'
2025-06-17 04:38:39,611 - recommendation_engine - INFO - Searching TMDB for movie: 'Terminator 2: Judgment Day' (original: 'Терминатор 2: Судный день')
2025-06-17 04:38:40,089 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'хочу фильм про киборга убийца'

Детали фильма: Название: Terminator 2: Judgmen...'
2025-06-17 04:38:43,108 - recommendation_engine - INFO - Validation for 'Terminator 2: Judgment Day' against 'хочу фильм про киборга убийца...': Relevant
2025-06-17 04:38:43,110 - movie_database - INFO - Фильм 'Terminator 2: Judgment Day' (TMDB ID: 280) добавлен в базу данных.
2025-06-17 04:38:43,111 - recommendation_engine - INFO - Added movie 'Terminator 2: Judgment Day' to DB as ID 98
2025-06-17 04:38:43,112 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=98, action_type='recommendation'.
2025-06-17 04:38:43,112 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 98
2025-06-17 04:38:43,112 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:38:44,940 - recommendation_engine - INFO - Translated Russian title 'Терминатор 3: Восстание машин' to English for TMDB search: 'Terminator 3: Rise of the Machines'
2025-06-17 04:38:44,941 - recommendation_engine - INFO - Searching TMDB for movie: 'Terminator 3: Rise of the Machines' (original: 'Терминатор 3: Восстание машин')
2025-06-17 04:38:45,404 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'хочу фильм про киборга убийца'

Детали фильма: Название: Terminator 3: Rise of...'
2025-06-17 04:38:47,003 - recommendation_engine - INFO - Validation for 'Terminator 3: Rise of the Machines' against 'хочу фильм про киборга убийца...': Relevant
2025-06-17 04:38:47,004 - recommendation_engine - INFO - Movie 'Terminator 3: Rise of the Machines' already in DB as ID 66
2025-06-17 04:38:47,005 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=66, action_type='recommendation'.
2025-06-17 04:38:47,006 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 66
2025-06-17 04:38:47,006 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"The Terminator"*...'
2025-06-17 04:39:28,911 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'давай фильм про подростка, который стал особенным'
2025-06-17 04:39:28,912 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:39:30,643 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'давай фильм про подростка, который стал особенным...'
2025-06-17 04:39:32,802 - recommendation_engine - INFO - LLM candidate response: "Чусовой" (2002), "Дом лето" (2013), "Суперволосы" (2007), "Спасти рядового Райана" (1998), "Хроники Нарнии: Лев, Ведьма и волшебный шкаф" (2005)
2025-06-17 04:39:32,803 - recommendation_engine - INFO - Extracted initial candidate titles: [('Чусовой', 2002), ('Дом лето', 2013), ('Суперволосы', 2007), ('Спасти рядового Райана', 1998), ('Хроники Нарнии: Лев, Ведьма и волшебный шкаф', 2005)]
2025-06-17 04:39:32,803 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:39:35,010 - recommendation_engine - INFO - Translated Russian title 'Чусовой' to English for TMDB search: 'Chusovoy'
2025-06-17 04:39:35,012 - recommendation_engine - INFO - Searching TMDB for movie: 'Chusovoy' (original: 'Чусовой')
2025-06-17 04:39:35,691 - tmdb_agent - WARNING - Фильм 'Chusovoy' не найден в TMDB.
2025-06-17 04:39:35,692 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Chusovoy' (original: 'Чусовой'). Skipping.
2025-06-17 04:39:35,692 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:39:37,670 - recommendation_engine - INFO - Translated Russian title 'Дом лето' to English for TMDB search: 'Summer house'
2025-06-17 04:39:37,671 - recommendation_engine - INFO - Searching TMDB for movie: 'Summer house' (original: 'Дом лето')
2025-06-17 04:39:38,140 - recommendation_engine - WARNING - Год LLM (2013) не совпал с годом TMDB (2018) для 'The Summer House'. Пропускаем.
2025-06-17 04:39:38,140 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:39:40,058 - recommendation_engine - INFO - Translated Russian title 'Суперволосы' to English for TMDB search: 'Superhairy (or Superhairy)'
2025-06-17 04:39:40,058 - recommendation_engine - INFO - Searching TMDB for movie: 'Superhairy (or Superhairy)' (original: 'Суперволосы')
2025-06-17 04:39:40,325 - tmdb_agent - WARNING - Фильм 'Superhairy (or Superhairy)' не найден в TMDB.
2025-06-17 04:39:40,325 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Superhairy (or Superhairy)' (original: 'Суперволосы'). Skipping.
2025-06-17 04:39:40,326 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:39:41,365 - recommendation_engine - INFO - Translated Russian title 'Спасти рядового Райана' to English for TMDB search: 'Save Private Ryan'
2025-06-17 04:39:41,366 - recommendation_engine - INFO - Searching TMDB for movie: 'Save Private Ryan' (original: 'Спасти рядового Райана')
2025-06-17 04:39:41,609 - tmdb_agent - WARNING - Фильм 'Save Private Ryan' не найден в TMDB.
2025-06-17 04:39:41,609 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Save Private Ryan' (original: 'Спасти рядового Райана'). Skipping.
2025-06-17 04:39:41,609 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:39:43,137 - recommendation_engine - INFO - Translated Russian title 'Хроники Нарнии: Лев, Ведьма и волшебный шкаф' to English for TMDB search: 'Chronicles of Narnia: The Lion, the Witch and the Wardrobe'
2025-06-17 04:39:43,138 - recommendation_engine - INFO - Searching TMDB for movie: 'Chronicles of Narnia: The Lion, the Witch and the Wardrobe' (original: 'Хроники Нарнии: Лев, Ведьма и волшебный шкаф')
2025-06-17 04:39:43,638 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'давай фильм про подростка, который стал особенным'

Детали фильма: Название: T...'
2025-06-17 04:39:44,936 - recommendation_engine - INFO - Validation for 'The Chronicles of Narnia: The Lion, the Witch and the Wardrobe' against 'давай фильм про подростка, который стал особенным...': Relevant
2025-06-17 04:39:44,941 - movie_database - INFO - Фильм 'The Chronicles of Narnia: The Lion, the Witch and the Wardrobe' (TMDB ID: 411) добавлен в базу данных.
2025-06-17 04:39:44,942 - recommendation_engine - INFO - Added movie 'The Chronicles of Narnia: The Lion, the Witch and the Wardrobe' to DB as ID 99
2025-06-17 04:39:44,943 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=99, action_type='recommendation'.
2025-06-17 04:39:44,943 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 99
2025-06-17 04:39:44,943 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"The Chronicles o...'
2025-06-17 04:41:31,204 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй аниме-фильм про подростка'
2025-06-17 04:41:31,205 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:41:32,718 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'посоветуй аниме-фильм про подростка...'
2025-06-17 04:41:32,718 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй аниме-фильм про подростка...'
2025-06-17 04:41:34,671 - recommendation_engine - INFO - LLM candidate response: "Your Name" (2016), "Детектив Конан. Фильм 20: Капсула Таймы" (2019), "Аксель & Себастьян" (2007)
2025-06-17 04:41:34,672 - recommendation_engine - INFO - Extracted initial candidate titles: [('Your Name', 2016), ('Детектив Конан. Фильм 20: Капсула Таймы', 2019), ('Аксель & Себастьян', 2007)]
2025-06-17 04:41:34,672 - recommendation_engine - INFO - Searching TMDB for movie: 'Your Name' (original: 'Your Name')
2025-06-17 04:41:35,185 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'посоветуй аниме-фильм про подростка'

Детали фильма: Название: Your Name.. Ори...'
2025-06-17 04:41:36,289 - recommendation_engine - INFO - Validation for 'Your Name.' against 'посоветуй аниме-фильм про подростка...': Relevant
2025-06-17 04:41:36,290 - recommendation_engine - INFO - Movie 'Your Name.' already in DB as ID 16
2025-06-17 04:41:36,294 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=16, action_type='recommendation'.
2025-06-17 04:41:36,295 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 16
2025-06-17 04:41:36,295 - recommendation_engine - INFO - Searching TMDB for movie: 'Детектив Конан. Фильм 20: Капсула Таймы' (original: 'Детектив Конан. Фильм 20: Капсула Таймы')
2025-06-17 04:41:36,574 - tmdb_agent - WARNING - Фильм 'Детектив Конан. Фильм 20: Капсула Таймы' не найден в TMDB.
2025-06-17 04:41:36,575 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Детектив Конан. Фильм 20: Капсула Таймы' (original: 'Детектив Конан. Фильм 20: Капсула Таймы'). Skipping.
2025-06-17 04:41:36,575 - recommendation_engine - INFO - Searching TMDB for movie: 'Аксель & Себастьян' (original: 'Аксель & Себастьян')
2025-06-17 04:41:36,808 - tmdb_agent - WARNING - Фильм 'Аксель & Себастьян' не найден в TMDB.
2025-06-17 04:41:36,808 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Аксель & Себастьян' (original: 'Аксель & Себастьян'). Skipping.
2025-06-17 04:41:36,808 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"Your Name."** (2...'
2025-06-17 04:42:06,189 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'давай фильм про корейцев которые обманывают семью'
2025-06-17 04:42:06,190 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:42:07,593 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'давай фильм про корейцев которые обманывают семью...'
2025-06-17 04:42:07,594 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'давай фильм про корейцев которые обманывают семью...'
2025-06-17 04:42:09,845 - recommendation_engine - INFO - LLM candidate response: "Одеяло Трилогия" (2010), "Паразиты" (2019), "Мистерзовство: Возвращение" (2014)
2025-06-17 04:42:09,845 - recommendation_engine - INFO - Extracted initial candidate titles: [('Одеяло Трилогия', 2010), ('Паразиты', 2019), ('Мистерзовство: Возвращение', 2014)]
2025-06-17 04:42:09,845 - recommendation_engine - INFO - Searching TMDB for movie: 'Одеяло Трилогия' (original: 'Одеяло Трилогия')
2025-06-17 04:42:10,113 - tmdb_agent - WARNING - Фильм 'Одеяло Трилогия' не найден в TMDB.
2025-06-17 04:42:10,113 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Одеяло Трилогия' (original: 'Одеяло Трилогия'). Skipping.
2025-06-17 04:42:10,113 - recommendation_engine - INFO - Searching TMDB for movie: 'Паразиты' (original: 'Паразиты')
2025-06-17 04:42:10,634 - recommendation_engine - WARNING - Год LLM (2019) не совпал с годом TMDB (2020) для 'Parasites'. Пропускаем.
2025-06-17 04:42:10,635 - recommendation_engine - INFO - Searching TMDB for movie: 'Мистерзовство: Возвращение' (original: 'Мистерзовство: Возвращение')
2025-06-17 04:42:10,874 - tmdb_agent - WARNING - Фильм 'Мистерзовство: Возвращение' не найден в TMDB.
2025-06-17 04:42:10,874 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Мистерзовство: Возвращение' (original: 'Мистерзовство: Возвращение'). Skipping.
2025-06-17 04:42:10,874 - recommendation_engine - INFO - No valid recommendations found after TMDB search and validation.
2025-06-17 04:43:26,057 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'фильм про супергероя который с нуля добился успеха'
2025-06-17 04:43:26,072 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:43:27,810 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'фильм про супергероя который с нуля добился успеха...'
2025-06-17 04:43:29,360 - recommendation_engine - INFO - LLM candidate response: "Человек-паук: Высокое напряжение" (2021), "Человек-паук: Дом Дяди Петя" (2019), "Тор: Рагнарёк" (2017), "Капитан Марвел" (2019), "Бэтмен" (2022).
2025-06-17 04:43:29,361 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук: Высокое напряжение', 2021), ('Человек-паук: Дом Дяди Петя', 2019), ('Тор: Рагнарёк', 2017), ('Капитан Марвел', 2019), ('Бэтмен', 2022)]
2025-06-17 04:43:29,362 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:43:30,236 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Высокое напряжение' to English for TMDB search: 'Spider-Man: High Tension'
2025-06-17 04:43:30,237 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: High Tension' (original: 'Человек-паук: Высокое напряжение')
2025-06-17 04:43:30,564 - tmdb_agent - WARNING - Фильм 'Spider-Man: High Tension' не найден в TMDB.
2025-06-17 04:43:30,565 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: High Tension' (original: 'Человек-паук: Высокое напряжение'). Skipping.
2025-06-17 04:43:30,565 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:43:32,464 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Дом Дяди Петя' to English for TMDB search: 'Spider-Man: Uncle Peter's House'
2025-06-17 04:43:32,465 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: Uncle Peter's House' (original: 'Человек-паук: Дом Дяди Петя')
2025-06-17 04:43:32,755 - tmdb_agent - WARNING - Фильм 'Spider-Man: Uncle Peter's House' не найден в TMDB.
2025-06-17 04:43:32,755 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: Uncle Peter's House' (original: 'Человек-паук: Дом Дяди Петя'). Skipping.
2025-06-17 04:43:32,755 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:43:34,569 - recommendation_engine - INFO - Translated Russian title 'Тор: Рагнарёк' to English for TMDB search: 'Thor: Ragnarok'
2025-06-17 04:43:34,570 - recommendation_engine - INFO - Searching TMDB for movie: 'Thor: Ragnarok' (original: 'Тор: Рагнарёк')
2025-06-17 04:43:35,137 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'фильм про супергероя который с нуля добился успеха'

Детали фильма: Название: ...'
2025-06-17 04:43:36,245 - recommendation_engine - INFO - Validation for 'Thor: Ragnarok' against 'фильм про супергероя который с нуля добился успеха...': Not Relevant
2025-06-17 04:43:36,246 - recommendation_engine - WARNING - Movie 'Thor: Ragnarok' deemed not relevant to original query: 'фильм про супергероя который с нуля добился успеха...'. Skipping.
2025-06-17 04:43:36,246 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:43:37,929 - recommendation_engine - INFO - Translated Russian title 'Капитан Марвел' to English for TMDB search: 'Captain Marvel'
2025-06-17 04:43:37,930 - recommendation_engine - INFO - Searching TMDB for movie: 'Captain Marvel' (original: 'Капитан Марвел')
2025-06-17 04:43:40,333 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'фильм про супергероя который с нуля добился успеха'

Детали фильма: Название: ...'
2025-06-17 04:43:42,454 - recommendation_engine - INFO - Validation for 'Captain Marvel' against 'фильм про супергероя который с нуля добился успеха...': Relevant
2025-06-17 04:43:42,458 - movie_database - INFO - Фильм 'Captain Marvel' (TMDB ID: 299537) добавлен в базу данных.
2025-06-17 04:43:42,458 - recommendation_engine - INFO - Added movie 'Captain Marvel' to DB as ID 100
2025-06-17 04:43:42,460 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=100, action_type='recommendation'.
2025-06-17 04:43:42,460 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 100
2025-06-17 04:43:42,460 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:43:44,765 - recommendation_engine - INFO - Translated Russian title 'Бэтмен' to English for TMDB search: 'Batman'
2025-06-17 04:43:44,767 - recommendation_engine - INFO - Searching TMDB for movie: 'Batman' (original: 'Бэтмен')
2025-06-17 04:43:45,345 - recommendation_engine - WARNING - Год LLM (2022) не совпал с годом TMDB (1989) для 'Batman'. Пропускаем.
2025-06-17 04:43:45,345 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"Captain Marvel"*...'
2025-06-17 04:44:43,087 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'а еще такой фильм?'
2025-06-17 04:44:43,089 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:44:45,660 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'а еще такой фильм?...'
2025-06-17 04:44:47,122 - recommendation_engine - INFO - LLM candidate response: "Ловись!" (2000), "Инception" (2010), "Тайны Клоуна" (2019), "Человек-паук: Дом Дракона" (2021)
2025-06-17 04:44:47,122 - recommendation_engine - INFO - Extracted initial candidate titles: [('Ловись!', 2000), ('Инception', 2010), ('Тайны Клоуна', 2019), ('Человек-паук: Дом Дракона', 2021)]
2025-06-17 04:44:47,122 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:44:48,046 - recommendation_engine - INFO - Translated Russian title 'Ловись!' to English for TMDB search: 'Catch me!'
2025-06-17 04:44:48,047 - recommendation_engine - INFO - Searching TMDB for movie: 'Catch me!' (original: 'Ловись!')
2025-06-17 04:44:48,658 - recommendation_engine - WARNING - Год LLM (2000) не совпал с годом TMDB (1978) для 'What Will You Do When You Catch Me?'. Пропускаем.
2025-06-17 04:44:48,659 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:44:49,480 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 04:44:49,480 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 04:44:49,826 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'а еще такой фильм?'

Детали фильма: Название: Inception. Оригинальное название...'
2025-06-17 04:44:51,632 - recommendation_engine - INFO - Validation for 'Inception' against 'а еще такой фильм?...': Relevant
2025-06-17 04:44:51,638 - movie_database - INFO - Фильм 'Inception' (TMDB ID: 27205) добавлен в базу данных.
2025-06-17 04:44:51,638 - recommendation_engine - INFO - Added movie 'Inception' to DB as ID 101
2025-06-17 04:44:51,639 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=101, action_type='recommendation'.
2025-06-17 04:44:51,639 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 101
2025-06-17 04:44:51,639 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:44:52,877 - recommendation_engine - INFO - Translated Russian title 'Тайны Клоуна' to English for TMDB search: 'The Mysteries of the Clown'
2025-06-17 04:44:52,877 - recommendation_engine - INFO - Searching TMDB for movie: 'The Mysteries of the Clown' (original: 'Тайны Клоуна')
2025-06-17 04:44:53,174 - tmdb_agent - WARNING - Фильм 'The Mysteries of the Clown' не найден в TMDB.
2025-06-17 04:44:53,175 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'The Mysteries of the Clown' (original: 'Тайны Клоуна'). Skipping.
2025-06-17 04:44:53,175 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 04:44:55,173 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Дом Дракона' to English for TMDB search: 'Spider-Man: House of the Dragon'
2025-06-17 04:44:55,175 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: House of the Dragon' (original: 'Человек-паук: Дом Дракона')
2025-06-17 04:44:55,477 - tmdb_agent - WARNING - Фильм 'Spider-Man: House of the Dragon' не найден в TMDB.
2025-06-17 04:44:55,477 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: House of the Dragon' (original: 'Человек-паук: Дом Дракона'). Skipping.
2025-06-17 04:44:55,477 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"Inception"** (20...'
2025-06-17 04:45:22,466 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'давай боевик про роботов'
2025-06-17 04:45:22,466 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 04:45:24,099 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'давай боевик про роботов...'
2025-06-17 04:45:24,100 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'давай боевик про роботов...'
2025-06-17 04:45:26,974 - recommendation_engine - INFO - LLM candidate response: "Терминатор" (1984), "Робокоп" (1987), "Экзилинг" (2004), "Трансформеры" (2007), "Эдисон" (2004)
2025-06-17 04:45:26,976 - recommendation_engine - INFO - Extracted initial candidate titles: [('Терминатор', 1984), ('Робокоп', 1987), ('Экзилинг', 2004), ('Трансформеры', 2007), ('Эдисон', 2004)]
2025-06-17 04:45:26,977 - recommendation_engine - INFO - Searching TMDB for movie: 'Терминатор' (original: 'Терминатор')
2025-06-17 04:45:27,470 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'давай боевик про роботов'

Детали фильма: Название: The Terminator. Оригинальн...'
2025-06-17 04:45:29,166 - recommendation_engine - INFO - Validation for 'The Terminator' against 'давай боевик про роботов...': Relevant
2025-06-17 04:45:29,168 - recommendation_engine - INFO - Movie 'The Terminator' already in DB as ID 97
2025-06-17 04:45:29,171 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=97, action_type='recommendation'.
2025-06-17 04:45:29,172 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 97
2025-06-17 04:45:29,172 - recommendation_engine - INFO - Searching TMDB for movie: 'Робокоп' (original: 'Робокоп')
2025-06-17 04:45:29,783 - recommendation_engine - WARNING - Год LLM (1987) не совпал с годом TMDB (1990) для 'RoboCop 2'. Пропускаем.
2025-06-17 04:45:29,783 - recommendation_engine - INFO - Searching TMDB for movie: 'Экзилинг' (original: 'Экзилинг')
2025-06-17 04:45:30,063 - tmdb_agent - WARNING - Фильм 'Экзилинг' не найден в TMDB.
2025-06-17 04:45:30,063 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Экзилинг' (original: 'Экзилинг'). Skipping.
2025-06-17 04:45:30,064 - recommendation_engine - INFO - Searching TMDB for movie: 'Трансформеры' (original: 'Трансформеры')
2025-06-17 04:45:30,644 - recommendation_engine - WARNING - Год LLM (2007) не совпал с годом TMDB (2023) для 'Transformers: Rise of the Beasts'. Пропускаем.
2025-06-17 04:45:30,645 - recommendation_engine - INFO - Searching TMDB for movie: 'Эдисон' (original: 'Эдисон')
2025-06-17 04:45:31,317 - recommendation_engine - WARNING - Год LLM (2004) не совпал с годом TMDB (1986) для 'Dear Edison!'. Пропускаем.
2025-06-17 04:45:31,318 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Основываясь на ваших прошлых рекомендациях, вот список фильмов, которые я нашел:
**"The Terminator"*...'
2025-06-17 05:21:09,186 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:21:09,186 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:22:27,253 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:22:27,253 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:23:10,205 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:23:10,206 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:23:10,212 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:23:10,212 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:23:10,213 - agents.genre_mapper - ERROR - Error loading genres from database: expected str, bytes or os.PathLike object, not MovieDatabase
2025-06-17 05:23:10,213 - main - ERROR - Ошибка при запуске бота: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 64, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 38, in main
    llm_generator = LLMGenerator()
                    ^^^^^^^^^^^^^^
TypeError: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
2025-06-17 05:24:58,557 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:24:58,560 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:24:58,575 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:24:58,575 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:24:58,575 - agents.genre_mapper - ERROR - Error loading genres from database: expected str, bytes or os.PathLike object, not MovieDatabase
2025-06-17 05:24:58,575 - main - ERROR - Ошибка при запуске бота: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 64, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 38, in main
    llm_generator = LLMGenerator()
                    ^^^^^^^^^^^^^^
TypeError: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
2025-06-17 05:25:47,251 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:25:47,252 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:25:47,258 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:25:47,258 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:25:47,258 - agents.genre_mapper - ERROR - Error loading genres from database: expected str, bytes or os.PathLike object, not MovieDatabase
2025-06-17 05:25:47,258 - main - ERROR - Ошибка при запуске бота: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 64, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 38, in main
    llm_generator = LLMGenerator()
                    ^^^^^^^^^^^^^^
TypeError: LLMGenerator.__init__() missing 1 required positional argument: 'api_key'
2025-06-17 05:34:13,413 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:34:13,414 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:37:29,652 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:37:29,652 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:39:40,503 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:39:40,503 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:39:40,504 - main - INFO - Запуск Telegram-бота...
2025-06-17 05:39:40,504 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:39:40,504 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:39:40,522 - main - INFO - Бот успешно запущен.
2025-06-17 05:39:40,522 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1006, in __run
    raise exc
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 995, in __run
    loop.run_until_complete(self.initialize())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1017, in __run
    loop.run_until_complete(self.shutdown())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 72, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 67, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 05:40:19,370 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:40:19,370 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:40:40,212 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:40:40,213 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:40:40,213 - main - INFO - Запуск Telegram-бота...
2025-06-17 05:40:40,214 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:40:40,214 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:40:40,224 - main - INFO - Бот успешно запущен.
2025-06-17 05:42:54,538 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:42:54,538 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:42:54,542 - main - INFO - Запуск Telegram-бота...
2025-06-17 05:42:54,542 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:42:54,542 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:42:54,566 - main - INFO - Бот успешно запущен.
2025-06-17 05:43:57,650 - handlers - INFO - Запрос от пользователя 577976124: терминатора хочу
2025-06-17 05:43:57,656 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'терминатора хочу'
2025-06-17 05:43:57,659 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:43:57,981 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:43:58,982 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:43:59,139 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:01,144 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:01,358 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:01,359 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:01,359 - agents.translator - WARNING - LLM returned invalid language code: 'Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.' for text 'терминатора хочу...'
2025-06-17 05:44:01,359 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'терминатора хочу...'
2025-06-17 05:44:01,506 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:02,508 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'терминатора хочу...'
2025-06-17 05:44:02,679 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:04,681 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'терминатора хочу...'
2025-06-17 05:44:04,835 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:04,835 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'терминатора хочу...'
2025-06-17 05:44:04,835 - recommendation_engine - INFO - LLM candidate response: Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.
2025-06-17 05:44:04,836 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 05:44:04,836 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 05:44:26,895 - handlers - INFO - Запрос от пользователя 577976124: Давай боевик про роботов
2025-06-17 05:44:26,896 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'Давай боевик про роботов'
2025-06-17 05:44:26,896 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:27,044 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:28,045 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:28,217 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:30,219 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:30,415 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:30,415 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:30,415 - agents.translator - WARNING - LLM returned invalid language code: 'Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.' for text 'Давай боевик про роботов...'
2025-06-17 05:44:30,415 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Давай боевик про роботов...'
2025-06-17 05:44:30,576 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:31,578 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'Давай боевик про роботов...'
2025-06-17 05:44:31,739 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:33,741 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'Давай боевик про роботов...'
2025-06-17 05:44:34,037 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:34,037 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'Давай боевик про роботов...'
2025-06-17 05:44:34,038 - recommendation_engine - INFO - LLM candidate response: Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.
2025-06-17 05:44:34,038 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 05:44:34,038 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 05:44:43,616 - handlers - INFO - Запрос от пользователя 577976124: тачки
2025-06-17 05:44:43,617 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'тачки'
2025-06-17 05:44:43,619 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:43,951 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:44,960 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:45,153 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:47,157 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:47,356 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:47,356 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:44:47,357 - agents.translator - WARNING - LLM returned invalid language code: 'Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.' for text 'тачки...'
2025-06-17 05:44:47,357 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'тачки...'
2025-06-17 05:44:47,516 - agents.llm_generator - ERROR - LLM HTTP error (attempt 1/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:48,520 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 2/3): 'тачки...'
2025-06-17 05:44:48,723 - agents.llm_generator - ERROR - LLM HTTP error (attempt 2/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:50,726 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 3/3): 'тачки...'
2025-06-17 05:44:50,913 - agents.llm_generator - ERROR - LLM HTTP error (attempt 3/3): 401 - {"error":{"message":"No auth credentials found","code":401}}
2025-06-17 05:44:50,913 - agents.llm_generator - ERROR - Failed to generate LLM response after 3 attempts for prompt: 'тачки...'
2025-06-17 05:44:50,913 - recommendation_engine - INFO - LLM candidate response: Извините, произошла ошибка при генерации ответа. Пожалуйста, попробуйте еще раз.
2025-06-17 05:44:50,913 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 05:44:50,913 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 05:46:38,168 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:46:38,169 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:46:38,175 - main - INFO - Запуск Telegram-бота...
2025-06-17 05:46:38,175 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:46:38,175 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:46:38,102 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 75, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 67, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 05:46:38,242 - main - INFO - Бот успешно запущен.
2025-06-17 05:46:42,550 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 75, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 67, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 05:46:43,787 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:46:43,787 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:46:43,787 - main - INFO - Запуск Telegram-бота...
2025-06-17 05:46:43,788 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:46:43,788 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:46:43,797 - main - INFO - Бот успешно запущен.
2025-06-17 05:46:51,438 - handlers - INFO - Запрос от пользователя 577976124: салам
2025-06-17 05:46:51,438 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'салам'
2025-06-17 05:46:51,439 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:46:53,137 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'салам...'
2025-06-17 05:46:53,138 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'салам...'
2025-06-17 05:46:55,821 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "История игрушек 3" (2010), "Дэдпул 2" (2018), "Игра престолов" (2011-2019 - сериал), "Мстители" (2012).
2025-06-17 05:46:55,822 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('История игрушек 3', 2010), ('Дэдпул 2', 2018), ('Мстители', 2012)]
2025-06-17 05:46:55,823 - recommendation_engine - INFO - Searching TMDB for movie: 'Инception' (original: 'Инception')
2025-06-17 05:46:56,251 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 1/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:46:57,668 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 2/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:00,269 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 3/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:00,270 - tmdb_agent - ERROR - Failed to fetch data from https://api.themoviedb.org/3/search/movie after 3 attempts.
2025-06-17 05:47:00,270 - tmdb_agent - WARNING - Фильм 'Инception' не найден в TMDB.
2025-06-17 05:47:00,270 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Инception' (original: 'Инception'). Skipping.
2025-06-17 05:47:00,270 - recommendation_engine - INFO - Searching TMDB for movie: 'История игрушек 3' (original: 'История игрушек 3')
2025-06-17 05:47:00,671 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 1/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:02,034 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 2/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:04,454 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 3/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:04,454 - tmdb_agent - ERROR - Failed to fetch data from https://api.themoviedb.org/3/search/movie after 3 attempts.
2025-06-17 05:47:04,455 - tmdb_agent - WARNING - Фильм 'История игрушек 3' не найден в TMDB.
2025-06-17 05:47:04,455 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'История игрушек 3' (original: 'История игрушек 3'). Skipping.
2025-06-17 05:47:04,455 - recommendation_engine - INFO - Searching TMDB for movie: 'Дэдпул 2' (original: 'Дэдпул 2')
2025-06-17 05:47:04,851 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 1/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:06,369 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 2/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:08,713 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 3/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:08,713 - tmdb_agent - ERROR - Failed to fetch data from https://api.themoviedb.org/3/search/movie after 3 attempts.
2025-06-17 05:47:08,714 - tmdb_agent - WARNING - Фильм 'Дэдпул 2' не найден в TMDB.
2025-06-17 05:47:08,714 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Дэдпул 2' (original: 'Дэдпул 2'). Skipping.
2025-06-17 05:47:08,714 - recommendation_engine - INFO - Searching TMDB for movie: 'Мстители' (original: 'Мстители')
2025-06-17 05:47:09,018 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 1/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:10,293 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 2/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:12,587 - tmdb_agent - ERROR - HTTP error for https://api.themoviedb.org/3/search/movie (attempt 3/3): 401 - {"status_code":7,"status_message":"Invalid API key: You must be granted a valid key.","success":false}

2025-06-17 05:47:12,588 - tmdb_agent - ERROR - Failed to fetch data from https://api.themoviedb.org/3/search/movie after 3 attempts.
2025-06-17 05:47:12,588 - tmdb_agent - WARNING - Фильм 'Мстители' не найден в TMDB.
2025-06-17 05:47:12,588 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Мстители' (original: 'Мстители'). Skipping.
2025-06-17 05:47:12,589 - recommendation_engine - INFO - No valid recommendations found after TMDB search and validation.
2025-06-17 05:50:17,203 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 75, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 67, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 05:57:53,331 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 05:57:53,334 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 05:57:53,334 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 05:57:53,346 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 05:58:02,751 - handlers - INFO - Запрос от пользователя 577976124: привет
2025-06-17 05:58:02,752 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 05:58:02,753 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:58:04,174 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'привет...'
2025-06-17 05:58:04,174 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 05:58:07,175 - recommendation_engine - INFO - LLM candidate response: "Так и нравится, спасибо! Здесь несколько фильмов, которые могут понравиться:

"Интерстэллар 2001 год"
"Властелин Колец: Братство Кольца" (2001)
"Индиана Джонс: Хранитель аркеи" (1984)
"Бэтмен: Начало" (2016)
"Гарри Поттер и философский камень" (2001)"
2025-06-17 05:58:07,177 - recommendation_engine - INFO - Extracted initial candidate titles: [('Властелин Колец: Братство Кольца', 2001), ('Индиана Джонс: Хранитель аркеи', 1984), ('Бэтмен: Начало', 2016), ('Гарри Поттер и философский камень', 2001)]
2025-06-17 05:58:07,177 - recommendation_engine - INFO - Searching TMDB for movie: 'Властелин Колец: Братство Кольца' (original: 'Властелин Колец: Братство Кольца')
2025-06-17 05:58:07,801 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'привет'

Детали фильма: Название: The Lord of the Rings: The Fellowship of the...'
2025-06-17 05:58:08,951 - recommendation_engine - INFO - Validation for 'The Lord of the Rings: The Fellowship of the Ring' against 'привет...': Not Relevant
2025-06-17 05:58:08,953 - recommendation_engine - WARNING - Movie 'The Lord of the Rings: The Fellowship of the Ring' deemed not relevant to original query: 'привет...'. Skipping.
2025-06-17 05:58:08,953 - recommendation_engine - INFO - Searching TMDB for movie: 'Индиана Джонс: Хранитель аркеи' (original: 'Индиана Джонс: Хранитель аркеи')
2025-06-17 05:58:09,259 - tmdb_agent - WARNING - Фильм 'Индиана Джонс: Хранитель аркеи' не найден в TMDB.
2025-06-17 05:58:09,260 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Индиана Джонс: Хранитель аркеи' (original: 'Индиана Джонс: Хранитель аркеи'). Skipping.
2025-06-17 05:58:09,260 - recommendation_engine - INFO - Searching TMDB for movie: 'Бэтмен: Начало' (original: 'Бэтмен: Начало')
2025-06-17 05:58:09,833 - recommendation_engine - WARNING - Год LLM (2016) не совпал с годом TMDB (2005) для 'Batman Begins'. Пропускаем.
2025-06-17 05:58:09,834 - recommendation_engine - INFO - Searching TMDB for movie: 'Гарри Поттер и философский камень' (original: 'Гарри Поттер и философский камень')
2025-06-17 05:58:10,406 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Запрос пользователя: 'привет'

Детали фильма: Название: Harry Potter and the Philosopher's Stone. Ор...'
2025-06-17 05:58:11,281 - recommendation_engine - INFO - Validation for 'Harry Potter and the Philosopher's Stone' against 'привет...': Not Relevant
2025-06-17 05:58:11,282 - recommendation_engine - WARNING - Movie 'Harry Potter and the Philosopher's Stone' deemed not relevant to original query: 'привет...'. Skipping.
2025-06-17 05:58:11,282 - recommendation_engine - INFO - No valid recommendations found after TMDB search and validation.
2025-06-17 05:58:44,481 - handlers - INFO - Запрос от пользователя 577976124: фильмы про тачки
2025-06-17 05:58:44,483 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'фильмы про тачки'
2025-06-17 05:58:44,483 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:58:45,774 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'фильмы про тачки...'
2025-06-17 05:58:45,774 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'фильмы про тачки...'
2025-06-17 05:58:47,132 - recommendation_engine - INFO - LLM candidate response: "Гоночный" (2006), "Тачки 2" (2011), "Тачки 3" (2014), "Тачки: Великое гонки-шоу" (2015), "Тачки: Карди-карао" (2017)
2025-06-17 05:58:47,159 - recommendation_engine - INFO - Extracted initial candidate titles: [('Гоночный', 2006), ('Тачки 2', 2011), ('Тачки 3', 2014), ('Тачки: Великое гонки-шоу', 2015), ('Тачки: Карди-карао', 2017)]
2025-06-17 05:58:47,159 - recommendation_engine - INFO - Searching TMDB for movie: 'Гоночный' (original: 'Гоночный')
2025-06-17 05:58:47,453 - tmdb_agent - WARNING - Фильм 'Гоночный' не найден в TMDB.
2025-06-17 05:58:47,453 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Гоночный' (original: 'Гоночный'). Skipping.
2025-06-17 05:58:47,453 - recommendation_engine - INFO - Searching TMDB for movie: 'Тачки 2' (original: 'Тачки 2')
2025-06-17 05:58:48,051 - recommendation_engine - WARNING - Год LLM (2011) не совпал с годом TMDB (2013) для 'Hiccups'. Пропускаем.
2025-06-17 05:58:48,051 - recommendation_engine - INFO - Searching TMDB for movie: 'Тачки 3' (original: 'Тачки 3')
2025-06-17 05:58:48,627 - recommendation_engine - WARNING - Год LLM (2014) не совпал с годом TMDB (2017) для 'Cars 3'. Пропускаем.
2025-06-17 05:58:48,628 - recommendation_engine - INFO - Searching TMDB for movie: 'Тачки: Великое гонки-шоу' (original: 'Тачки: Великое гонки-шоу')
2025-06-17 05:58:48,922 - tmdb_agent - WARNING - Фильм 'Тачки: Великое гонки-шоу' не найден в TMDB.
2025-06-17 05:58:48,922 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Тачки: Великое гонки-шоу' (original: 'Тачки: Великое гонки-шоу'). Skipping.
2025-06-17 05:58:48,922 - recommendation_engine - INFO - Searching TMDB for movie: 'Тачки: Карди-карао' (original: 'Тачки: Карди-карао')
2025-06-17 05:58:49,224 - tmdb_agent - WARNING - Фильм 'Тачки: Карди-карао' не найден в TMDB.
2025-06-17 05:58:49,224 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Тачки: Карди-карао' (original: 'Тачки: Карди-карао'). Skipping.
2025-06-17 05:58:49,224 - recommendation_engine - INFO - No valid recommendations found after TMDB search and validation.
2025-06-17 05:59:10,406 - handlers - INFO - Запрос от пользователя 577976124: россомаха
2025-06-17 05:59:10,407 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'россомаха'
2025-06-17 05:59:10,407 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 05:59:11,822 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'россомаха...'
2025-06-17 05:59:13,309 - recommendation_engine - INFO - LLM candidate response: Интерstellar (2014), Шпионский детство (2015), Заложники (2016), Тор: Рагнарёк (2017), Гравити (2013)
2025-06-17 05:59:13,311 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 05:59:13,311 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 06:03:59,902 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:04:07,270 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:04:07,271 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:04:07,271 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:04:07,355 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:04:13,841 - handlers - INFO - Запрос от пользователя 577976124: человек-паук
2025-06-17 06:04:13,842 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'человек-паук'
2025-06-17 06:04:13,843 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:04:15,147 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'человек-паук...'
2025-06-17 06:04:15,148 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'человек-паук...'
2025-06-17 06:04:17,969 - recommendation_engine - INFO - LLM candidate response: Человек-паук (2002), Человек-паук 2 (2004), Человек-паук 3 (2007), Человек-паук: Возвращение домой (2017), Человек-паук: Далеко от дома (2019).
2025-06-17 06:04:17,971 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 06:04:17,971 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 06:06:03,458 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:14:05,055 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:14:05,059 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:14:05,059 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:14:05,087 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:14:14,886 - handlers - INFO - Запрос от пользователя 577976124: привет
2025-06-17 06:14:14,887 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 06:14:14,888 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:14:16,690 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 06:14:19,479 - recommendation_engine - INFO - LLM candidate response: "Годра» (1984), "Титанic" (1997), "Инцеп션" (2010), "Звёздные войны: Пробуждение силы" (2015), "Мстители: Война бесконечности" (2018)
2025-06-17 06:14:19,481 - recommendation_engine - INFO - Extracted initial candidate titles: [('Титанic', 1997), ('Инцеп션', 2010), ('Звёздные войны: Пробуждение силы', 2015), ('Мстители: Война бесконечности', 2018)]
2025-06-17 06:14:19,481 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:20,296 - recommendation_engine - INFO - Translated Russian title 'Титанic' to English for TMDB search: 'Titanic'
2025-06-17 06:14:20,296 - recommendation_engine - INFO - Searching TMDB for movie: 'Titanic' (original: 'Титанic')
2025-06-17 06:14:20,972 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:22,650 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:14:24,064 - recommendation_engine - INFO - Fuzzy match found (LLM vs Translated Original TMDB) for 'Titanic'. Ratio: 0.71
2025-06-17 06:14:24,070 - movie_database - INFO - Фильм 'Titanic' (TMDB ID: 597) добавлен в базу данных.
2025-06-17 06:14:24,070 - recommendation_engine - INFO - Added movie 'Titanic' to DB as ID 102
2025-06-17 06:14:24,072 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=102, action_type='recommendation'.
2025-06-17 06:14:24,072 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 102
2025-06-17 06:14:24,072 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:25,611 - recommendation_engine - INFO - Translated Russian title 'Инцеп션' to English for TMDB search: 'Inception'
2025-06-17 06:14:25,612 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инцеп션')
2025-06-17 06:14:26,085 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:29,063 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:14:34,211 - recommendation_engine - INFO - No sufficient fuzzy match for 'Inception'. Comparisons: LLM_vs_TMDB_Localized ('инцеп션' vs 'inception'): 0.00; LLM_vs_TMDB_Original_Translated ('инцеп션' vs 'крестовый поход note inception in english is a title of a movie but in russian the translation provided is крестовый поход which means crusade or crusaders march the original title of the movie in russian would be инцепция inception however if you are asking for a thematic translation крестовый поход could be used as it conveys the idea of a journey or quest similar to the movies plot'): 0.03
2025-06-17 06:14:34,211 - recommendation_engine - WARNING - Movie 'Inception' deemed not relevant to original query: 'привет...' or LLM suggestion. Skipping.
2025-06-17 06:14:34,212 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:35,062 - recommendation_engine - INFO - Translated Russian title 'Звёздные войны: Пробуждение силы' to English for TMDB search: 'Star Wars: The Force Awakens'
2025-06-17 06:14:35,063 - recommendation_engine - INFO - Searching TMDB for movie: 'Star Wars: The Force Awakens' (original: 'Звёздные войны: Пробуждение силы')
2025-06-17 06:14:35,690 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:39,328 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:14:41,241 - recommendation_engine - INFO - No sufficient fuzzy match for 'Star Wars: The Force Awakens'. Comparisons: LLM_vs_TMDB_Localized ('звёздные войны пробуждение силы' vs 'star wars the force awakens'): 0.10; LLM_vs_TMDB_Original_Translated ('звёздные войны пробуждение силы' vs 'звёздные войны пробуждение силы star wars the force awakens note if you need to translate the title as it appears in a specific context like a movie title or book title its important to maintain the exact title as provided including any capitalization and punctuation to ensure accuracy however in general conversation or casual settings the title can be translated as звёздные войны возрождение силы'): 0.14
2025-06-17 06:14:41,242 - recommendation_engine - WARNING - Movie 'Star Wars: The Force Awakens' deemed not relevant to original query: 'привет...' or LLM suggestion. Skipping.
2025-06-17 06:14:41,243 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:43,009 - recommendation_engine - INFO - Translated Russian title 'Мстители: Война бесконечности' to English for TMDB search: 'Avengers: Infinity War'
2025-06-17 06:14:43,009 - recommendation_engine - INFO - Searching TMDB for movie: 'Avengers: Infinity War' (original: 'Мстители: Война бесконечности')
2025-06-17 06:14:43,742 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:14:45,977 - recommendation_engine - INFO - No sufficient fuzzy match for 'Avengers: Infinity War'. Comparisons: LLM_vs_TMDB_Localized ('мстители война бесконечности' vs 'avengers infinity war'): 0.08
2025-06-17 06:14:45,979 - recommendation_engine - WARNING - Movie 'Avengers: Infinity War' deemed not relevant to original query: 'привет...' or LLM suggestion. Skipping.
2025-06-17 06:14:45,979 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Titanic"** (1997).Напиши короткий, дружелюбный те...'
2025-06-17 06:15:17,919 - handlers - INFO - Запрос от пользователя 577976124: хочу боевик про роботов
2025-06-17 06:15:17,921 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'хочу боевик про роботов'
2025-06-17 06:15:17,921 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:15:19,219 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'хочу боевик про роботов...'
2025-06-17 06:15:19,219 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'хочу боевик про роботов...'
2025-06-17 06:15:23,244 - recommendation_engine - INFO - LLM candidate response: "Терминатор" (1984), "Робокоп" (1987), "Искусственный разум" (2004), "Экстеминстер 2: Последний рыцарь" (2003), "Бегущий по лезвию 2049" (2017)
2025-06-17 06:15:23,244 - recommendation_engine - INFO - Extracted initial candidate titles: [('Терминатор', 1984), ('Робокоп', 1987), ('Искусственный разум', 2004), ('Экстеминстер 2: Последний рыцарь', 2003), ('Бегущий по лезвию 2049', 2017)]
2025-06-17 06:15:23,244 - recommendation_engine - INFO - Searching TMDB for movie: 'Терминатор' (original: 'Терминатор')
2025-06-17 06:15:23,658 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:15:24,806 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:15:26,368 - recommendation_engine - INFO - Fuzzy match found (LLM vs Translated Original TMDB) for 'The Terminator'. Ratio: 1.00
2025-06-17 06:15:26,369 - recommendation_engine - INFO - Movie 'The Terminator' already in DB as ID 97
2025-06-17 06:15:26,373 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=97, action_type='recommendation'.
2025-06-17 06:15:26,373 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 97
2025-06-17 06:15:26,373 - recommendation_engine - INFO - Searching TMDB for movie: 'Робокоп' (original: 'Робокоп')
2025-06-17 06:15:26,861 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:15:28,594 - recommendation_engine - INFO - No sufficient fuzzy match for 'RoboCop 2'. Comparisons: LLM_vs_TMDB_Localized ('робокоп' vs 'robocop 2'): 0.00; User_vs_TMDB_Localized ('хочу боевик про роботов' vs 'robocop 2'): 0.06; User_vs_TMDB_Original ('хочу боевик про роботов' vs 'robocop 2'): 0.06
2025-06-17 06:15:28,595 - recommendation_engine - WARNING - Movie 'RoboCop 2' deemed not relevant to original query: 'хочу боевик про роботов...' or LLM suggestion. Skipping.
2025-06-17 06:15:28,595 - recommendation_engine - INFO - Searching TMDB for movie: 'Искусственный разум' (original: 'Искусственный разум')
2025-06-17 06:15:29,198 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:15:30,382 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:15:32,344 - recommendation_engine - INFO - No sufficient fuzzy match for 'EVA'. Comparisons: LLM_vs_TMDB_Localized ('искусственный разум' vs 'eva'): 0.00; LLM_vs_TMDB_Original_Translated ('искусственный разум' vs 'эва evа'): 0.23; User_vs_TMDB_Localized ('хочу боевик про роботов' vs 'eva'): 0.00; User_vs_TMDB_Original ('хочу боевик про роботов' vs 'eva'): 0.00; User_vs_TMDB_Original_Translated ('хочу боевик про роботов' vs 'эва evа'): 0.07
2025-06-17 06:15:32,344 - recommendation_engine - WARNING - Movie 'EVA' deemed not relevant to original query: 'хочу боевик про роботов...' or LLM suggestion. Skipping.
2025-06-17 06:15:32,345 - recommendation_engine - INFO - Searching TMDB for movie: 'Экстеминстер 2: Последний рыцарь' (original: 'Экстеминстер 2: Последний рыцарь')
2025-06-17 06:15:32,632 - tmdb_agent - WARNING - Фильм 'Экстеминстер 2: Последний рыцарь' не найден в TMDB.
2025-06-17 06:15:32,633 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Экстеминстер 2: Последний рыцарь' (original: 'Экстеминстер 2: Последний рыцарь'). Skipping.
2025-06-17 06:15:32,633 - recommendation_engine - INFO - Searching TMDB for movie: 'Бегущий по лезвию 2049' (original: 'Бегущий по лезвию 2049')
2025-06-17 06:15:33,336 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:15:34,768 - recommendation_engine - INFO - No sufficient fuzzy match for 'Blade Runner 2049'. Comparisons: LLM_vs_TMDB_Localized ('бегущий по лезвию 2049' vs 'blade runner 2049'): 0.31; User_vs_TMDB_Localized ('хочу боевик про роботов' vs 'blade runner 2049'): 0.10; User_vs_TMDB_Original ('хочу боевик про роботов' vs 'blade runner 2049'): 0.10
2025-06-17 06:15:34,771 - recommendation_engine - WARNING - Movie 'Blade Runner 2049' deemed not relevant to original query: 'хочу боевик про роботов...' or LLM suggestion. Skipping.
2025-06-17 06:15:34,772 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"The Terminator"** (1984).Напиши короткий, дружелю...'
2025-06-17 06:16:12,636 - handlers - INFO - Запрос от пользователя 577976124: давай про супергероя который начал все сначала
2025-06-17 06:16:12,643 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'давай про супергероя который начал все сначала'
2025-06-17 06:16:12,646 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:16:13,573 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'давай про супергероя который начал все сначала...'
2025-06-17 06:16:15,937 - recommendation_engine - INFO - LLM candidate response: "Супермен" (1978), "Бэтмен" (1989), "Человек-паук" (2002), "Иron Man" (2008), "Человек-муравей" (2015)
2025-06-17 06:16:15,938 - recommendation_engine - INFO - Extracted initial candidate titles: [('Супермен', 1978), ('Бэтмен', 1989), ('Человек-паук', 2002), ('Иron Man', 2008), ('Человек-муравей', 2015)]
2025-06-17 06:16:15,938 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:17,110 - recommendation_engine - INFO - Translated Russian title 'Супермен' to English for TMDB search: 'Superman'
2025-06-17 06:16:17,111 - recommendation_engine - INFO - Searching TMDB for movie: 'Superman' (original: 'Супермен')
2025-06-17 06:16:17,712 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:19,396 - recommendation_engine - INFO - No sufficient fuzzy match for 'Superman'. Comparisons: LLM_vs_TMDB_Localized ('супермен' vs 'superman'): 0.00; User_vs_TMDB_Localized ('давай про супергероя который начал все сначала' vs 'superman'): 0.00; User_vs_TMDB_Original ('давай про супергероя который начал все сначала' vs 'superman'): 0.00
2025-06-17 06:16:19,397 - recommendation_engine - WARNING - Movie 'Superman' deemed not relevant to original query: 'давай про супергероя который начал все сначала...' or LLM suggestion. Skipping.
2025-06-17 06:16:19,398 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:21,277 - recommendation_engine - INFO - Translated Russian title 'Бэтмен' to English for TMDB search: 'Batman'
2025-06-17 06:16:21,278 - recommendation_engine - INFO - Searching TMDB for movie: 'Batman' (original: 'Бэтмен')
2025-06-17 06:16:21,754 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:23,520 - recommendation_engine - INFO - No sufficient fuzzy match for 'Batman'. Comparisons: LLM_vs_TMDB_Localized ('бэтмен' vs 'batman'): 0.00; User_vs_TMDB_Localized ('давай про супергероя который начал все сначала' vs 'batman'): 0.00; User_vs_TMDB_Original ('давай про супергероя который начал все сначала' vs 'batman'): 0.00
2025-06-17 06:16:23,521 - recommendation_engine - WARNING - Movie 'Batman' deemed not relevant to original query: 'давай про супергероя который начал все сначала...' or LLM suggestion. Skipping.
2025-06-17 06:16:23,521 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:24,325 - recommendation_engine - INFO - Translated Russian title 'Человек-паук' to English for TMDB search: 'Spider-Man'
2025-06-17 06:16:24,326 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man' (original: 'Человек-паук')
2025-06-17 06:16:24,976 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:26,416 - recommendation_engine - INFO - No sufficient fuzzy match for 'Spider-Man'. Comparisons: LLM_vs_TMDB_Localized ('человекпаук' vs 'spiderman'): 0.00; User_vs_TMDB_Localized ('давай про супергероя который начал все сначала' vs 'spiderman'): 0.00; User_vs_TMDB_Original ('давай про супергероя который начал все сначала' vs 'spiderman'): 0.00
2025-06-17 06:16:26,417 - recommendation_engine - WARNING - Movie 'Spider-Man' deemed not relevant to original query: 'давай про супергероя который начал все сначала...' or LLM suggestion. Skipping.
2025-06-17 06:16:26,417 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:28,566 - recommendation_engine - INFO - Translated Russian title 'Иron Man' to English for TMDB search: 'Iron Man'
2025-06-17 06:16:28,566 - recommendation_engine - INFO - Searching TMDB for movie: 'Iron Man' (original: 'Иron Man')
2025-06-17 06:16:29,968 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:31,650 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Iron Man'. Ratio: 0.88
2025-06-17 06:16:31,655 - movie_database - INFO - Фильм 'Iron Man' (TMDB ID: 1726) добавлен в базу данных.
2025-06-17 06:16:31,655 - recommendation_engine - INFO - Added movie 'Iron Man' to DB as ID 103
2025-06-17 06:16:31,656 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=103, action_type='recommendation'.
2025-06-17 06:16:31,656 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 103
2025-06-17 06:16:31,657 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:33,514 - recommendation_engine - INFO - Translated Russian title 'Человек-муравей' to English for TMDB search: 'Ant-man'
2025-06-17 06:16:33,515 - recommendation_engine - INFO - Searching TMDB for movie: 'Ant-man' (original: 'Человек-муравей')
2025-06-17 06:16:34,087 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:16:35,398 - recommendation_engine - INFO - No sufficient fuzzy match for 'Ant-Man'. Comparisons: LLM_vs_TMDB_Localized ('человекмуравей' vs 'antman'): 0.00; User_vs_TMDB_Localized ('давай про супергероя который начал все сначала' vs 'antman'): 0.00; User_vs_TMDB_Original ('давай про супергероя который начал все сначала' vs 'antman'): 0.00
2025-06-17 06:16:35,399 - recommendation_engine - WARNING - Movie 'Ant-Man' deemed not relevant to original query: 'давай про супергероя который начал все сначала...' or LLM suggestion. Skipping.
2025-06-17 06:16:35,399 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Iron Man"** (2008).Напиши короткий, дружелюбный т...'
2025-06-17 06:23:57,212 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:23:57,214 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:23:57,215 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:23:57,226 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:24:21,770 - handlers - INFO - Запрос от пользователя 577976124: про брата хочц
2025-06-17 06:24:21,774 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'про брата хочц'
2025-06-17 06:24:21,776 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:24:23,112 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'про брата хочц...'
2025-06-17 06:24:23,112 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'про брата хочц...'
2025-06-17 06:24:25,774 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "Формат" (2014), "Доктор Стрэндж" (2016), "Война миров" (2015), "Искатель гармонии" (2018)
2025-06-17 06:24:25,776 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Формат', 2014), ('Доктор Стрэндж', 2016), ('Война миров', 2015), ('Искатель гармонии', 2018)]
2025-06-17 06:24:25,776 - recommendation_engine - INFO - Searching TMDB for movie: 'Инception' (original: 'Инception')
2025-06-17 06:24:26,249 - tmdb_agent - WARNING - Фильм 'Инception' не найден в TMDB.
2025-06-17 06:24:26,250 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Инception' (original: 'Инception'). Skipping.
2025-06-17 06:24:26,250 - recommendation_engine - INFO - Searching TMDB for movie: 'Формат' (original: 'Формат')
2025-06-17 06:24:26,944 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:24:28,060 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:24:29,878 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Формат бабочки'. Ratio: 0.60
2025-06-17 06:24:29,883 - movie_database - INFO - Фильм 'Формат бабочки' (TMDB ID: 617593) добавлен в базу данных.
2025-06-17 06:24:29,884 - recommendation_engine - INFO - Added movie 'Формат бабочки' to DB as ID 104
2025-06-17 06:24:29,886 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=104, action_type='recommendation'.
2025-06-17 06:24:29,886 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 104
2025-06-17 06:24:29,886 - recommendation_engine - INFO - Searching TMDB for movie: 'Доктор Стрэндж' (original: 'Доктор Стрэндж')
2025-06-17 06:24:30,479 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:24:32,137 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:24:34,020 - recommendation_engine - INFO - Fuzzy match found (LLM vs Translated Original TMDB) for 'Dr. Strange'. Ratio: 1.00
2025-06-17 06:24:34,024 - movie_database - INFO - Фильм 'Dr. Strange' (TMDB ID: 50468) добавлен в базу данных.
2025-06-17 06:24:34,025 - recommendation_engine - INFO - Added movie 'Dr. Strange' to DB as ID 105
2025-06-17 06:24:34,027 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=105, action_type='recommendation'.
2025-06-17 06:24:34,027 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 105
2025-06-17 06:24:34,027 - recommendation_engine - INFO - Searching TMDB for movie: 'Война миров' (original: 'Война миров')
2025-06-17 06:24:34,607 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:24:36,263 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:24:37,467 - recommendation_engine - INFO - No sufficient fuzzy match for 'Bacteria. War of the Worlds'. Comparisons: LLM_vs_TMDB_Localized ('война миров' vs 'bacteria war of the worlds'): 0.05; LLM_vs_TMDB_Original_Translated ('война миров' vs 'бактерии мировая война translation bacteria world war'): 0.19; User_vs_TMDB_Localized ('про брата хочц' vs 'bacteria war of the worlds'): 0.10; User_vs_TMDB_Original ('про брата хочц' vs 'бактерии война миров'): 0.12; User_vs_TMDB_Original_Translated ('про брата хочц' vs 'бактерии мировая война translation bacteria world war'): 0.15
2025-06-17 06:24:37,467 - recommendation_engine - WARNING - Movie 'Bacteria. War of the Worlds' deemed not relevant to original query: 'про брата хочц...' or LLM suggestion. Skipping.
2025-06-17 06:24:37,468 - recommendation_engine - INFO - Searching TMDB for movie: 'Искатель гармонии' (original: 'Искатель гармонии')
2025-06-17 06:24:37,795 - tmdb_agent - WARNING - Фильм 'Искатель гармонии' не найден в TMDB.
2025-06-17 06:24:37,796 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Искатель гармонии' (original: 'Искатель гармонии'). Skipping.
2025-06-17 06:24:37,796 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Формат бабочки"** (2019), **"Dr. Strange"** (1978...'
2025-06-17 06:25:08,659 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:25:21,321 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:25:24,748 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:25:24,751 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:25:24,751 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:25:24,779 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:25:32,699 - handlers - INFO - Запрос от пользователя 577976124: про брата хочу
2025-06-17 06:25:32,699 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'про брата хочу'
2025-06-17 06:25:32,700 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:25:33,943 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'про брата хочу...'
2025-06-17 06:25:33,944 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'про брата хочу...'
2025-06-17 06:25:36,530 - recommendation_engine - INFO - LLM candidate response: "Господин Никто" (1995), "Леон" (1994), "Король Лев" (1994), "Криминальное чтиво" (1990), "Брат 2" (2000)
2025-06-17 06:25:36,533 - recommendation_engine - INFO - Extracted initial candidate titles: [('Леон', 1994), ('Брат 2', 2000), ('Король Лев', 1994), ('Господин Никто', 1995), ('Криминальное чтиво', 1990)]
2025-06-17 06:25:36,534 - recommendation_engine - INFO - Searching TMDB for movie: 'Леон' (original: 'Леон')
2025-06-17 06:25:37,240 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:25:39,545 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:26:26,465 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:26:26,466 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:26:26,466 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:26:26,482 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:26:32,554 - handlers - INFO - Запрос от пользователя 577976124: про брата хочу
2025-06-17 06:26:32,555 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'про брата хочу'
2025-06-17 06:26:32,556 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:26:33,963 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'про брата хочу...'
2025-06-17 06:26:33,963 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'про брата хочу...'
2025-06-17 06:26:35,156 - recommendation_engine - INFO - LLM candidate response: "Интерстеллар" (2014), "Война миров: Начало" (2005), "Война миров: Заключение" (2007), "Прямой эфир" (2013)
2025-06-17 06:26:35,157 - recommendation_engine - INFO - Extracted initial candidate titles: [('Прямой эфир', 2013), ('Интерстеллар', 2014), ('Война миров: Начало', 2005), ('Война миров: Заключение', 2007)]
2025-06-17 06:26:35,157 - recommendation_engine - INFO - Searching TMDB for movie: 'Прямой эфир' (original: 'Прямой эфир')
2025-06-17 06:26:35,724 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:26:37,121 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 06:26:39,827 - recommendation_engine - INFO - Exact normalized match for 'Прямой эфир'
2025-06-17 06:26:39,855 - movie_database - INFO - Фильм 'Live' (TMDB ID: 808960) добавлен в базу данных.
2025-06-17 06:26:39,855 - recommendation_engine - INFO - Added movie 'Live' to DB as ID 106
2025-06-17 06:26:39,859 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=106, action_type='recommendation'.
2025-06-17 06:26:39,859 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 106
2025-06-17 06:26:39,859 - recommendation_engine - INFO - Searching TMDB for movie: 'Интерстеллар' (original: 'Интерстеллар')
2025-06-17 06:26:40,382 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:26:41,539 - recommendation_engine - INFO - No sufficient fuzzy match for 'Interstellar'. Comparisons: LLM_vs_TMDB_Localized ('интерстеллар' vs 'interstellar'): 0.00
2025-06-17 06:26:41,540 - recommendation_engine - WARNING - Movie 'Interstellar' deemed not relevant to original query: 'про брата хочу...' or LLM suggestion. Skipping.
2025-06-17 06:26:41,540 - recommendation_engine - INFO - Searching TMDB for movie: 'Война миров: Начало' (original: 'Война миров: Начало')
2025-06-17 06:26:41,854 - tmdb_agent - WARNING - Фильм 'Война миров: Начало' не найден в TMDB.
2025-06-17 06:26:41,855 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Война миров: Начало' (original: 'Война миров: Начало'). Skipping.
2025-06-17 06:26:41,855 - recommendation_engine - INFO - Searching TMDB for movie: 'Война миров: Заключение' (original: 'Война миров: Заключение')
2025-06-17 06:26:42,143 - tmdb_agent - WARNING - Фильм 'Война миров: Заключение' не найден в TMDB.
2025-06-17 06:26:42,144 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Война миров: Заключение' (original: 'Война миров: Заключение'). Skipping.
2025-06-17 06:26:42,144 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Live"** (2023).Напиши короткий, дружелюбный текст...'
2025-06-17 06:27:51,159 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:28:30,880 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:28:30,890 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:28:30,890 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:28:30,905 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:28:37,040 - handlers - INFO - Запрос от пользователя 577976124: про брата хочу
2025-06-17 06:28:37,041 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'про брата хочу'
2025-06-17 06:28:37,042 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:28:38,709 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'про брата хочу...'
2025-06-17 06:28:38,710 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'про брата хочу...'
2025-06-17 06:28:40,443 - recommendation_engine - INFO - LLM candidate response: "Годни зло" (2019), "Вершина" (2017), "Сильмариллион: Властелин колец. Две башни" (2022), "Король леонид" (1994), "Леон" (1994).
2025-06-17 06:28:40,445 - recommendation_engine - INFO - Extracted initial candidate titles: [('Леон', 1994), ('Вершина', 2017), ('Годни зло', 2019), ('Король леонид', 1994), ('Сильмариллион: Властелин колец. Две башни', 2022)]
2025-06-17 06:28:40,445 - recommendation_engine - INFO - Searching TMDB for movie: 'Леон' (original: 'Леон')
2025-06-17 06:28:40,845 - movie_database - INFO - Фильм 'Myth About Leonid' (TMDB ID: 435356) добавлен в базу данных.
2025-06-17 06:28:40,845 - recommendation_engine - INFO - Added movie 'Myth About Leonid' to DB as ID 107
2025-06-17 06:28:40,846 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=107, action_type='recommendation'.
2025-06-17 06:28:40,846 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 107
2025-06-17 06:28:40,846 - recommendation_engine - INFO - Searching TMDB for movie: 'Вершина' (original: 'Вершина')
2025-06-17 06:28:41,404 - movie_database - INFO - Фильм 'Unconquerable Summit' (TMDB ID: 1135040) добавлен в базу данных.
2025-06-17 06:28:41,404 - recommendation_engine - INFO - Added movie 'Unconquerable Summit' to DB as ID 108
2025-06-17 06:28:41,404 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=108, action_type='recommendation'.
2025-06-17 06:28:41,404 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 108
2025-06-17 06:28:41,404 - recommendation_engine - INFO - Searching TMDB for movie: 'Годни зло' (original: 'Годни зло')
2025-06-17 06:28:41,710 - tmdb_agent - WARNING - Фильм 'Годни зло' не найден в TMDB.
2025-06-17 06:28:41,711 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Годни зло' (original: 'Годни зло'). Skipping.
2025-06-17 06:28:41,711 - recommendation_engine - INFO - Searching TMDB for movie: 'Король леонид' (original: 'Король леонид')
2025-06-17 06:28:42,010 - tmdb_agent - WARNING - Фильм 'Король леонид' не найден в TMDB.
2025-06-17 06:28:42,010 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Король леонид' (original: 'Король леонид'). Skipping.
2025-06-17 06:28:42,010 - recommendation_engine - INFO - Searching TMDB for movie: 'Сильмариллион: Властелин колец. Две башни' (original: 'Сильмариллион: Властелин колец. Две башни')
2025-06-17 06:28:42,297 - tmdb_agent - WARNING - Фильм 'Сильмариллион: Властелин колец. Две башни' не найден в TMDB.
2025-06-17 06:28:42,298 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Сильмариллион: Властелин колец. Две башни' (original: 'Сильмариллион: Властелин колец. Две башни'). Skipping.
2025-06-17 06:28:42,298 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Myth About Leonid"** (1991), **"Unconquerable Sum...'
2025-06-17 06:33:07,554 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:33:07,555 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:33:07,555 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:33:07,570 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:33:13,664 - handlers - INFO - Запрос от пользователя 577976124: про брата хочу
2025-06-17 06:33:13,665 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'про брата хочу'
2025-06-17 06:33:13,666 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:33:15,022 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'про брата хочу...'
2025-06-17 06:33:15,022 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'про брата хочу...'
2025-06-17 06:33:17,337 - recommendation_engine - INFO - LLM candidate response: "Годра" (1980), "Брат 2" (2000), "Брат 3" (2004), "Брат 4" (2014), "Брат 5" (2021)
2025-06-17 06:33:17,338 - recommendation_engine - INFO - Extracted initial candidate titles: [('Годра', 1980), ('Брат 3', 2004), ('Брат 4', 2014), ('Брат 2', 2000), ('Брат 5', 2021)]
2025-06-17 06:33:17,338 - recommendation_engine - INFO - Searching TMDB for movie: 'Годра' (original: 'Годра')
2025-06-17 06:33:17,651 - tmdb_agent - WARNING - Фильм 'Годра' не найден в TMDB.
2025-06-17 06:33:17,651 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Годра' (original: 'Годра'). Skipping.
2025-06-17 06:33:17,651 - recommendation_engine - INFO - Searching TMDB for movie: 'Брат 3' (original: 'Брат 3')
2025-06-17 06:33:18,244 - movie_database - INFO - Фильм 'The Brattt' (TMDB ID: 633819) добавлен в базу данных.
2025-06-17 06:33:18,245 - recommendation_engine - INFO - Added movie 'The Brattt' to DB as ID 109
2025-06-17 06:33:18,245 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=109, action_type='recommendation'.
2025-06-17 06:33:18,245 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 109
2025-06-17 06:33:18,245 - recommendation_engine - INFO - Searching TMDB for movie: 'Брат 4' (original: 'Брат 4')
2025-06-17 06:33:18,551 - tmdb_agent - WARNING - Фильм 'Брат 4' не найден в TMDB.
2025-06-17 06:33:18,551 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Брат 4' (original: 'Брат 4'). Skipping.
2025-06-17 06:33:18,551 - recommendation_engine - INFO - Searching TMDB for movie: 'Брат 2' (original: 'Брат 2')
2025-06-17 06:33:19,133 - recommendation_engine - INFO - Movie 'Brother 2' already in DB as ID 23
2025-06-17 06:33:19,134 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=23, action_type='recommendation'.
2025-06-17 06:33:19,134 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 23
2025-06-17 06:33:19,134 - recommendation_engine - INFO - Searching TMDB for movie: 'Брат 5' (original: 'Брат 5')
2025-06-17 06:33:19,417 - tmdb_agent - WARNING - Фильм 'Брат 5' не найден в TMDB.
2025-06-17 06:33:19,417 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Брат 5' (original: 'Брат 5'). Skipping.
2025-06-17 06:33:19,417 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"The Brattt"** (2024), **"Brother 2"** (2000).Напи...'
2025-06-17 06:44:00,717 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:44:00,719 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:44:00,719 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:44:00,730 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:44:08,923 - handlers - INFO - Запрос от пользователя 577976124: привет
2025-06-17 06:44:08,924 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 06:44:08,929 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:44:10,246 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 06:44:13,167 - recommendation_engine - INFO - LLM candidate response: "Шерлок Холмс: Игра теней" (1994), "Индиана Джонс: В поисках утраченного ковчега" (1981), "Господин Никто" (2005), "Интерstellar" (2014), "Искусственный интеллект" (2014)
2025-06-17 06:44:13,170 - recommendation_engine - INFO - Extracted initial candidate titles: [('Интерstellar', 2014), ('Господин Никто', 2005), ('Искусственный интеллект', 2014), ('Шерлок Холмс: Игра теней', 1994), ('Индиана Джонс: В поисках утраченного ковчега', 1981)]
2025-06-17 06:44:13,171 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:44:13,988 - recommendation_engine - INFO - Translated Russian title 'Интерstellar' to English for TMDB search: 'Interstellar'
2025-06-17 06:44:13,989 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерstellar')
2025-06-17 06:44:14,291 - recommendation_engine - INFO - Movie 'Interstellar' already in DB as ID 29
2025-06-17 06:44:14,295 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=29, action_type='recommendation'.
2025-06-17 06:44:14,295 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 29
2025-06-17 06:44:14,295 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:44:15,107 - recommendation_engine - INFO - Translated Russian title 'Господин Никто' to English for TMDB search: 'Mr. Nobody'
2025-06-17 06:44:15,108 - recommendation_engine - INFO - Searching TMDB for movie: 'Mr. Nobody' (original: 'Господин Никто')
2025-06-17 06:44:15,597 - movie_database - INFO - Фильм 'Mr. Nobody' (TMDB ID: 31011) добавлен в базу данных.
2025-06-17 06:44:15,598 - recommendation_engine - INFO - Added movie 'Mr. Nobody' to DB as ID 110
2025-06-17 06:44:15,599 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=110, action_type='recommendation'.
2025-06-17 06:44:15,599 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 110
2025-06-17 06:44:15,599 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:44:16,985 - recommendation_engine - INFO - Translated Russian title 'Искусственный интеллект' to English for TMDB search: 'Artificial Intelligence'
2025-06-17 06:44:16,985 - recommendation_engine - INFO - Searching TMDB for movie: 'Artificial Intelligence' (original: 'Искусственный интеллект')
2025-06-17 06:44:17,493 - movie_database - INFO - Фильм 'Artificial Intelligence Sex' (TMDB ID: 716514) добавлен в базу данных.
2025-06-17 06:44:17,501 - recommendation_engine - INFO - Added movie 'Artificial Intelligence Sex' to DB as ID 111
2025-06-17 06:44:17,503 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=111, action_type='recommendation'.
2025-06-17 06:44:17,503 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 111
2025-06-17 06:44:17,503 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:44:19,180 - recommendation_engine - INFO - Translated Russian title 'Шерлок Холмс: Игра теней' to English for TMDB search: 'Sherlock Holmes: Game of Shadows'
2025-06-17 06:44:19,181 - recommendation_engine - INFO - Searching TMDB for movie: 'Sherlock Holmes: Game of Shadows' (original: 'Шерлок Холмс: Игра теней')
2025-06-17 06:44:19,653 - movie_database - INFO - Фильм 'Sherlock Holmes: A Game of Shadows' (TMDB ID: 58574) добавлен в базу данных.
2025-06-17 06:44:19,653 - recommendation_engine - INFO - Added movie 'Sherlock Holmes: A Game of Shadows' to DB as ID 112
2025-06-17 06:44:19,654 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=112, action_type='recommendation'.
2025-06-17 06:44:19,654 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 112
2025-06-17 06:44:19,655 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 06:44:21,493 - recommendation_engine - INFO - Translated Russian title 'Индиана Джонс: В поисках утраченного ковчега' to English for TMDB search: 'Indiana Jones: In Search of the Lost Ark'
2025-06-17 06:44:21,493 - recommendation_engine - INFO - Searching TMDB for movie: 'Indiana Jones: In Search of the Lost Ark' (original: 'Индиана Джонс: В поисках утраченного ковчега')
2025-06-17 06:44:21,740 - tmdb_agent - WARNING - Фильм 'Indiana Jones: In Search of the Lost Ark' не найден в TMDB.
2025-06-17 06:44:21,741 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Indiana Jones: In Search of the Lost Ark' (original: 'Индиана Джонс: В поисках утраченного ковчега'). Skipping.
2025-06-17 06:44:21,741 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Interstellar"** (2014), **"Mr. Nobody"** (2009), ...'
2025-06-17 06:45:13,445 - handlers - INFO - Запрос от пользователя 577976124: победа
2025-06-17 06:45:13,448 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'победа'
2025-06-17 06:45:13,449 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:45:15,062 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'победа...'
2025-06-17 06:45:15,062 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'победа...'
2025-06-17 06:45:17,878 - recommendation_engine - INFO - LLM candidate response: "Криминальное чтиво" (2000), "Реальная любовь" (2013), "Широкая дорога" (2017), "И искать я снова" (2018), "Мир тьмы" (2019)
2025-06-17 06:45:17,879 - recommendation_engine - INFO - Extracted initial candidate titles: [('Мир тьмы', 2019), ('Широкая дорога', 2017), ('Реальная любовь', 2013), ('И искать я снова', 2018), ('Криминальное чтиво', 2000)]
2025-06-17 06:45:17,880 - recommendation_engine - INFO - Searching TMDB for movie: 'Мир тьмы' (original: 'Мир тьмы')
2025-06-17 06:45:18,371 - movie_database - INFO - Фильм 'World of Darkness' (TMDB ID: 480368) добавлен в базу данных.
2025-06-17 06:45:18,371 - recommendation_engine - INFO - Added movie 'World of Darkness' to DB as ID 113
2025-06-17 06:45:18,371 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=113, action_type='recommendation'.
2025-06-17 06:45:18,371 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 113
2025-06-17 06:45:18,371 - recommendation_engine - INFO - Searching TMDB for movie: 'Широкая дорога' (original: 'Широкая дорога')
2025-06-17 06:45:18,688 - tmdb_agent - WARNING - Фильм 'Широкая дорога' не найден в TMDB.
2025-06-17 06:45:18,690 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Широкая дорога' (original: 'Широкая дорога'). Skipping.
2025-06-17 06:45:18,690 - recommendation_engine - INFO - Searching TMDB for movie: 'Реальная любовь' (original: 'Реальная любовь')
2025-06-17 06:45:19,172 - movie_database - INFO - Фильм 'Red Nose Day Actually' (TMDB ID: 447061) добавлен в базу данных.
2025-06-17 06:45:19,172 - recommendation_engine - INFO - Added movie 'Red Nose Day Actually' to DB as ID 114
2025-06-17 06:45:19,173 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=114, action_type='recommendation'.
2025-06-17 06:45:19,173 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 114
2025-06-17 06:45:19,173 - recommendation_engine - INFO - Searching TMDB for movie: 'И искать я снова' (original: 'И искать я снова')
2025-06-17 06:45:19,467 - tmdb_agent - WARNING - Фильм 'И искать я снова' не найден в TMDB.
2025-06-17 06:45:19,468 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'И искать я снова' (original: 'И искать я снова'). Skipping.
2025-06-17 06:45:19,468 - recommendation_engine - INFO - Searching TMDB for movie: 'Криминальное чтиво' (original: 'Криминальное чтиво')
2025-06-17 06:45:19,961 - movie_database - INFO - Фильм 'Pulp Fiction' (TMDB ID: 680) добавлен в базу данных.
2025-06-17 06:45:19,962 - recommendation_engine - INFO - Added movie 'Pulp Fiction' to DB as ID 115
2025-06-17 06:45:19,962 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=115, action_type='recommendation'.
2025-06-17 06:45:19,962 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 115
2025-06-17 06:45:19,962 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"World of Darkness"** (2017), **"Red Nose Day Actu...'
2025-06-17 06:46:11,052 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:46:13,014 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 06:46:13,014 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:46:13,015 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:46:13,026 - main - INFO - ✅ Бот успешно запущен.
2025-06-17 06:47:21,897 - main - ERROR - ❌ Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 76, in <module>
    asyncio.get_event_loop().run_until_complete(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 68, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:53:47,606 - main - INFO - Начало инициализации бота...
2025-06-17 06:53:47,608 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:53:47,608 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:53:47,611 - agents.genre_mapper - INFO - Loaded 94 unique genres from database.
2025-06-17 06:53:47,611 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 06:53:47,646 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 06:53:47,647 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1006, in __run
    raise exc
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 995, in __run
    loop.run_until_complete(self.initialize())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1017, in __run
    loop.run_until_complete(self.shutdown())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 200, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 195, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:54:45,137 - main - INFO - Начало инициализации бота...
2025-06-17 06:54:45,139 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:54:45,139 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:54:45,141 - agents.genre_mapper - INFO - Loaded 94 unique genres from database.
2025-06-17 06:54:45,142 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 06:54:45,158 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 06:54:54,165 - movie_database - ERROR - Непредвиденная ошибка при добавлении пользователя: 'sqlite3.Connection' object has no attribute 'changes'
2025-06-17 06:54:54,166 - keyboards - INFO - Сформирована стартовая клавиатура.
2025-06-17 06:55:01,120 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 06:55:01,121 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 06:55:02,210 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'посоветуй что-нибудь интересное...'
2025-06-17 06:55:02,210 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 06:55:05,430 - recommendation_engine - INFO - LLM candidate response: "Между небом и землёй" (2000), "Чикаго" (2002), "Один дома в 2" (2019), "Локи" (2021 - сериал)

"Интерстеллар" (2014)
2025-06-17 06:55:05,432 - recommendation_engine - INFO - Extracted initial candidate titles: [('Чикаго', 2002), ('Интерстеллар', 2014), ('Один дома в 2', 2019), ('Между небом и землёй', 2000), ('Локи', None)]
2025-06-17 06:55:05,432 - recommendation_engine - INFO - Searching TMDB for movie: 'Чикаго' (original: 'Чикаго')
2025-06-17 06:55:06,087 - movie_database - INFO - Фильм 'Америка семидесятых. Дымы над Чикаго' (TMDB ID: 745536) добавлен в базу данных.
2025-06-17 06:55:06,087 - recommendation_engine - INFO - Added movie 'Америка семидесятых. Дымы над Чикаго' to DB as ID 116
2025-06-17 06:55:06,089 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=116, action_type='recommendation'.
2025-06-17 06:55:06,089 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 116
2025-06-17 06:55:06,089 - recommendation_engine - INFO - Searching TMDB for movie: 'Интерстеллар' (original: 'Интерстеллар')
2025-06-17 06:55:06,491 - recommendation_engine - INFO - Movie 'Interstellar' already in DB as ID 29
2025-06-17 06:55:06,493 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=29, action_type='recommendation'.
2025-06-17 06:55:06,494 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 29
2025-06-17 06:55:06,494 - recommendation_engine - INFO - Searching TMDB for movie: 'Один дома в 2' (original: 'Один дома в 2')
2025-06-17 06:55:07,186 - movie_database - INFO - Фильм 'Home Alone 2: Lost in New York' (TMDB ID: 772) добавлен в базу данных.
2025-06-17 06:55:07,186 - recommendation_engine - INFO - Added movie 'Home Alone 2: Lost in New York' to DB as ID 117
2025-06-17 06:55:07,187 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=117, action_type='recommendation'.
2025-06-17 06:55:07,187 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 117
2025-06-17 06:55:07,187 - recommendation_engine - INFO - Searching TMDB for movie: 'Между небом и землёй' (original: 'Между небом и землёй')
2025-06-17 06:55:08,005 - movie_database - INFO - Фильм 'Between Sky and Earth' (TMDB ID: 616954) добавлен в базу данных.
2025-06-17 06:55:08,005 - recommendation_engine - INFO - Added movie 'Between Sky and Earth' to DB as ID 118
2025-06-17 06:55:08,007 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=118, action_type='recommendation'.
2025-06-17 06:55:08,007 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 118
2025-06-17 06:55:08,007 - recommendation_engine - INFO - Searching TMDB for movie: 'Локи' (original: 'Локи')
2025-06-17 06:55:08,886 - movie_database - INFO - Фильм 'The Good, the Bart, and the Loki' (TMDB ID: 846214) добавлен в базу данных.
2025-06-17 06:55:08,887 - recommendation_engine - INFO - Added movie 'The Good, the Bart, and the Loki' to DB as ID 119
2025-06-17 06:55:08,888 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=119, action_type='recommendation'.
2025-06-17 06:55:08,889 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 119
2025-06-17 06:55:08,889 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Америка семидесятых. Дымы над Чикаго"** (1970), *...'
2025-06-17 06:55:20,005 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 06:56:55,660 - main - INFO - Начало инициализации бота...
2025-06-17 06:56:55,666 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:56:55,666 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:56:55,675 - agents.genre_mapper - INFO - Loaded 95 unique genres from database.
2025-06-17 06:56:55,678 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 06:56:55,749 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 06:57:28,481 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 06:57:28,482 - keyboards - INFO - Сформирована стартовая клавиатура.
2025-06-17 06:57:34,592 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 06:57:34,594 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'посоветуй что-нибудь интересное': no such column: r.rated_at
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 226, in generate_recommendations
    user_ratings = self.db.get_user_ratings(user_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/database/movies.py", line 348, in get_user_ratings
    cursor.execute("""
sqlite3.OperationalError: no such column: r.rated_at
2025-06-17 06:57:34,601 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 06:59:08,166 - main - INFO - Начало инициализации бота...
2025-06-17 06:59:08,167 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:59:08,167 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:59:08,168 - agents.genre_mapper - INFO - Loaded 95 unique genres from database.
2025-06-17 06:59:08,169 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 06:59:08,181 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 06:59:12,106 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:59:12,110 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 06:59:13,462 - main - INFO - Начало инициализации бота...
2025-06-17 06:59:13,463 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 06:59:13,463 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 06:59:13,463 - agents.genre_mapper - INFO - Loaded 95 unique genres from database.
2025-06-17 06:59:13,463 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 06:59:13,476 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 06:59:20,386 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 06:59:38,044 - handlers - INFO - Запрос от пользователя 577976124: старый ламповый фильм ссср
2025-06-17 06:59:38,318 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'старый ламповый фильм ссср'
2025-06-17 06:59:38,319 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'старый ламповый фильм ссср': no such column: r.rated_at
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 226, in generate_recommendations
    user_ratings = self.db.get_user_ratings(user_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/database/movies.py", line 348, in get_user_ratings
    cursor.execute("""
sqlite3.OperationalError: no such column: r.rated_at
2025-06-17 06:59:38,325 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:01:07,170 - main - INFO - Начало инициализации бота...
2025-06-17 07:01:07,170 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:01:07,171 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:01:07,172 - agents.genre_mapper - INFO - Loaded 95 unique genres from database.
2025-06-17 07:01:07,172 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:01:07,200 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:01:14,546 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:01:19,585 - handlers - INFO - Запрос от пользователя 577976124: хочу брата
2025-06-17 07:01:19,726 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'хочу брата'
2025-06-17 07:01:19,727 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'хочу брата': no such column: r.rated_at
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 226, in generate_recommendations
    user_ratings = self.db.get_user_ratings(user_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/database/movies.py", line 345, in get_user_ratings
    cursor.execute("""
sqlite3.OperationalError: no such column: r.rated_at
2025-06-17 07:01:19,730 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:02:05,019 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:03:48,611 - main - INFO - Начало инициализации бота...
2025-06-17 07:03:48,615 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:03:48,615 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:03:48,615 - agents.genre_mapper - INFO - Loaded 0 unique genres from database.
2025-06-17 07:03:48,615 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:03:48,635 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:03:56,973 - movie_database - INFO - Пользователь GumGus (ID: 577976124) добавлен в базу данных.
2025-06-17 07:04:00,918 - handlers - INFO - Запрос от пользователя 577976124: росомаха
2025-06-17 07:04:01,084 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'росомаха'
2025-06-17 07:04:01,085 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:04:02,589 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'росомаха...'
2025-06-17 07:04:02,590 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'росомаха...'
2025-06-17 07:04:05,792 - recommendation_engine - INFO - LLM candidate response: Интерстеллиarator (2020), Терминатор (1984), Война миров (2005), Междуnezowia (2016), Невероятный Халк (2008)
2025-06-17 07:04:05,794 - recommendation_engine - INFO - Extracted initial candidate titles: [('Терминатор', 1984), ('Война миров', 2005), ('Междуnezowia', 2016), ('Невероятный Халк', 2008), ('Интерстеллиarator', 2020)]
2025-06-17 07:04:05,795 - recommendation_engine - INFO - Searching TMDB for movie: 'Терминатор' (original: 'Терминатор')
2025-06-17 07:04:06,214 - movie_database - INFO - Фильм 'The Terminator' (TMDB ID: 218) добавлен/обновлен в базу данных.
2025-06-17 07:04:06,215 - recommendation_engine - INFO - Added movie 'The Terminator' to DB as ID 1
2025-06-17 07:04:06,216 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=1, action_type='recommendation'.
2025-06-17 07:04:06,216 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 1
2025-06-17 07:04:06,216 - recommendation_engine - INFO - Searching TMDB for movie: 'Война миров' (original: 'Война миров')
2025-06-17 07:04:06,596 - movie_database - INFO - Фильм 'Bacteria. War of the Worlds' (TMDB ID: 1227468) добавлен/обновлен в базу данных.
2025-06-17 07:04:06,596 - recommendation_engine - INFO - Added movie 'Bacteria. War of the Worlds' to DB as ID 2
2025-06-17 07:04:06,597 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=2, action_type='recommendation'.
2025-06-17 07:04:06,597 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 2
2025-06-17 07:04:06,597 - recommendation_engine - INFO - Searching TMDB for movie: 'Междуnezowia' (original: 'Междуnezowia')
2025-06-17 07:04:06,983 - tmdb_agent - WARNING - Фильм 'Междуnezowia' не найден в TMDB.
2025-06-17 07:04:06,983 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Междуnezowia' (original: 'Междуnezowia'). Skipping.
2025-06-17 07:04:06,983 - recommendation_engine - INFO - Searching TMDB for movie: 'Невероятный Халк' (original: 'Невероятный Халк')
2025-06-17 07:04:07,590 - movie_database - INFO - Фильм 'The Incredible Hulk' (TMDB ID: 1724) добавлен/обновлен в базу данных.
2025-06-17 07:04:07,590 - recommendation_engine - INFO - Added movie 'The Incredible Hulk' to DB as ID 3
2025-06-17 07:04:07,592 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=3, action_type='recommendation'.
2025-06-17 07:04:07,592 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 3
2025-06-17 07:04:07,592 - recommendation_engine - INFO - Searching TMDB for movie: 'Интерстеллиarator' (original: 'Интерстеллиarator')
2025-06-17 07:04:07,960 - tmdb_agent - WARNING - Фильм 'Интерстеллиarator' не найден в TMDB.
2025-06-17 07:04:07,960 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Интерстеллиarator' (original: 'Интерстеллиarator'). Skipping.
2025-06-17 07:04:07,961 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"The Terminator"** (1984), **"Bacteria. War of the...'
2025-06-17 07:04:11,536 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:04:58,092 - handlers - INFO - Запрос от пользователя 577976124: человек-паук
2025-06-17 07:04:58,396 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'человек-паук'
2025-06-17 07:04:58,396 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:04:59,740 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'человек-паук...'
2025-06-17 07:04:59,740 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'человек-паук...'
2025-06-17 07:05:02,968 - recommendation_engine - INFO - LLM candidate response: Человек-паук (2002), Человек-паук 2 (2004), Человек-паук: Возвращение домой (2017), Человек-паук: Вдали от дома (2021), Человек-паук: Нет пути домой (2022)
2025-06-17 07:05:02,969 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук', 2002), ('Человек-паук 2', 2004), ('Человек-паук: Вдали от дома', 2021), ('Человек-паук: Нет пути домой', 2022), ('Человек-паук: Возвращение домой', 2017)]
2025-06-17 07:05:02,969 - recommendation_engine - INFO - Searching TMDB for movie: 'Человек-паук' (original: 'Человек-паук')
2025-06-17 07:05:03,508 - movie_database - INFO - Фильм 'Spider-Man' (TMDB ID: 557) добавлен/обновлен в базу данных.
2025-06-17 07:05:03,508 - recommendation_engine - INFO - Added movie 'Spider-Man' to DB as ID 4
2025-06-17 07:05:03,510 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=4, action_type='recommendation'.
2025-06-17 07:05:03,510 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 4
2025-06-17 07:05:03,510 - recommendation_engine - INFO - Searching TMDB for movie: 'Человек-паук 2' (original: 'Человек-паук 2')
2025-06-17 07:05:04,056 - recommendation_engine - INFO - Movie 'Spider-Man' already in DB as ID 4
2025-06-17 07:05:04,058 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=4, action_type='recommendation'.
2025-06-17 07:05:04,058 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 4
2025-06-17 07:05:04,059 - recommendation_engine - INFO - Searching TMDB for movie: 'Человек-паук: Вдали от дома' (original: 'Человек-паук: Вдали от дома')
2025-06-17 07:05:04,548 - movie_database - INFO - Фильм 'Spider-Man: Far From Home' (TMDB ID: 429617) добавлен/обновлен в базу данных.
2025-06-17 07:05:04,549 - recommendation_engine - INFO - Added movie 'Spider-Man: Far From Home' to DB as ID 5
2025-06-17 07:05:04,550 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=5, action_type='recommendation'.
2025-06-17 07:05:04,550 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 5
2025-06-17 07:05:04,550 - recommendation_engine - INFO - Searching TMDB for movie: 'Человек-паук: Нет пути домой' (original: 'Человек-паук: Нет пути домой')
2025-06-17 07:05:05,185 - movie_database - INFO - Фильм 'Spider-Man: No Way Home' (TMDB ID: 634649) добавлен/обновлен в базу данных.
2025-06-17 07:05:05,185 - recommendation_engine - INFO - Added movie 'Spider-Man: No Way Home' to DB as ID 6
2025-06-17 07:05:05,187 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=6, action_type='recommendation'.
2025-06-17 07:05:05,187 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 6
2025-06-17 07:05:05,187 - recommendation_engine - INFO - Searching TMDB for movie: 'Человек-паук: Возвращение домой' (original: 'Человек-паук: Возвращение домой')
2025-06-17 07:05:05,758 - movie_database - INFO - Фильм 'Spider-Man: Homecoming' (TMDB ID: 315635) добавлен/обновлен в базу данных.
2025-06-17 07:05:05,758 - recommendation_engine - INFO - Added movie 'Spider-Man: Homecoming' to DB as ID 7
2025-06-17 07:05:05,759 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=7, action_type='recommendation'.
2025-06-17 07:05:05,759 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 7
2025-06-17 07:05:05,760 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Spider-Man"** (2002), **"Spider-Man"** (2002), **...'
2025-06-17 07:05:14,557 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:07:39,270 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:07:41,824 - main - INFO - Начало инициализации бота...
2025-06-17 07:07:41,825 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:07:41,825 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:07:41,826 - agents.genre_mapper - INFO - Loaded 6 unique genres from database.
2025-06-17 07:07:41,826 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:07:41,864 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:07:54,985 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:08:00,055 - handlers - INFO - Запрос от пользователя 577976124: пироги
2025-06-17 07:08:00,239 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'пироги'
2025-06-17 07:08:00,240 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:08:01,529 - agents.translator - WARNING - LLM returned invalid language code: 'ru (Russian)' for text 'пироги...'
2025-06-17 07:08:01,530 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'пироги...'
2025-06-17 07:08:03,180 - recommendation_engine - INFO - LLM candidate response: "Волк с Уолл-стрит" (2013), "Интерстеллар" (2014), "Логан" (2017), "Близкие" (2016), "Паразиты" (2019)
2025-06-17 07:08:03,183 - recommendation_engine - INFO - Extracted initial candidate titles: [('Логан', 2017), ('Близкие', 2016), ('Паразиты', 2019), ('Интерстеллар', 2014), ('Волк с Уолл-стрит', 2013)]
2025-06-17 07:08:03,183 - recommendation_engine - INFO - Searching TMDB for movie: 'Логан' (original: 'Логан')
2025-06-17 07:08:03,592 - tmdb_agent - INFO - Найдено 6 фильмов для запроса 'Логан'.
2025-06-17 07:08:05,065 - tmdb_agent - INFO - Получены детали для фильма 'Удача Логана' (TMDB ID: 399170).
2025-06-17 07:08:05,066 - tmdb_agent - INFO - Фильм 'Удача Логана' обогащен данными.
2025-06-17 07:08:05,068 - movie_database - INFO - Фильм 'Удача Логана' (TMDB ID: 399170) добавлен/обновлен в базу данных.
2025-06-17 07:08:05,068 - recommendation_engine - INFO - Added movie 'Удача Логана' to DB as ID 8
2025-06-17 07:08:05,069 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=8, action_type='recommendation'.
2025-06-17 07:08:05,069 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 8
2025-06-17 07:08:05,069 - recommendation_engine - INFO - Searching TMDB for movie: 'Близкие' (original: 'Близкие')
2025-06-17 07:08:05,380 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Близкие'.
2025-06-17 07:08:05,692 - tmdb_agent - INFO - Получены детали для фильма 'Близкие' (TMDB ID: 457844).
2025-06-17 07:08:05,692 - tmdb_agent - INFO - Фильм 'Близкие' обогащен данными.
2025-06-17 07:08:05,694 - movie_database - INFO - Фильм 'Близкие' (TMDB ID: 457844) добавлен/обновлен в базу данных.
2025-06-17 07:08:05,694 - recommendation_engine - INFO - Added movie 'Близкие' to DB as ID 9
2025-06-17 07:08:05,695 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=9, action_type='recommendation'.
2025-06-17 07:08:05,695 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 9
2025-06-17 07:08:05,695 - recommendation_engine - INFO - Searching TMDB for movie: 'Паразиты' (original: 'Паразиты')
2025-06-17 07:08:05,972 - tmdb_agent - INFO - Найдено 7 фильмов для запроса 'Паразиты'.
2025-06-17 07:08:06,261 - tmdb_agent - INFO - Получены детали для фильма 'Паразиты' (TMDB ID: 971930).
2025-06-17 07:08:06,262 - tmdb_agent - INFO - Фильм 'Паразиты' обогащен данными.
2025-06-17 07:08:06,263 - movie_database - INFO - Фильм 'Паразиты' (TMDB ID: 971930) добавлен/обновлен в базу данных.
2025-06-17 07:08:06,263 - recommendation_engine - INFO - Added movie 'Паразиты' to DB as ID 10
2025-06-17 07:08:06,264 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=10, action_type='recommendation'.
2025-06-17 07:08:06,264 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 10
2025-06-17 07:08:06,264 - recommendation_engine - INFO - Searching TMDB for movie: 'Интерстеллар' (original: 'Интерстеллар')
2025-06-17 07:08:06,566 - tmdb_agent - INFO - Найдено 2 фильмов для запроса 'Интерстеллар'.
2025-06-17 07:08:06,922 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:08:06,922 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:08:06,923 - movie_database - INFO - Фильм 'Интерстеллар' (TMDB ID: 157336) добавлен/обновлен в базу данных.
2025-06-17 07:08:06,923 - recommendation_engine - INFO - Added movie 'Интерстеллар' to DB as ID 11
2025-06-17 07:08:06,924 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:08:06,924 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:08:06,925 - recommendation_engine - INFO - Searching TMDB for movie: 'Волк с Уолл-стрит' (original: 'Волк с Уолл-стрит')
2025-06-17 07:08:07,405 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Волк с Уолл-стрит'.
2025-06-17 07:08:07,872 - tmdb_agent - INFO - Получены детали для фильма 'Волк с Уолл-стрит' (TMDB ID: 106646).
2025-06-17 07:08:07,873 - tmdb_agent - INFO - Фильм 'Волк с Уолл-стрит' обогащен данными.
2025-06-17 07:08:07,875 - movie_database - INFO - Фильм 'Волк с Уолл-стрит' (TMDB ID: 106646) добавлен/обновлен в базу данных.
2025-06-17 07:08:07,875 - recommendation_engine - INFO - Added movie 'Волк с Уолл-стрит' to DB as ID 12
2025-06-17 07:08:07,876 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=12, action_type='recommendation'.
2025-06-17 07:08:07,876 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 12
2025-06-17 07:08:07,876 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **"Удача Логана"** (2017), **"Близкие"** (2017), **"...'
2025-06-17 07:08:15,345 - handlers - ERROR - Ошибка при получении рекомендаций для пользователя 577976124: Can't parse entities: can't find end of the entity starting at byte offset 1212
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/tg_bot/handlers.py", line 103, in handle_text_message
    await update.message.reply_text(response_text, parse_mode='Markdown')
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_message.py", line 1094, in reply_text
    return await self.get_bot().send_message(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_extbot.py", line 2624, in send_message
    return await super().send_message(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_bot.py", line 525, in decorator
    result = await func(self, *args, **kwargs)  # skipcq: PYL-E1102
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_bot.py", line 846, in send_message
    return await self._send_message(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_extbot.py", line 522, in _send_message
    result = await super()._send_message(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_bot.py", line 703, in _send_message
    result = await self._post(
             ^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_bot.py", line 613, in _post
    return await self._do_post(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_extbot.py", line 340, in _do_post
    return await super()._do_post(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/_bot.py", line 641, in _do_post
    return await request.post(
           ^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/request/_baserequest.py", line 200, in post
    result = await self._request_wrapper(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/request/_baserequest.py", line 379, in _request_wrapper
    raise BadRequest(message)
telegram.error.BadRequest: Can't parse entities: can't find end of the entity starting at byte offset 1212
2025-06-17 07:08:15,377 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:09:15,971 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:09:18,442 - main - INFO - Начало инициализации бота...
2025-06-17 07:09:18,442 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:09:18,442 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:09:18,443 - agents.genre_mapper - INFO - Loaded 13 unique genres from database.
2025-06-17 07:09:18,443 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:09:18,463 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:09:24,372 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:09:30,267 - handlers - INFO - Запрос от пользователя 577976124: дыня
2025-06-17 07:09:30,584 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'дыня'
2025-06-17 07:09:30,585 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:09:31,528 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'дыня...'
2025-06-17 07:09:34,221 - recommendation_engine - INFO - LLM candidate response: "Интерстеллар" (2014), "Возвращение в будущее" (1985), "Тёмный рыцарь: Возвращение" (2008), "Игра престолов: Финал" (2019), "Лови и хвати" (2015)
2025-06-17 07:09:34,223 - recommendation_engine - INFO - Extracted initial candidate titles: [('Интерстеллар', 2014), ('Возвращение в будущее', 1985), ('Тёмный рыцарь: Возвращение', 2008), ('Игра престолов: Финал', 2019), ('Лови и хвати', 2015)]
2025-06-17 07:09:34,223 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:09:35,704 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:09:35,704 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:09:36,083 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:09:36,364 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:09:36,364 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:09:36,365 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:09:37,652 - agents.translator - WARNING - LLM returned invalid language code: 'en (English)' for text 'Interstellar...'
2025-06-17 07:09:37,652 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:09:39,679 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:09:39,681 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:09:39,684 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:09:39,684 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:09:39,684 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:09:40,926 - recommendation_engine - INFO - Translated Russian title 'Возвращение в будущее' to English for TMDB search: 'Time Travel

or

Return to the Future (title)'
2025-06-17 07:09:40,927 - recommendation_engine - INFO - Searching TMDB for movie: 'Time Travel

or

Return to the Future (title)' (original: 'Возвращение в будущее')
2025-06-17 07:09:41,210 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Time Travel

or

Return to the Future (title)'.
2025-06-17 07:09:41,210 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Time Travel

or

Return to the Future (title)'.
2025-06-17 07:09:41,210 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Time Travel

or

Return to the Future (title)' (original: 'Возвращение в будущее'). Skipping.
2025-06-17 07:09:41,210 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:09:42,376 - recommendation_engine - INFO - Translated Russian title 'Тёмный рыцарь: Возвращение' to English for TMDB search: 'Dark Knight: The Return'
2025-06-17 07:09:42,377 - recommendation_engine - INFO - Searching TMDB for movie: 'Dark Knight: The Return' (original: 'Тёмный рыцарь: Возвращение')
2025-06-17 07:09:42,683 - tmdb_agent - INFO - Найдено 4 фильмов для запроса 'Dark Knight: The Return'.
2025-06-17 07:09:43,073 - tmdb_agent - INFO - Получены детали для фильма 'Batman: The Dark Knight Returns' (TMDB ID: 472027).
2025-06-17 07:09:43,073 - tmdb_agent - INFO - Фильм 'Batman: The Dark Knight Returns' обогащен данными.
2025-06-17 07:09:43,074 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return only the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:09:44,329 - agents.translator - WARNING - LLM returned invalid language code: 'en (English)' for text 'Batman: The Dark Knight Returns...'
2025-06-17 07:09:44,330 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:09:48,642 - recommendation_engine - INFO - No sufficient fuzzy match for 'Batman: The Dark Knight Returns'. Comparisons: LLM_vs_TMDB_Localized ('тёмный рыцарь возвращение' vs 'batman the dark knight returns'): 0.07; LLM_vs_TMDB_Original_Translated ('тёмный рыцарь возвращение' vs 'бэтмен возвращение темного рыцаря the text provided is the title of a comic book series batman the dark knight returns translated into russian the translation is бэтмен возвращение темного рыцаря'): 0.14
2025-06-17 07:09:48,643 - recommendation_engine - WARNING - Movie 'Batman: The Dark Knight Returns' deemed not relevant to original query: 'дыня...' or LLM suggestion. Skipping.
2025-06-17 07:09:48,643 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:09:50,340 - recommendation_engine - INFO - Translated Russian title 'Игра престолов: Финал' to English for TMDB search: 'Game of Thrones: Finale'
2025-06-17 07:09:50,340 - recommendation_engine - INFO - Searching TMDB for movie: 'Game of Thrones: Finale' (original: 'Игра престолов: Финал')
2025-06-17 07:09:50,650 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Game of Thrones: Finale'.
2025-06-17 07:09:50,651 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Game of Thrones: Finale'.
2025-06-17 07:09:50,651 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Game of Thrones: Finale' (original: 'Игра престолов: Финал'). Skipping.
2025-06-17 07:09:50,651 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:09:51,431 - recommendation_engine - INFO - Translated Russian title 'Лови и хвати' to English for TMDB search: 'Catch and hold'
2025-06-17 07:09:51,431 - recommendation_engine - INFO - Searching TMDB for movie: 'Catch and hold' (original: 'Лови и хвати')
2025-06-17 07:09:51,721 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Catch and hold'.
2025-06-17 07:09:51,721 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Catch and hold'.
2025-06-17 07:09:51,722 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Catch and hold' (original: 'Лови и хвати'). Skipping.
2025-06-17 07:09:51,722 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Интерстеллар** (2014).Напиши короткий, дружелюбный...'
2025-06-17 07:09:57,777 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:10:13,338 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 11.
2025-06-17 07:10:24,323 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='saved'.
2025-06-17 07:10:24,324 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:11:12,583 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:11:29,022 - main - INFO - Начало инициализации бота...
2025-06-17 07:11:29,054 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:11:29,054 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:11:29,059 - agents.genre_mapper - INFO - Loaded 13 unique genres from database.
2025-06-17 07:11:29,060 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:11:29,118 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:11:39,819 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:11:45,356 - handlers - INFO - Запрос от пользователя 577976124: лас вегас
2025-06-17 07:11:45,780 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'лас вегас'
2025-06-17 07:11:45,782 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:11:48,176 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'лас вегас...'
2025-06-17 07:11:50,606 - recommendation_engine - INFO - LLM candidate response: Интерстелляр (2014), 007: Шипка (2012), Игра престолов (2011), Звёздные войны: Пробуждение силы (2015), Мир Уолдо и его друзей (2003)
2025-06-17 07:11:50,608 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 07:11:50,608 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 07:11:50,609 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:11:54,111 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 07:11:54,113 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:11:55,733 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 07:11:58,507 - recommendation_engine - INFO - LLM candidate response: "Игра прет-ада" (2000), "Тёмный рыцарь" (2008), "Война миров" (2016), "Интерстеллар" (2014), "Кошмар на улице Вязов" (1984)
2025-06-17 07:11:58,508 - recommendation_engine - INFO - Extracted initial candidate titles: [('Игра прет-ада', 2000), ('Тёмный рыцарь', 2008), ('Война миров', 2016), ('Интерстеллар', 2014), ('Кошмар на улице Вязов', 1984)]
2025-06-17 07:11:58,508 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:12:00,631 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'посоветуй что-нибудь интересное': name 'difflib' is not defined
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 272, in generate_recommendations
    if self.translator_agent.is_translation_different(title_ru, translated_title):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/agents/translator.py", line 153, in is_translation_different
    difflib.SequenceMatcher(None, cleaned_original, cleaned_translated).ratio() < 0.95
    ^^^^^^^
NameError: name 'difflib' is not defined
2025-06-17 07:12:00,635 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:12:29,012 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:12:46,965 - main - INFO - Начало инициализации бота...
2025-06-17 07:12:46,968 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:12:46,968 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:12:46,968 - agents.genre_mapper - INFO - Loaded 13 unique genres from database.
2025-06-17 07:12:46,969 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:12:46,993 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:12:56,198 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:12:59,793 - handlers - INFO - Запрос от пользователя 577976124: хлеб
2025-06-17 07:12:59,927 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'хлеб'
2025-06-17 07:12:59,928 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:13:01,677 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'хлеб...'
2025-06-17 07:13:03,540 - recommendation_engine - INFO - LLM candidate response: "Главный» (2004), "Властелин колец: Братство Кольца" (2001), "Батмен Beckham" (2003), "Звездные войны: Империя наносит ответный удар" (1980), "Индиана Джонс: Хранитель чудес" (2008)
2025-06-17 07:13:03,541 - recommendation_engine - INFO - Extracted initial candidate titles: [('Властелин колец: Братство Кольца', 2001), ('Батмен Beckham', 2003), ('Звездные войны: Империя наносит ответный удар', 1980), ('Индиана Джонс: Хранитель чудес', 2008)]
2025-06-17 07:13:03,541 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:13:04,722 - recommendation_engine - ERROR - Глобальная ошибка в generate_recommendations для запроса 'хлеб': name 'difflib' is not defined
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/core/engine.py", line 272, in generate_recommendations
    if self.translator_agent.is_translation_different(title_ru, translated_title):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/agents/translator.py", line 153, in is_translation_different
    difflib.SequenceMatcher(None, cleaned_original, cleaned_translated).ratio() < 0.95
    ^^^^^^^
NameError: name 'difflib' is not defined
2025-06-17 07:13:04,728 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:13:54,641 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:14:03,786 - main - INFO - Начало инициализации бота...
2025-06-17 07:14:03,786 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:14:03,786 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:14:03,787 - agents.genre_mapper - INFO - Loaded 13 unique genres from database.
2025-06-17 07:14:03,787 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:14:03,799 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:14:07,939 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:14:12,898 - handlers - INFO - Запрос от пользователя 577976124: привет
2025-06-17 07:14:13,067 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'привет'
2025-06-17 07:14:13,068 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:14:14,342 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'привет...'
2025-06-17 07:14:15,953 - recommendation_engine - INFO - LLM candidate response: «Инcepион» (2008), «Мирultra» (2018), «1917» (2019), «Теневая зона» (2018), «Волк с Уолл-стрит» (2013)
2025-06-17 07:14:15,954 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инcepион', 2008), ('Мирultra', 2018), ('1917', 2019), ('Теневая зона', 2018), ('Волк с Уолл-стрит', 2013)]
2025-06-17 07:14:15,954 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:14:16,764 - recommendation_engine - INFO - Translated Russian title 'Инcepион' to English for TMDB search: 'Inception'
2025-06-17 07:14:16,765 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инcepион')
2025-06-17 07:14:17,279 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:14:17,641 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:14:17,641 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:14:17,642 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:14:19,223 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:14:20,393 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инcepион' vs 'начало'): 0.29; LLM_vs_TMDB_Original_Translated ('инcepион' vs 'инцепция'): 0.38
2025-06-17 07:14:20,394 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'привет...' or LLM suggestion. Skipping.
2025-06-17 07:14:20,394 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:14:21,295 - recommendation_engine - INFO - Translated Russian title 'Мирultra' to English for TMDB search: 'Mirultra'
2025-06-17 07:14:21,295 - recommendation_engine - INFO - Searching TMDB for movie: 'Mirultra' (original: 'Мирultra')
2025-06-17 07:14:21,580 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Mirultra'.
2025-06-17 07:14:21,581 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Mirultra'.
2025-06-17 07:14:21,581 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Mirultra' (original: 'Мирultra'). Skipping.
2025-06-17 07:14:21,581 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:14:24,331 - recommendation_engine - WARNING - Translation to English for TMDB failed or returned same text for '1917'. Using original.
2025-06-17 07:14:24,332 - recommendation_engine - INFO - Searching TMDB for movie: '1917' (original: '1917')
2025-06-17 07:14:24,623 - tmdb_agent - INFO - Найдено 20 фильмов для запроса '1917'.
2025-06-17 07:14:24,927 - tmdb_agent - INFO - Получены детали для фильма '1917' (TMDB ID: 530915).
2025-06-17 07:14:24,927 - tmdb_agent - INFO - Фильм '1917' обогащен данными.
2025-06-17 07:14:24,928 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:14:25,852 - agents.translator - WARNING - LLM returned invalid language code: 'The language is not specified in the provided text. It's a numerical value, not a language.' for text '1917...' after cleaning: 'The language is not specified in the provided text. It's a numerical value, not a language.'
2025-06-17 07:14:25,852 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:14:27,080 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for '1917'. Ratio: 1.00
2025-06-17 07:14:27,085 - movie_database - INFO - Фильм '1917' (TMDB ID: 530915) добавлен/обновлен в базу данных.
2025-06-17 07:14:27,086 - recommendation_engine - INFO - Added movie '1917' to DB as ID 13
2025-06-17 07:14:27,087 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=13, action_type='recommendation'.
2025-06-17 07:14:27,087 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 13
2025-06-17 07:14:27,087 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:14:28,365 - recommendation_engine - INFO - Translated Russian title 'Теневая зона' to English for TMDB search: 'Shadow zone'
2025-06-17 07:14:28,365 - recommendation_engine - INFO - Searching TMDB for movie: 'Shadow zone' (original: 'Теневая зона')
2025-06-17 07:14:28,682 - tmdb_agent - INFO - Найдено 6 фильмов для запроса 'Shadow zone'.
2025-06-17 07:14:29,008 - tmdb_agent - INFO - Получены детали для фильма 'S.T.A.L.K.E.R. Shadow of the Zone' (TMDB ID: 1328520).
2025-06-17 07:14:29,008 - tmdb_agent - INFO - Фильм 'S.T.A.L.K.E.R. Shadow of the Zone' обогащен данными.
2025-06-17 07:14:29,009 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:14:30,606 - recommendation_engine - INFO - No sufficient fuzzy match for 'S.T.A.L.K.E.R. Shadow of the Zone'. Comparisons: LLM_vs_TMDB_Localized ('теневая зона' vs 'stalker shadow of the zone'): 0.05
2025-06-17 07:14:30,608 - recommendation_engine - WARNING - Movie 'S.T.A.L.K.E.R. Shadow of the Zone' deemed not relevant to original query: 'привет...' or LLM suggestion. Skipping.
2025-06-17 07:14:30,608 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:14:32,218 - recommendation_engine - INFO - Translated Russian title 'Волк с Уолл-стрит' to English for TMDB search: 'Wolf of Wall Street'
2025-06-17 07:14:32,219 - recommendation_engine - INFO - Searching TMDB for movie: 'Wolf of Wall Street' (original: 'Волк с Уолл-стрит')
2025-06-17 07:14:32,653 - tmdb_agent - INFO - Найдено 3 фильмов для запроса 'Wolf of Wall Street'.
2025-06-17 07:14:32,993 - tmdb_agent - INFO - Получены детали для фильма 'Волк с Уолл-стрит' (TMDB ID: 106646).
2025-06-17 07:14:32,994 - tmdb_agent - INFO - Фильм 'Волк с Уолл-стрит' обогащен данными.
2025-06-17 07:14:32,994 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:14:34,760 - agents.translator - WARNING - LLM returned invalid language code: ''en' (English)' for text 'The Wolf of Wall Street...' after cleaning: ''en''
2025-06-17 07:14:34,760 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:14:36,041 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Волк с Уолл-стрит'. Ratio: 1.00
2025-06-17 07:14:36,042 - recommendation_engine - INFO - Movie 'Волк с Уолл-стрит' already in DB as ID 12
2025-06-17 07:14:36,046 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=12, action_type='recommendation'.
2025-06-17 07:14:36,046 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 12
2025-06-17 07:14:36,046 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **1917** (2019), **Волк с Уолл\-стрит** (2013).Напиш...'
2025-06-17 07:14:40,680 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:14:49,852 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 13.
2025-06-17 07:14:52,347 - callbacks - WARNING - Ошибка при редактировании сообщения (details) для 577976124: Media_caption_too_long
2025-06-17 07:14:52,348 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:15:15,914 - callbacks - WARNING - Ошибка при редактировании сообщения (details) для 577976124: Media_caption_too_long
2025-06-17 07:15:15,914 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:15:27,994 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 07:15:27,995 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:15:29,814 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 07:15:33,065 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "Пираты Карибского моря: На краю света" (2007), "Шахматная новелла" (2017), "Человек-паук: Дом Дракона" (2018), "Годзилла: Возрождение" (2014).
2025-06-17 07:15:33,066 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Пираты Карибского моря: На краю света', 2007), ('Шахматная новелла', 2017), ('Человек-паук: Дом Дракона', 2018), ('Годзилла: Возрождение', 2014)]
2025-06-17 07:15:33,066 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:15:34,662 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 07:15:34,662 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 07:15:34,885 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:15:35,110 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:15:35,110 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:15:35,110 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:15:36,892 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:15:38,813 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'взрыв'): 0.00; User_vs_TMDB_Localized ('посоветуй чтонибудь интересное' vs 'начало'): 0.06; User_vs_TMDB_Original ('посоветуй чтонибудь интересное' vs 'inception'): 0.00; User_vs_TMDB_Original_Translated ('посоветуй чтонибудь интересное' vs 'взрыв'): 0.11
2025-06-17 07:15:38,814 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'посоветуй что-нибудь интересное...' or LLM suggestion. Skipping.
2025-06-17 07:15:38,814 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:15:40,477 - recommendation_engine - INFO - Translated Russian title 'Пираты Карибского моря: На краю света' to English for TMDB search: 'Pirates of the Caribbean: At World's End'
2025-06-17 07:15:40,477 - recommendation_engine - INFO - Searching TMDB for movie: 'Pirates of the Caribbean: At World's End' (original: 'Пираты Карибского моря: На краю света')
2025-06-17 07:15:40,768 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Pirates of the Caribbean: At World's End'.
2025-06-17 07:15:41,135 - tmdb_agent - INFO - Получены детали для фильма 'Пираты Карибского моря: На краю света' (TMDB ID: 285).
2025-06-17 07:15:41,135 - tmdb_agent - INFO - Фильм 'Пираты Карибского моря: На краю света' обогащен данными.
2025-06-17 07:15:41,135 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:15:42,338 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:15:44,015 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Пираты Карибского моря: На краю света'. Ratio: 1.00
2025-06-17 07:15:44,023 - movie_database - INFO - Фильм 'Пираты Карибского моря: На краю света' (TMDB ID: 285) добавлен/обновлен в базу данных.
2025-06-17 07:15:44,024 - recommendation_engine - INFO - Added movie 'Пираты Карибского моря: На краю света' to DB as ID 14
2025-06-17 07:15:44,032 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=14, action_type='recommendation'.
2025-06-17 07:15:44,033 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 14
2025-06-17 07:15:44,033 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:15:45,595 - recommendation_engine - INFO - Translated Russian title 'Шахматная новелла' to English for TMDB search: 'Chess novella'
2025-06-17 07:15:45,596 - recommendation_engine - INFO - Searching TMDB for movie: 'Chess novella' (original: 'Шахматная новелла')
2025-06-17 07:15:45,921 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Chess novella'.
2025-06-17 07:15:45,921 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Chess novella'.
2025-06-17 07:15:45,921 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Chess novella' (original: 'Шахматная новелла'). Skipping.
2025-06-17 07:15:45,922 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:15:47,893 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Дом Дракона' to English for TMDB search: 'Spider-Man: House of Dragons'
2025-06-17 07:15:47,895 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: House of Dragons' (original: 'Человек-паук: Дом Дракона')
2025-06-17 07:15:48,198 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man: House of Dragons'.
2025-06-17 07:15:48,198 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man: House of Dragons'.
2025-06-17 07:15:48,198 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: House of Dragons' (original: 'Человек-паук: Дом Дракона'). Skipping.
2025-06-17 07:15:48,198 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:15:49,592 - recommendation_engine - INFO - Translated Russian title 'Годзилла: Возрождение' to English for TMDB search: 'Godzilla: Resurrection'
2025-06-17 07:15:49,593 - recommendation_engine - INFO - Searching TMDB for movie: 'Godzilla: Resurrection' (original: 'Годзилла: Возрождение')
2025-06-17 07:15:49,894 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Godzilla: Resurrection'.
2025-06-17 07:15:50,219 - tmdb_agent - INFO - Получены детали для фильма 'Godzilla Resurrection' (TMDB ID: 1226585).
2025-06-17 07:15:50,220 - tmdb_agent - INFO - Фильм 'Godzilla Resurrection' обогащен данными.
2025-06-17 07:15:50,220 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:15:52,802 - agents.translator - WARNING - LLM returned invalid language code: 'The language for the text "Godzilla Resurrection" cannot be definitively determined based solely on the title, as it is a title and not a text in a specific language. The film could have been produced in multiple languages. However, if we consider that the original Godzilla films are Japanese, the ISO 639-1 code for Japanese is 'ja'. But please note that this is an educated guess and not a definitive determination.' for text 'Godzilla Resurrection...' after cleaning: 'The language for the text Godzilla Resurrection cannot be definitively determined based solely on the title, as it is a title and not a text in a specific language. The film could have been produced in multiple languages. However, if we consider that the original Godzilla films are Japanese, the ISO 639-1 code for Japanese is 'ja'. But please note that this is an educated guess and not a definitive determination.'
2025-06-17 07:15:52,802 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:15:55,361 - recommendation_engine - INFO - No sufficient fuzzy match for 'Godzilla Resurrection'. Comparisons: LLM_vs_TMDB_Localized ('годзилла возрождение' vs 'godzilla resurrection'): 0.05; LLM_vs_TMDB_Original_Translated ('годзилла возрождение' vs 'богзилла воскресение ps замечу что godzilla на русский язык переводится как годзилла'): 0.15; User_vs_TMDB_Localized ('посоветуй чтонибудь интересное' vs 'godzilla resurrection'): 0.04; User_vs_TMDB_Original ('посоветуй чтонибудь интересное' vs 'godzilla resurrection'): 0.04; User_vs_TMDB_Original_Translated ('посоветуй чтонибудь интересное' vs 'богзилла воскресение ps замечу что godzilla на русский язык переводится как годзилла'): 0.28
2025-06-17 07:15:55,362 - recommendation_engine - WARNING - Movie 'Godzilla Resurrection' deemed not relevant to original query: 'посоветуй что-нибудь интересное...' or LLM suggestion. Skipping.
2025-06-17 07:15:55,362 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Пираты Карибского моря: На краю света** (2007).Нап...'
2025-06-17 07:16:08,623 - main - INFO - Начало инициализации бота...
2025-06-17 07:16:08,625 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:16:08,625 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:16:08,628 - agents.genre_mapper - INFO - Loaded 17 unique genres from database.
2025-06-17 07:16:08,628 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:16:08,661 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:16:12,393 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:16:18,758 - handlers - INFO - Запрос от пользователя 577976124: террорист
2025-06-17 07:16:19,101 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'террорист'
2025-06-17 07:16:19,103 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:16:20,933 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'террорист...'
2025-06-17 07:16:23,398 - recommendation_engine - INFO - LLM candidate response: Интерстэллар (1997), Гравити (2013), Иностранец в среди нас (2016), Джинс Джером (1995), Пятый элемент (1997)
2025-06-17 07:16:23,398 - recommendation_engine - INFO - Extracted initial candidate titles: []
2025-06-17 07:16:23,398 - recommendation_engine - WARNING - Не удалось извлечь названия фильмов из ответа LLM.
2025-06-17 07:16:23,399 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:18:32,971 - main - INFO - Начало инициализации бота...
2025-06-17 07:18:32,972 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:18:32,972 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:18:32,972 - agents.genre_mapper - INFO - Loaded 17 unique genres from database.
2025-06-17 07:18:32,972 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:18:32,986 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:18:36,989 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:18:47,536 - handlers - INFO - Запрос от пользователя 577976124: новый год и игрушки
2025-06-17 07:18:47,811 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'новый год и игрушки'
2025-06-17 07:18:47,813 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:18:49,690 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'новый год и игрушки...'
2025-06-17 07:18:52,777 - recommendation_engine - INFO - LLM candidate response: "Игра на выжившем" (2018), "Тёмный рыцарь: Возрождение легенды" (2012), "Гравити" (2013), "Интерстеллар" (2014), "Дедпул 2" (2018)
2025-06-17 07:18:52,779 - recommendation_engine - INFO - Extracted initial candidate titles: [('Игра на выжившем', 2018), ('Тёмный рыцарь: Возрождение легенды', 2012), ('Гравити', 2013), ('Интерстеллар', 2014), ('Дедпул 2', 2018), ('"Игра на выжившем"', 2018), ('"Тёмный рыцарь: Возрождение легенды"', 2012), ('"Гравити"', 2013), ('"Интерстеллар"', 2014), ('"Дедпул 2"', 2018)]
2025-06-17 07:18:52,779 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:18:54,443 - recommendation_engine - INFO - Translated Russian title 'Игра на выжившем' to English for TMDB search: 'Game on the survivor'
2025-06-17 07:18:54,445 - recommendation_engine - INFO - Searching TMDB for movie: 'Game on the survivor' (original: 'Игра на выжившем')
2025-06-17 07:18:54,787 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Game on the survivor'.
2025-06-17 07:18:54,787 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Game on the survivor'.
2025-06-17 07:18:54,788 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Game on the survivor' (original: 'Игра на выжившем'). Skipping.
2025-06-17 07:18:54,788 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:18:56,464 - recommendation_engine - INFO - Translated Russian title 'Тёмный рыцарь: Возрождение легенды' to English for TMDB search: 'Dark Knight: Legends Reborn'
2025-06-17 07:18:56,464 - recommendation_engine - INFO - Searching TMDB for movie: 'Dark Knight: Legends Reborn' (original: 'Тёмный рыцарь: Возрождение легенды')
2025-06-17 07:18:56,748 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Dark Knight: Legends Reborn'.
2025-06-17 07:18:56,749 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Dark Knight: Legends Reborn'.
2025-06-17 07:18:56,749 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Dark Knight: Legends Reborn' (original: 'Тёмный рыцарь: Возрождение легенды'). Skipping.
2025-06-17 07:18:56,749 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:18:58,339 - recommendation_engine - INFO - Translated Russian title 'Гравити' to English for TMDB search: 'Gravity'
2025-06-17 07:18:58,339 - recommendation_engine - INFO - Searching TMDB for movie: 'Gravity' (original: 'Гравити')
2025-06-17 07:18:58,634 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Gravity'.
2025-06-17 07:18:59,009 - tmdb_agent - INFO - Получены детали для фильма 'Гравитация' (TMDB ID: 49047).
2025-06-17 07:18:59,009 - tmdb_agent - INFO - Фильм 'Гравитация' обогащен данными.
2025-06-17 07:18:59,010 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:19:00,334 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:19:01,866 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Гравитация'. Ratio: 0.82
2025-06-17 07:19:01,870 - movie_database - INFO - Фильм 'Гравитация' (TMDB ID: 49047) добавлен/обновлен в базу данных.
2025-06-17 07:19:01,871 - recommendation_engine - INFO - Added movie 'Гравитация' to DB as ID 15
2025-06-17 07:19:01,874 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=15, action_type='recommendation'.
2025-06-17 07:19:01,874 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 15
2025-06-17 07:19:01,874 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:19:03,549 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:19:03,549 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:19:03,742 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:19:03,974 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:19:03,975 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:19:03,975 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:19:06,722 - agents.translator - WARNING - LLM returned invalid language code: 'The language code for the title "Interstellar" is not directly discernible from the given text as it is a title and not actual speech or writing containing the language. However, since "Interstellar" is a film produced in the United States, it is most likely to be in English (en).' for text 'Interstellar...' after cleaning: 'The language code for the title Interstellar is not directly discernible from the given text as it is a title and not actual speech or writing containing the language. However, since Interstellar is a film produced in the United States, it is most likely to be in English .'
2025-06-17 07:19:06,722 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:19:09,267 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:19:09,268 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:19:09,271 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:19:09,271 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:19:09,271 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:19:11,097 - recommendation_engine - INFO - Translated Russian title 'Дедпул 2' to English for TMDB search: 'Deadpool 2'
2025-06-17 07:19:11,097 - recommendation_engine - INFO - Searching TMDB for movie: 'Deadpool 2' (original: 'Дедпул 2')
2025-06-17 07:19:11,375 - tmdb_agent - INFO - Найдено 2 фильмов для запроса 'Deadpool 2'.
2025-06-17 07:19:11,738 - tmdb_agent - INFO - Получены детали для фильма 'Дэдпул 2' (TMDB ID: 383498).
2025-06-17 07:19:11,739 - tmdb_agent - INFO - Фильм 'Дэдпул 2' обогащен данными.
2025-06-17 07:19:11,739 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:19:12,848 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:19:15,356 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Дэдпул 2'. Ratio: 0.88
2025-06-17 07:19:15,363 - movie_database - INFO - Фильм 'Дэдпул 2' (TMDB ID: 383498) добавлен/обновлен в базу данных.
2025-06-17 07:19:15,365 - recommendation_engine - INFO - Added movie 'Дэдпул 2' to DB as ID 16
2025-06-17 07:19:15,376 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=16, action_type='recommendation'.
2025-06-17 07:19:15,376 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 16
2025-06-17 07:19:15,377 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Гравитация** (2013), **Интерстеллар** (2014), **Дэ...'
2025-06-17 07:19:19,805 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:19:33,468 - formatter - INFO - Сформированы детали фильма для Telegram: Гравитация
2025-06-17 07:19:33,633 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 15.
2025-06-17 07:19:36,445 - formatter - INFO - Сформированы детали фильма для Telegram: Интерстеллар
2025-06-17 07:19:36,532 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 11.
2025-06-17 07:19:39,619 - formatter - INFO - Сформированы детали фильма для Telegram: Дэдпул 2
2025-06-17 07:19:39,714 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 16.
2025-06-17 07:19:42,246 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=16, action_type='saved'.
2025-06-17 07:19:42,247 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:19:42,347 - callbacks - INFO - Фильм ID 16 сохранен пользователем 577976124.
2025-06-17 07:19:54,607 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=16, action_type='saved'.
2025-06-17 07:19:54,608 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:19:54,728 - callbacks - INFO - Фильм ID 16 сохранен пользователем 577976124.
2025-06-17 07:19:56,012 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='saved'.
2025-06-17 07:19:56,013 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:19:56,097 - callbacks - INFO - Фильм ID 11 сохранен пользователем 577976124.
2025-06-17 07:20:35,479 - handlers - INFO - Запрос от пользователя 577976124: человек-паук
2025-06-17 07:20:35,753 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'человек-паук'
2025-06-17 07:20:35,753 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:20:36,902 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'человек-паук...'
2025-06-17 07:20:40,503 - recommendation_engine - INFO - LLM candidate response: Человек-паук (2002), Человек-паук 2 (2004), Человек-паук 3 (2007), Человек-паук: Внутри шлема (2014), Человек-паук: На западе солнца (2017) (2002, 2004, 2007, 2014, 2017)
2025-06-17 07:20:40,503 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук', 2002), ('Человек-паук 2', 2004), ('Человек-паук 3', 2007), ('Человек-паук: Внутри шлема', 2014), ('Человек-паук: На западе солнца', 2017)]
2025-06-17 07:20:40,505 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:20:41,303 - recommendation_engine - INFO - Translated Russian title 'Человек-паук' to English for TMDB search: 'Spider-Man'
2025-06-17 07:20:41,304 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man' (original: 'Человек-паук')
2025-06-17 07:20:41,661 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Spider-Man'.
2025-06-17 07:20:42,080 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук' (TMDB ID: 557).
2025-06-17 07:20:42,081 - tmdb_agent - INFO - Фильм 'Человек-паук' обогащен данными.
2025-06-17 07:20:42,081 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:20:43,185 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:20:44,528 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук'. Ratio: 1.00
2025-06-17 07:20:44,528 - recommendation_engine - INFO - Movie 'Человек-паук' already in DB as ID 4
2025-06-17 07:20:44,534 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=4, action_type='recommendation'.
2025-06-17 07:20:44,534 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 4
2025-06-17 07:20:44,534 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:20:46,127 - recommendation_engine - INFO - Translated Russian title 'Человек-паук 2' to English for TMDB search: 'Spiderman 2'
2025-06-17 07:20:46,128 - recommendation_engine - INFO - Searching TMDB for movie: 'Spiderman 2' (original: 'Человек-паук 2')
2025-06-17 07:20:46,465 - tmdb_agent - INFO - Найдено 14 фильмов для запроса 'Spiderman 2'.
2025-06-17 07:20:46,809 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук 2' (TMDB ID: 558).
2025-06-17 07:20:46,809 - tmdb_agent - INFO - Фильм 'Человек-паук 2' обогащен данными.
2025-06-17 07:20:46,809 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:20:48,413 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:20:49,795 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук 2'. Ratio: 1.00
2025-06-17 07:20:49,798 - movie_database - INFO - Фильм 'Человек-паук 2' (TMDB ID: 558) добавлен/обновлен в базу данных.
2025-06-17 07:20:49,799 - recommendation_engine - INFO - Added movie 'Человек-паук 2' to DB as ID 17
2025-06-17 07:20:49,800 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=17, action_type='recommendation'.
2025-06-17 07:20:49,800 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 17
2025-06-17 07:20:49,800 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:20:51,553 - recommendation_engine - INFO - Translated Russian title 'Человек-паук 3' to English for TMDB search: 'Spider-Man 3'
2025-06-17 07:20:51,553 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man 3' (original: 'Человек-паук 3')
2025-06-17 07:20:51,839 - tmdb_agent - INFO - Найдено 5 фильмов для запроса 'Spider-Man 3'.
2025-06-17 07:20:52,256 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук 3: Враг в отражении' (TMDB ID: 559).
2025-06-17 07:20:52,257 - tmdb_agent - INFO - Фильм 'Человек-паук 3: Враг в отражении' обогащен данными.
2025-06-17 07:20:52,257 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:20:54,001 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:20:56,299 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук 3: Враг в отражении'. Ratio: 0.60
2025-06-17 07:20:56,304 - movie_database - INFO - Фильм 'Человек-паук 3: Враг в отражении' (TMDB ID: 559) добавлен/обновлен в базу данных.
2025-06-17 07:20:56,305 - recommendation_engine - INFO - Added movie 'Человек-паук 3: Враг в отражении' to DB as ID 18
2025-06-17 07:20:56,306 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=18, action_type='recommendation'.
2025-06-17 07:20:56,306 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 18
2025-06-17 07:20:56,306 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:20:58,009 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Внутри шлема' to English for TMDB search: 'Spider-Man: Inside the helmet'
2025-06-17 07:20:58,010 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: Inside the helmet' (original: 'Человек-паук: Внутри шлема')
2025-06-17 07:20:58,673 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man: Inside the helmet'.
2025-06-17 07:20:58,673 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man: Inside the helmet'.
2025-06-17 07:20:58,673 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: Inside the helmet' (original: 'Человек-паук: Внутри шлема'). Skipping.
2025-06-17 07:20:58,674 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:20:59,804 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: На западе солнца' to English for TMDB search: 'Spider-Man: At the west of the sun'
2025-06-17 07:20:59,805 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: At the west of the sun' (original: 'Человек-паук: На западе солнца')
2025-06-17 07:21:00,112 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man: At the west of the sun'.
2025-06-17 07:21:00,112 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man: At the west of the sun'.
2025-06-17 07:21:00,112 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: At the west of the sun' (original: 'Человек-паук: На западе солнца'). Skipping.
2025-06-17 07:21:00,112 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Человек\-паук** (2002), **Человек\-паук 2** (2004)...'
2025-06-17 07:21:11,070 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:23:06,037 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 206, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 201, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:27:35,174 - main - INFO - Начало инициализации бота...
2025-06-17 07:27:35,176 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:27:35,176 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:27:35,178 - agents.genre_mapper - INFO - Loaded 17 unique genres from database.
2025-06-17 07:27:35,178 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:27:35,199 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:27:38,426 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:27:38,427 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:27:51,057 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 07:27:51,059 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:27:52,415 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 07:27:55,398 - recommendation_engine - INFO - LLM candidate response: «Человек-паук: Наवсегда» (2021), «Титаник» (1997), «Инception» (2010), «Пираты Карибского моря: На краю света» (2007), «Логан» (2017).
2025-06-17 07:27:55,399 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук: Наवсегда', 2021), ('Титаник', 1997), ('Инception', 2010), ('Пираты Карибского моря: На краю света', 2007), ('Логан', 2017), ('«Человек-паук: Наवсегда»', 2021), ('«Титаник»', 1997), ('«Инception»', 2010), ('«Пираты Карибского моря: На краю света»', 2007), ('«Логан»', 2017)]
2025-06-17 07:27:55,400 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:27:56,913 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Наवсегда' to English for TMDB search: 'Human Spider: Forever'
2025-06-17 07:27:56,914 - recommendation_engine - INFO - Searching TMDB for movie: 'Human Spider: Forever' (original: 'Человек-паук: Наवсегда')
2025-06-17 07:27:57,241 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Human Spider: Forever'.
2025-06-17 07:27:57,241 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Human Spider: Forever'.
2025-06-17 07:27:57,241 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Human Spider: Forever' (original: 'Человек-паук: Наवсегда'). Skipping.
2025-06-17 07:27:57,242 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:27:58,099 - recommendation_engine - INFO - Translated Russian title 'Титаник' to English for TMDB search: 'Titanic'
2025-06-17 07:27:58,100 - recommendation_engine - INFO - Searching TMDB for movie: 'Titanic' (original: 'Титаник')
2025-06-17 07:27:58,339 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Titanic'.
2025-06-17 07:27:58,654 - tmdb_agent - INFO - Получены детали для фильма 'Титаник' (TMDB ID: 597).
2025-06-17 07:27:58,657 - tmdb_agent - INFO - Фильм 'Титаник' обогащен данными.
2025-06-17 07:27:58,660 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:28:00,256 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:28:02,125 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Титаник'. Ratio: 1.00
2025-06-17 07:28:02,128 - movie_database - INFO - Фильм 'Титаник' (TMDB ID: 597) добавлен/обновлен в базу данных.
2025-06-17 07:28:02,128 - recommendation_engine - INFO - Added movie 'Титаник' to DB as ID 19
2025-06-17 07:28:02,130 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=19, action_type='recommendation'.
2025-06-17 07:28:02,130 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 19
2025-06-17 07:28:02,130 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:28:03,687 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 07:28:03,688 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 07:28:03,842 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:28:04,063 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:28:04,064 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:28:04,064 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:28:05,113 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:28:06,870 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'воскресение'): 0.10; User_vs_TMDB_Localized ('посоветуй чтонибудь интересное' vs 'начало'): 0.06; User_vs_TMDB_Original ('посоветуй чтонибудь интересное' vs 'inception'): 0.00; User_vs_TMDB_Original_Translated ('посоветуй чтонибудь интересное' vs 'воскресение'): 0.34
2025-06-17 07:28:06,871 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'посоветуй что-нибудь интересное...' or LLM suggestion. Skipping.
2025-06-17 07:28:06,871 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:28:08,297 - recommendation_engine - INFO - Translated Russian title 'Пираты Карибского моря: На краю света' to English for TMDB search: 'Pirates of the Caribbean: At World's End'
2025-06-17 07:28:08,297 - recommendation_engine - INFO - Searching TMDB for movie: 'Pirates of the Caribbean: At World's End' (original: 'Пираты Карибского моря: На краю света')
2025-06-17 07:28:08,431 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Pirates of the Caribbean: At World's End'.
2025-06-17 07:28:08,686 - tmdb_agent - INFO - Получены детали для фильма 'Пираты Карибского моря: На краю света' (TMDB ID: 285).
2025-06-17 07:28:08,687 - tmdb_agent - INFO - Фильм 'Пираты Карибского моря: На краю света' обогащен данными.
2025-06-17 07:28:08,687 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:28:09,462 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:28:11,445 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Пираты Карибского моря: На краю света'. Ratio: 1.00
2025-06-17 07:28:11,446 - recommendation_engine - INFO - Movie 'Пираты Карибского моря: На краю света' already in DB as ID 14
2025-06-17 07:28:11,450 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=14, action_type='recommendation'.
2025-06-17 07:28:11,450 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 14
2025-06-17 07:28:11,450 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:28:12,747 - recommendation_engine - INFO - Translated Russian title 'Логан' to English for TMDB search: 'Logan'
2025-06-17 07:28:12,748 - recommendation_engine - INFO - Searching TMDB for movie: 'Logan' (original: 'Логан')
2025-06-17 07:28:13,244 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Logan'.
2025-06-17 07:28:13,584 - tmdb_agent - INFO - Получены детали для фильма 'Логан' (TMDB ID: 263115).
2025-06-17 07:28:13,585 - tmdb_agent - INFO - Фильм 'Логан' обогащен данными.
2025-06-17 07:28:13,585 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:28:15,174 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:28:16,238 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Логан'. Ratio: 1.00
2025-06-17 07:28:16,241 - movie_database - INFO - Фильм 'Логан' (TMDB ID: 263115) добавлен/обновлен в базу данных.
2025-06-17 07:28:16,241 - recommendation_engine - INFO - Added movie 'Логан' to DB as ID 20
2025-06-17 07:28:16,243 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=20, action_type='recommendation'.
2025-06-17 07:28:16,243 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 20
2025-06-17 07:28:16,243 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Титаник** (1997), **Пираты Карибского моря: На кра...'
2025-06-17 07:28:23,135 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:28:33,204 - formatter - INFO - Сформированы детали фильма для Telegram: Логан
2025-06-17 07:28:33,387 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 20.
2025-06-17 07:28:35,759 - formatter - INFO - Сформированы детали фильма для Telegram: Пираты Карибского моря: На краю света
2025-06-17 07:28:35,842 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 14.
2025-06-17 07:28:37,512 - formatter - INFO - Сформированы детали фильма для Telegram: Титаник
2025-06-17 07:28:37,595 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 19.
2025-06-17 07:28:40,578 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=20, action_type='saved'.
2025-06-17 07:28:40,579 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:28:40,654 - callbacks - INFO - Фильм ID 20 сохранен пользователем 577976124.
2025-06-17 07:28:43,125 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=14, action_type='saved'.
2025-06-17 07:28:43,125 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:28:43,195 - callbacks - INFO - Фильм ID 14 сохранен пользователем 577976124.
2025-06-17 07:28:44,333 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=19, action_type='saved'.
2025-06-17 07:28:44,334 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:28:44,411 - callbacks - INFO - Фильм ID 19 сохранен пользователем 577976124.
2025-06-17 07:29:07,310 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:29:11,577 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Титаник** (1997), **Пираты Карибского моря: На краю света** (2007),...'
2025-06-17 07:29:17,709 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:29:17,797 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Титаник** (1997), **Пираты Карибского моря: На краю света** (2007),...'
2025-06-17 07:29:27,312 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:29:36,922 - handlers - INFO - Запрос от пользователя 577976124: бетмен пидорас
2025-06-17 07:29:37,264 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'бетмен пидорас'
2025-06-17 07:29:37,265 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:29:40,550 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'бетмен пидорас...'
2025-06-17 07:29:42,043 - recommendation_engine - INFO - LLM candidate response: "Бетмен: Возрождение" (2019), "Бетмен: Посмешительник" (2022), "Доктор Стрэндж: В мультивселенной безумия" (2016), "Аватар: Путь воды" (2009), "Интерстелляр" (2014)
2025-06-17 07:29:42,044 - recommendation_engine - INFO - Extracted initial candidate titles: [('Бетмен: Возрождение', 2019), ('Бетмен: Посмешительник', 2022), ('Доктор Стрэндж: В мультивселенной безумия', 2016), ('Аватар: Путь воды', 2009), ('Интерстелляр', 2014), ('"Бетмен: Возрождение"', 2019), ('"Бетмен: Посмешительник"', 2022), ('"Доктор Стрэндж: В мультивселенной безумия"', 2016), ('"Аватар: Путь воды"', 2009), ('"Интерстелляр"', 2014)]
2025-06-17 07:29:42,045 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:29:43,460 - recommendation_engine - INFO - Translated Russian title 'Бетмен: Возрождение' to English for TMDB search: 'Batman: Rebirth'
2025-06-17 07:29:43,460 - recommendation_engine - INFO - Searching TMDB for movie: 'Batman: Rebirth' (original: 'Бетмен: Возрождение')
2025-06-17 07:29:43,942 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Batman: Rebirth'.
2025-06-17 07:29:43,943 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Batman: Rebirth'.
2025-06-17 07:29:43,943 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Batman: Rebirth' (original: 'Бетмен: Возрождение'). Skipping.
2025-06-17 07:29:43,943 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:29:45,576 - recommendation_engine - INFO - Translated Russian title 'Бетмен: Посмешительник' to English for TMDB search: 'Joker: The Joker'
2025-06-17 07:29:45,577 - recommendation_engine - INFO - Searching TMDB for movie: 'Joker: The Joker' (original: 'Бетмен: Посмешительник')
2025-06-17 07:29:45,915 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Joker: The Joker'.
2025-06-17 07:29:46,314 - tmdb_agent - INFO - Получены детали для фильма 'Джокер' (TMDB ID: 133792).
2025-06-17 07:29:46,315 - tmdb_agent - INFO - Фильм 'Джокер' обогащен данными.
2025-06-17 07:29:46,315 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:29:48,043 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:29:49,239 - recommendation_engine - INFO - No sufficient fuzzy match for 'Джокер'. Comparisons: LLM_vs_TMDB_Localized ('бетмен посмешительник' vs 'джокер'): 0.07; LLM_vs_TMDB_Original_Translated ('бетмен посмешительник' vs 'жакер уже в игре'): 0.22; User_vs_TMDB_Localized ('бетмен пидорас' vs 'джокер'): 0.20; User_vs_TMDB_Original ('бетмен пидорас' vs 'the joker is wild'): 0.06; User_vs_TMDB_Original_Translated ('бетмен пидорас' vs 'жакер уже в игре'): 0.33
2025-06-17 07:29:49,240 - recommendation_engine - WARNING - Movie 'Джокер' deemed not relevant to original query: 'бетмен пидорас...' or LLM suggestion. Skipping.
2025-06-17 07:29:49,241 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:29:51,030 - recommendation_engine - INFO - Translated Russian title 'Доктор Стрэндж: В мультивселенной безумия' to English for TMDB search: 'Dr. Strange: In the Multiverse of Madness'
2025-06-17 07:29:51,031 - recommendation_engine - INFO - Searching TMDB for movie: 'Dr. Strange: In the Multiverse of Madness' (original: 'Доктор Стрэндж: В мультивселенной безумия')
2025-06-17 07:29:51,365 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Dr. Strange: In the Multiverse of Madness'.
2025-06-17 07:29:51,674 - tmdb_agent - INFO - Получены детали для фильма 'Доктор Стрэндж: В мультивселенной безумия' (TMDB ID: 453395).
2025-06-17 07:29:51,674 - tmdb_agent - INFO - Фильм 'Доктор Стрэндж: В мультивселенной безумия' обогащен данными.
2025-06-17 07:29:51,674 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:29:52,605 - agents.translator - WARNING - LLM returned invalid language code: 'The language of the text appears to be English. ISO 639-1 code is 'en'.' for text 'Doctor Strange in the Multiverse of Madness...' after cleaning: 'The language of the text appears to be English. ISO 639-1 code is 'en'.'
2025-06-17 07:29:52,606 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:29:56,848 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Доктор Стрэндж: В мультивселенной безумия'. Ratio: 1.00
2025-06-17 07:29:56,853 - movie_database - INFO - Фильм 'Доктор Стрэндж: В мультивселенной безумия' (TMDB ID: 453395) добавлен/обновлен в базу данных.
2025-06-17 07:29:56,853 - recommendation_engine - INFO - Added movie 'Доктор Стрэндж: В мультивселенной безумия' to DB as ID 21
2025-06-17 07:29:56,855 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=21, action_type='recommendation'.
2025-06-17 07:29:56,855 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 21
2025-06-17 07:29:56,856 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:29:58,282 - recommendation_engine - INFO - Translated Russian title 'Аватар: Путь воды' to English for TMDB search: 'Avatar: The Path of Water'
2025-06-17 07:29:58,282 - recommendation_engine - INFO - Searching TMDB for movie: 'Avatar: The Path of Water' (original: 'Аватар: Путь воды')
2025-06-17 07:29:58,539 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Avatar: The Path of Water'.
2025-06-17 07:29:58,539 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Avatar: The Path of Water'.
2025-06-17 07:29:58,540 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Avatar: The Path of Water' (original: 'Аватар: Путь воды'). Skipping.
2025-06-17 07:29:58,540 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:29:59,350 - recommendation_engine - INFO - Translated Russian title 'Интерстелляр' to English for TMDB search: 'Interstellar'
2025-06-17 07:29:59,350 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстелляр')
2025-06-17 07:29:59,489 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:29:59,779 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:29:59,780 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:29:59,780 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:30:03,481 - agents.translator - WARNING - LLM returned invalid language code: 'The language of the text "Interstellar" is not specified, as it is a movie title and doesn't contain any language content. However, if we're assuming that the context is English (as it's the original language of the movie), the ISO 639-1 code would be 'en'. But it's important to note that this is an assumption based on the context, as the text itself doesn't provide a clear language indication.' for text 'Interstellar...' after cleaning: 'The language of the text Interstellar is not specified, as it is a movie title and doesn't contain any language content. However, if we're assuming that the context is English , the ISO 639-1 code would be 'en'. But it's important to note that this is an assumption based on the context, as the text itself doesn't provide a clear language indication.'
2025-06-17 07:30:03,481 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:30:04,717 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 0.92
2025-06-17 07:30:04,718 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:30:04,721 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:30:04,721 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:30:04,721 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Доктор Стрэндж: В мультивселенной безумия** (2022)...'
2025-06-17 07:30:08,117 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:30:33,013 - handlers - INFO - Запрос от пользователя 577976124: армянский триллер
2025-06-17 07:30:34,673 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'армянский триллер'
2025-06-17 07:30:34,674 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:30:35,881 - agents.translator - WARNING - LLM returned invalid language code: '"arm" (Armenian)' for text 'армянский триллер...' after cleaning: 'arm'
2025-06-17 07:30:35,882 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'армянский триллер...'
2025-06-17 07:30:37,683 - recommendation_engine - INFO - LLM candidate response: "Чёрный овца" (2016), "Отступники" (2018), "Шпион, который меня любил" (2021), "800 блюд" (2012), "Форт Маккензи" (2018)
2025-06-17 07:30:37,685 - recommendation_engine - INFO - Extracted initial candidate titles: [('Чёрный овца', 2016), ('Отступники', 2018), ('Шпион, который меня любил', 2021), ('800 блюд', 2012), ('Форт Маккензи', 2018), ('"Чёрный овца"', 2016), ('"Отступники"', 2018), ('который меня любил"', 2021), ('"800 блюд"', 2012), ('"Форт Маккензи"', 2018)]
2025-06-17 07:30:37,685 - recommendation_engine - INFO - Searching TMDB for movie: 'Чёрный овца' (original: 'Чёрный овца')
2025-06-17 07:30:38,008 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Чёрный овца'.
2025-06-17 07:30:38,299 - tmdb_agent - INFO - Получены детали для фильма 'Варг Веум - Черная овца' (TMDB ID: 55612).
2025-06-17 07:30:38,300 - tmdb_agent - INFO - Фильм 'Варг Веум - Черная овца' обогащен данными.
2025-06-17 07:30:38,300 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:30:40,750 - agents.translator - WARNING - LLM returned invalid language code: 'The language of the provided text is 'nb', which stands for Norwegian Bokmål according to ISO 639-1.' for text 'Varg Veum - Svarte får...' after cleaning: 'The language of the provided text is 'nb', which stands for Norwegian Bokmål according to ISO 639-1.'
2025-06-17 07:30:40,751 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:30:43,410 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Варг Веум - Черная овца'. Ratio: 0.50
2025-06-17 07:30:43,413 - movie_database - INFO - Фильм 'Варг Веум - Черная овца' (TMDB ID: 55612) добавлен/обновлен в базу данных.
2025-06-17 07:30:43,413 - recommendation_engine - INFO - Added movie 'Варг Веум - Черная овца' to DB as ID 22
2025-06-17 07:30:43,415 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=22, action_type='recommendation'.
2025-06-17 07:30:43,415 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 22
2025-06-17 07:30:43,415 - recommendation_engine - INFO - Searching TMDB for movie: 'Отступники' (original: 'Отступники')
2025-06-17 07:30:43,840 - tmdb_agent - INFO - Найдено 8 фильмов для запроса 'Отступники'.
2025-06-17 07:30:44,459 - tmdb_agent - INFO - Получены детали для фильма 'Отступники' (TMDB ID: 1422).
2025-06-17 07:30:44,459 - tmdb_agent - INFO - Фильм 'Отступники' обогащен данными.
2025-06-17 07:30:44,460 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:30:48,301 - agents.translator - WARNING - LLM returned invalid language code: 'The language of the text "The Departed" cannot be determined from the provided title alone as it is a movie title and does not necessarily indicate the language in which it was produced. English is a common language used for movie titles, but it is not definitive.' for text 'The Departed...' after cleaning: 'The language of the text The Departed cannot be determined from the provided title alone as it is a movie title and does not necessarily indicate the language in which it was produced. English is a common language used for movie titles, but it is not definitive.'
2025-06-17 07:30:48,302 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:30:50,093 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Отступники'. Ratio: 1.00
2025-06-17 07:30:50,107 - movie_database - INFO - Фильм 'Отступники' (TMDB ID: 1422) добавлен/обновлен в базу данных.
2025-06-17 07:30:50,107 - recommendation_engine - INFO - Added movie 'Отступники' to DB as ID 23
2025-06-17 07:30:50,120 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=23, action_type='recommendation'.
2025-06-17 07:30:50,120 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 23
2025-06-17 07:30:50,120 - recommendation_engine - INFO - Searching TMDB for movie: 'Шпион, который меня любил' (original: 'Шпион, который меня любил')
2025-06-17 07:30:50,547 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Шпион, который меня любил'.
2025-06-17 07:30:50,842 - tmdb_agent - INFO - Получены детали для фильма '007: Шпион, который меня любил' (TMDB ID: 691).
2025-06-17 07:30:50,843 - tmdb_agent - INFO - Фильм '007: Шпион, который меня любил' обогащен данными.
2025-06-17 07:30:50,843 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:30:52,218 - agents.translator - WARNING - LLM returned invalid language code: 'The provided text is a title of a movie, not actual text in a language. Therefore, it doesn't contain any language data to be extracted.' for text 'The Spy Who Loved Me...' after cleaning: 'The provided text is a title of a movie, not actual text in a language. Therefore, it doesn't contain any language data to be extracted.'
2025-06-17 07:30:52,219 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:30:54,250 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for '007: Шпион, который меня любил'. Ratio: 0.92
2025-06-17 07:30:54,253 - movie_database - INFO - Фильм '007: Шпион, который меня любил' (TMDB ID: 691) добавлен/обновлен в базу данных.
2025-06-17 07:30:54,253 - recommendation_engine - INFO - Added movie '007: Шпион, который меня любил' to DB as ID 24
2025-06-17 07:30:54,255 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=24, action_type='recommendation'.
2025-06-17 07:30:54,255 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 24
2025-06-17 07:30:54,255 - recommendation_engine - INFO - Searching TMDB for movie: '800 блюд' (original: '800 блюд')
2025-06-17 07:30:54,559 - tmdb_agent - INFO - Найдено 0 фильмов для запроса '800 блюд'.
2025-06-17 07:30:54,559 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: '800 блюд'.
2025-06-17 07:30:54,559 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: '800 блюд' (original: '800 блюд'). Skipping.
2025-06-17 07:30:54,560 - recommendation_engine - INFO - Searching TMDB for movie: 'Форт Маккензи' (original: 'Форт Маккензи')
2025-06-17 07:30:54,862 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Форт Маккензи'.
2025-06-17 07:30:54,863 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Форт Маккензи'.
2025-06-17 07:30:54,863 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Форт Маккензи' (original: 'Форт Маккензи'). Skipping.
2025-06-17 07:30:54,863 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Варг Веум \- Черная овца** (2011), **Отступники** ...'
2025-06-17 07:31:01,132 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:31:25,534 - handlers - INFO - Запрос от пользователя 577976124: ала
2025-06-17 07:31:25,839 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'ала'
2025-06-17 07:31:25,840 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:31:27,093 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'ала...'
2025-06-17 07:31:30,678 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "Тёмный рыцарь" (2008), "Интерстеллар" (2014), "Игра престолов: Финал" (2019), "Доктор Стрэндж в мультивселенной безумия" (2016)
2025-06-17 07:31:30,679 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Тёмный рыцарь', 2008), ('Интерстеллар', 2014), ('Игра престолов: Финал', 2019), ('Доктор Стрэндж в мультивселенной безумия', 2016), ('"Инception"', 2010), ('"Тёмный рыцарь"', 2008), ('"Интерстеллар"', 2014), ('"Игра престолов: Финал"', 2019), ('"Доктор Стрэндж в мультивселенной безумия"', 2016)]
2025-06-17 07:31:30,680 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:31:32,241 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 07:31:32,242 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 07:31:32,715 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:31:33,051 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:31:33,051 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:31:33,051 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:31:34,174 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:31:36,899 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'восприятие i hope this helps let me know if you need more translations if you liked this answer and found it helpful please consider upvoting and accepting it as the correct answer this helps other users find the answers they need quickly and easily if you have any questions or need further help feel free to ask im here to help best regards ai assistant'): 0.01
2025-06-17 07:31:36,900 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'ала...' or LLM suggestion. Skipping.
2025-06-17 07:31:36,900 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:31:38,492 - recommendation_engine - INFO - Translated Russian title 'Тёмный рыцарь' to English for TMDB search: 'Dark Knight'
2025-06-17 07:31:38,493 - recommendation_engine - INFO - Searching TMDB for movie: 'Dark Knight' (original: 'Тёмный рыцарь')
2025-06-17 07:31:38,789 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Dark Knight'.
2025-06-17 07:31:39,194 - tmdb_agent - INFO - Получены детали для фильма 'Тёмный рыцарь' (TMDB ID: 155).
2025-06-17 07:31:39,195 - tmdb_agent - INFO - Фильм 'Тёмный рыцарь' обогащен данными.
2025-06-17 07:31:39,195 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:31:40,657 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:31:42,270 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Тёмный рыцарь'. Ratio: 1.00
2025-06-17 07:31:42,273 - movie_database - INFO - Фильм 'Тёмный рыцарь' (TMDB ID: 155) добавлен/обновлен в базу данных.
2025-06-17 07:31:42,273 - recommendation_engine - INFO - Added movie 'Тёмный рыцарь' to DB as ID 25
2025-06-17 07:31:42,274 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=25, action_type='recommendation'.
2025-06-17 07:31:42,274 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 25
2025-06-17 07:31:42,275 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:31:43,856 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:31:43,857 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:31:44,046 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:31:44,349 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:31:44,350 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:31:44,350 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:31:46,129 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:31:48,045 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:31:48,046 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:31:48,046 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:31:48,047 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:31:48,047 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:31:49,783 - recommendation_engine - INFO - Translated Russian title 'Игра престолов: Финал' to English for TMDB search: 'Game of Thrones: Finale'
2025-06-17 07:31:49,784 - recommendation_engine - INFO - Searching TMDB for movie: 'Game of Thrones: Finale' (original: 'Игра престолов: Финал')
2025-06-17 07:31:50,007 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Game of Thrones: Finale'.
2025-06-17 07:31:50,007 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Game of Thrones: Finale'.
2025-06-17 07:31:50,008 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Game of Thrones: Finale' (original: 'Игра престолов: Финал'). Skipping.
2025-06-17 07:31:50,008 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:31:51,975 - recommendation_engine - INFO - Translated Russian title 'Доктор Стрэндж в мультивселенной безумия' to English for TMDB search: 'Doctor Strange in the Multiverse of Madness'
2025-06-17 07:31:51,975 - recommendation_engine - INFO - Searching TMDB for movie: 'Doctor Strange in the Multiverse of Madness' (original: 'Доктор Стрэндж в мультивселенной безумия')
2025-06-17 07:31:52,267 - tmdb_agent - INFO - Найдено 2 фильмов для запроса 'Doctor Strange in the Multiverse of Madness'.
2025-06-17 07:31:52,542 - tmdb_agent - INFO - Получены детали для фильма 'Доктор Стрэндж: В мультивселенной безумия' (TMDB ID: 453395).
2025-06-17 07:31:52,543 - tmdb_agent - INFO - Фильм 'Доктор Стрэндж: В мультивселенной безумия' обогащен данными.
2025-06-17 07:31:52,543 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:31:54,552 - agents.translator - WARNING - LLM returned invalid language code: 'The language code for the provided title is 'en' (English). This is based on the fact that the movie title is in English. However, it's important to note that movie titles can be translated and released in different languages. The version presented here is the original English title of the movie.' for text 'Doctor Strange in the Multiverse of Madness...' after cleaning: 'The language code for the provided title is 'en' . This is based on the fact that the movie title is in English. However, it's important to note that movie titles can be translated and released in different languages. The version presented here is the original English title of the movie.'
2025-06-17 07:31:54,553 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:31:57,074 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Доктор Стрэндж: В мультивселенной безумия'. Ratio: 1.00
2025-06-17 07:31:57,079 - recommendation_engine - INFO - Movie 'Доктор Стрэндж: В мультивселенной безумия' already in DB as ID 21
2025-06-17 07:31:57,083 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=21, action_type='recommendation'.
2025-06-17 07:31:57,083 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 21
2025-06-17 07:31:57,084 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Тёмный рыцарь** (2008), **Интерстеллар** (2014), *...'
2025-06-17 07:32:04,603 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:32:46,096 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 182, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 177, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:33:22,701 - main - INFO - Начало инициализации бота...
2025-06-17 07:33:22,703 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:33:22,703 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:33:22,704 - agents.genre_mapper - INFO - Loaded 18 unique genres from database.
2025-06-17 07:33:22,704 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:33:22,738 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:33:30,578 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:33:30,583 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:33:40,798 - handlers - INFO - Запрос от пользователя 577976124: человек-паук
2025-06-17 07:33:41,212 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'человек-паук'
2025-06-17 07:33:41,213 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:33:42,503 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'человек-паук...'
2025-06-17 07:33:44,315 - recommendation_engine - INFO - LLM candidate response: Человек-паук (2002), Человек-паук 2 (2004), Человек-паук 3: Враг в отражении (2007), Человек-паук: Нет пути домой (2014), Человек-паук: Дом с удивительными секретами (2019).
2025-06-17 07:33:44,316 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук', 2002), ('Человек-паук 2', 2004), ('Человек-паук 3: Враг в отражении', 2007), ('Человек-паук: Нет пути домой', 2014), ('Человек-паук: Дом с удивительными секретами', 2019)]
2025-06-17 07:33:44,316 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:33:45,307 - recommendation_engine - INFO - Translated Russian title 'Человек-паук' to English for TMDB search: 'Spider-Man'
2025-06-17 07:33:45,307 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man' (original: 'Человек-паук')
2025-06-17 07:33:45,661 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Spider-Man'.
2025-06-17 07:33:45,924 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук' (TMDB ID: 557).
2025-06-17 07:33:45,924 - tmdb_agent - INFO - Фильм 'Человек-паук' обогащен данными.
2025-06-17 07:33:45,925 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:33:47,611 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:33:49,598 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук'. Ratio: 1.00
2025-06-17 07:33:49,600 - recommendation_engine - INFO - Movie 'Человек-паук' already in DB as ID 4
2025-06-17 07:33:49,602 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=4, action_type='recommendation'.
2025-06-17 07:33:49,602 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 4
2025-06-17 07:33:49,602 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:33:50,609 - recommendation_engine - INFO - Translated Russian title 'Человек-паук 2' to English for TMDB search: 'Spider-Man 2'
2025-06-17 07:33:50,609 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man 2' (original: 'Человек-паук 2')
2025-06-17 07:33:50,914 - tmdb_agent - INFO - Найдено 13 фильмов для запроса 'Spider-Man 2'.
2025-06-17 07:33:51,485 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук 2' (TMDB ID: 558).
2025-06-17 07:33:51,486 - tmdb_agent - INFO - Фильм 'Человек-паук 2' обогащен данными.
2025-06-17 07:33:51,486 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:33:52,604 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:33:54,219 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук 2'. Ratio: 1.00
2025-06-17 07:33:54,220 - recommendation_engine - INFO - Movie 'Человек-паук 2' already in DB as ID 17
2025-06-17 07:33:54,222 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=17, action_type='recommendation'.
2025-06-17 07:33:54,222 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 17
2025-06-17 07:33:54,222 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:33:56,204 - recommendation_engine - INFO - Translated Russian title 'Человек-паук 3: Враг в отражении' to English for TMDB search: 'Spider-Man 3: Reflection of the Enemy'
2025-06-17 07:33:56,205 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man 3: Reflection of the Enemy' (original: 'Человек-паук 3: Враг в отражении')
2025-06-17 07:33:56,536 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man 3: Reflection of the Enemy'.
2025-06-17 07:33:56,537 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man 3: Reflection of the Enemy'.
2025-06-17 07:33:56,537 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man 3: Reflection of the Enemy' (original: 'Человек-паук 3: Враг в отражении'). Skipping.
2025-06-17 07:33:56,537 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:33:57,735 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Нет пути домой' to English for TMDB search: 'Spider-Man: No Way Home'
2025-06-17 07:33:57,736 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: No Way Home' (original: 'Человек-паук: Нет пути домой')
2025-06-17 07:33:58,109 - tmdb_agent - INFO - Найдено 2 фильмов для запроса 'Spider-Man: No Way Home'.
2025-06-17 07:33:58,700 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук: Нет пути домой' (TMDB ID: 634649).
2025-06-17 07:33:58,700 - tmdb_agent - INFO - Фильм 'Человек-паук: Нет пути домой' обогащен данными.
2025-06-17 07:33:58,701 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:34:00,366 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:34:02,242 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук: Нет пути домой'. Ratio: 1.00
2025-06-17 07:34:02,244 - recommendation_engine - INFO - Movie 'Человек-паук: Нет пути домой' already in DB as ID 6
2025-06-17 07:34:02,247 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=6, action_type='recommendation'.
2025-06-17 07:34:02,247 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 6
2025-06-17 07:34:02,247 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:34:04,289 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Дом с удивительными секретами' to English for TMDB search: 'Spider-Man: House of Amazing Secrets'
2025-06-17 07:34:04,289 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: House of Amazing Secrets' (original: 'Человек-паук: Дом с удивительными секретами')
2025-06-17 07:34:04,583 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man: House of Amazing Secrets'.
2025-06-17 07:34:04,584 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man: House of Amazing Secrets'.
2025-06-17 07:34:04,584 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: House of Amazing Secrets' (original: 'Человек-паук: Дом с удивительными секретами'). Skipping.
2025-06-17 07:34:04,584 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Человек\-паук** (2002), **Человек\-паук 2** (2004)...'
2025-06-17 07:34:09,132 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:34:18,599 - formatter - INFO - Сформированы детали фильма для Telegram: Spider-Man
2025-06-17 07:34:18,718 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 4.
2025-06-17 07:34:21,257 - formatter - INFO - Сформированы детали фильма для Telegram: Человек-паук 2
2025-06-17 07:34:21,382 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 17.
2025-06-17 07:34:23,760 - formatter - INFO - Сформированы детали фильма для Telegram: Spider-Man: No Way Home
2025-06-17 07:34:23,847 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 6.
2025-06-17 07:34:54,290 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=6, action_type='saved'.
2025-06-17 07:34:54,291 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:34:54,373 - callbacks - INFO - Фильм ID 6 сохранен пользователем 577976124.
2025-06-17 07:35:04,247 - handlers - INFO - Запрос от пользователя 577976124: преподаватель
2025-06-17 07:35:04,841 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'преподаватель'
2025-06-17 07:35:04,842 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:35:06,961 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'преподаватель...'
2025-06-17 07:35:08,315 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "Гранд Будапешт" (2014), "Интерстеллар" (2014), "Форма воды" (2017), "Человек-паук: Дом удачи" (2017)
2025-06-17 07:35:08,315 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Гранд Будапешт', 2014), ('Интерстеллар', 2014), ('Форма воды', 2017), ('Человек-паук: Дом удачи', 2017), ('"Инception"', 2010), ('"Гранд Будапешт"', 2014), ('"Интерстеллар"', 2014), ('"Форма воды"', 2017), ('"Человек-паук: Дом удачи"', 2017)]
2025-06-17 07:35:08,315 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:35:10,125 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 07:35:10,126 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 07:35:10,338 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:35:10,677 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:35:10,677 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:35:10,677 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:35:12,383 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:35:14,064 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'вознесение'): 0.11
2025-06-17 07:35:14,065 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'преподаватель...' or LLM suggestion. Skipping.
2025-06-17 07:35:14,065 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:35:14,819 - recommendation_engine - INFO - Translated Russian title 'Гранд Будапешт' to English for TMDB search: 'Grand Budapest'
2025-06-17 07:35:14,819 - recommendation_engine - INFO - Searching TMDB for movie: 'Grand Budapest' (original: 'Гранд Будапешт')
2025-06-17 07:35:15,185 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Grand Budapest'.
2025-06-17 07:35:15,499 - tmdb_agent - INFO - Получены детали для фильма 'Отель «Гранд Будапешт»' (TMDB ID: 120467).
2025-06-17 07:35:15,500 - tmdb_agent - INFO - Фильм 'Отель «Гранд Будапешт»' обогащен данными.
2025-06-17 07:35:15,500 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:35:17,323 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:35:19,282 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Отель «Гранд Будапешт»'. Ratio: 0.82
2025-06-17 07:35:19,285 - movie_database - INFO - Фильм 'Отель «Гранд Будапешт»' (TMDB ID: 120467) добавлен/обновлен в базу данных.
2025-06-17 07:35:19,285 - recommendation_engine - INFO - Added movie 'Отель «Гранд Будапешт»' to DB as ID 26
2025-06-17 07:35:19,286 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=26, action_type='recommendation'.
2025-06-17 07:35:19,286 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 26
2025-06-17 07:35:19,287 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:35:21,310 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:35:21,311 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:35:21,492 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:35:21,756 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:35:21,757 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:35:21,757 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:35:22,954 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:35:24,563 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:35:24,563 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:35:24,564 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:35:24,565 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:35:24,565 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:35:25,388 - recommendation_engine - INFO - Translated Russian title 'Форма воды' to English for TMDB search: 'Form of water'
2025-06-17 07:35:25,389 - recommendation_engine - INFO - Searching TMDB for movie: 'Form of water' (original: 'Форма воды')
2025-06-17 07:35:25,680 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Form of water'.
2025-06-17 07:35:25,680 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Form of water'.
2025-06-17 07:35:25,680 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Form of water' (original: 'Форма воды'). Skipping.
2025-06-17 07:35:25,680 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:35:27,596 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Дом удачи' to English for TMDB search: 'Man-Spider: House of Luck'
2025-06-17 07:35:27,597 - recommendation_engine - INFO - Searching TMDB for movie: 'Man-Spider: House of Luck' (original: 'Человек-паук: Дом удачи')
2025-06-17 07:35:27,916 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Man-Spider: House of Luck'.
2025-06-17 07:35:27,916 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Man-Spider: House of Luck'.
2025-06-17 07:35:27,917 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Man-Spider: House of Luck' (original: 'Человек-паук: Дом удачи'). Skipping.
2025-06-17 07:35:27,917 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Отель «Гранд Будапешт»** (2014), **Интерстеллар** ...'
2025-06-17 07:35:37,746 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:36:14,312 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 182, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 177, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:38:18,217 - main - INFO - Начало инициализации бота...
2025-06-17 07:38:18,220 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:38:18,220 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:38:18,220 - agents.genre_mapper - INFO - Loaded 18 unique genres from database.
2025-06-17 07:38:18,221 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:38:18,241 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:38:21,511 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:38:21,512 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:38:27,632 - callbacks - INFO - Запрос от пользователя 577976124: человек паук
2025-06-17 07:38:27,943 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'человек паук'
2025-06-17 07:38:27,944 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:38:29,032 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'человек паук...'
2025-06-17 07:38:34,297 - recommendation_engine - INFO - LLM candidate response: Человек-паук: Homecoming (2017), Человек-паук: Новой Век (2019), Человек-паук: Далёкий универсал (2021), Человек-паук 3: Ночной охотник (2021), Человек-паук: Вдали от дома (2012)
2025-06-17 07:38:34,298 - recommendation_engine - INFO - Extracted initial candidate titles: [('Человек-паук: Homecoming', 2017), ('Человек-паук: Новой Век', 2019), ('Человек-паук: Далёкий универсал', 2021), ('Человек-паук 3: Ночной охотник', 2021), ('Человек-паук: Вдали от дома', 2012)]
2025-06-17 07:38:34,298 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:38:35,924 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Homecoming' to English for TMDB search: 'Spider-Man: Homecoming'
2025-06-17 07:38:35,924 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: Homecoming' (original: 'Человек-паук: Homecoming')
2025-06-17 07:38:36,446 - tmdb_agent - INFO - Найдено 2 фильмов для запроса 'Spider-Man: Homecoming'.
2025-06-17 07:38:37,069 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук: Возвращение домой' (TMDB ID: 315635).
2025-06-17 07:38:37,069 - tmdb_agent - INFO - Фильм 'Человек-паук: Возвращение домой' обогащен данными.
2025-06-17 07:38:37,070 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:38:38,544 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:38:41,960 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук: Возвращение домой'. Ratio: 0.47
2025-06-17 07:38:41,962 - recommendation_engine - INFO - Movie 'Человек-паук: Возвращение домой' already in DB as ID 7
2025-06-17 07:38:41,965 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=7, action_type='recommendation'.
2025-06-17 07:38:41,965 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 7
2025-06-17 07:38:41,965 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:38:43,063 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Новой Век' to English for TMDB search: 'Spider-Man: One More Day'
2025-06-17 07:38:43,063 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: One More Day' (original: 'Человек-паук: Новой Век')
2025-06-17 07:38:43,558 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man: One More Day'.
2025-06-17 07:38:43,559 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man: One More Day'.
2025-06-17 07:38:43,559 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man: One More Day' (original: 'Человек-паук: Новой Век'). Skipping.
2025-06-17 07:38:43,559 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:38:45,398 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Далёкий универсал' to English for TMDB search: 'Human-Spider: Far Universal'
2025-06-17 07:38:45,400 - recommendation_engine - INFO - Searching TMDB for movie: 'Human-Spider: Far Universal' (original: 'Человек-паук: Далёкий универсал')
2025-06-17 07:38:45,766 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Human-Spider: Far Universal'.
2025-06-17 07:38:45,767 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Human-Spider: Far Universal'.
2025-06-17 07:38:45,767 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Human-Spider: Far Universal' (original: 'Человек-паук: Далёкий универсал'). Skipping.
2025-06-17 07:38:45,767 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:38:46,978 - recommendation_engine - INFO - Translated Russian title 'Человек-паук 3: Ночной охотник' to English for TMDB search: 'Spider-Man 3: Night Hunter'
2025-06-17 07:38:46,979 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man 3: Night Hunter' (original: 'Человек-паук 3: Ночной охотник')
2025-06-17 07:38:47,277 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Spider-Man 3: Night Hunter'.
2025-06-17 07:38:47,279 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Spider-Man 3: Night Hunter'.
2025-06-17 07:38:47,279 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Spider-Man 3: Night Hunter' (original: 'Человек-паук 3: Ночной охотник'). Skipping.
2025-06-17 07:38:47,279 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:38:48,510 - recommendation_engine - INFO - Translated Russian title 'Человек-паук: Вдали от дома' to English for TMDB search: 'Spider-Man: Far from Home'
2025-06-17 07:38:48,511 - recommendation_engine - INFO - Searching TMDB for movie: 'Spider-Man: Far from Home' (original: 'Человек-паук: Вдали от дома')
2025-06-17 07:38:48,801 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Spider-Man: Far from Home'.
2025-06-17 07:38:49,145 - tmdb_agent - INFO - Получены детали для фильма 'Человек-паук: Вдали от дома' (TMDB ID: 429617).
2025-06-17 07:38:49,145 - tmdb_agent - INFO - Фильм 'Человек-паук: Вдали от дома' обогащен данными.
2025-06-17 07:38:49,145 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:38:50,915 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:38:53,303 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Человек-паук: Вдали от дома'. Ratio: 1.00
2025-06-17 07:38:53,304 - recommendation_engine - INFO - Movie 'Человек-паук: Вдали от дома' already in DB as ID 5
2025-06-17 07:38:53,307 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=5, action_type='recommendation'.
2025-06-17 07:38:53,308 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 5
2025-06-17 07:38:53,308 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Человек\-паук: Возвращение домой** (2017), **Челов...'
2025-06-17 07:39:00,471 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:39:24,890 - callbacks - INFO - Запрос от пользователя 577976124: кал калом
2025-06-17 07:39:25,229 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'кал калом'
2025-06-17 07:39:25,229 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:39:26,016 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'кал калом...'
2025-06-17 07:39:28,774 - recommendation_engine - INFO - LLM candidate response: "Господин Никто" (2004), "Хороший, плохой, злой" (2006), "Тайна Келей" (2014), "Интерстеллар" (2014), "С陳βANG: Удача клином" (2019)
2025-06-17 07:39:28,776 - recommendation_engine - INFO - Extracted initial candidate titles: [('Господин Никто', 2004), ('Хороший, плохой, злой', 2006), ('Тайна Келей', 2014), ('Интерстеллар', 2014), ('С陳βANG: Удача клином', 2019), ('"Господин Никто"', 2004), ('злой"', 2006), ('"Тайна Келей"', 2014), ('"Интерстеллар"', 2014), ('"С陳βANG: Удача клином"', 2019)]
2025-06-17 07:39:28,776 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:39:29,836 - recommendation_engine - INFO - Translated Russian title 'Господин Никто' to English for TMDB search: 'Mr. Nobody'
2025-06-17 07:39:29,837 - recommendation_engine - INFO - Searching TMDB for movie: 'Mr. Nobody' (original: 'Господин Никто')
2025-06-17 07:39:30,133 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Mr. Nobody'.
2025-06-17 07:39:30,418 - tmdb_agent - INFO - Получены детали для фильма 'Господин Никто' (TMDB ID: 31011).
2025-06-17 07:39:30,419 - tmdb_agent - INFO - Фильм 'Господин Никто' обогащен данными.
2025-06-17 07:39:30,419 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:39:32,737 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:39:36,011 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Господин Никто'. Ratio: 1.00
2025-06-17 07:39:36,017 - movie_database - INFO - Фильм 'Господин Никто' (TMDB ID: 31011) добавлен/обновлен в базу данных.
2025-06-17 07:39:36,017 - recommendation_engine - INFO - Added movie 'Господин Никто' to DB as ID 27
2025-06-17 07:39:36,019 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=27, action_type='recommendation'.
2025-06-17 07:39:36,020 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 27
2025-06-17 07:39:36,020 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:39:36,777 - recommendation_engine - INFO - Translated Russian title 'Хороший, плохой, злой' to English for TMDB search: 'Good, bad, evil'
2025-06-17 07:39:36,777 - recommendation_engine - INFO - Searching TMDB for movie: 'Good, bad, evil' (original: 'Хороший, плохой, злой')
2025-06-17 07:39:37,073 - tmdb_agent - INFO - Найдено 3 фильмов для запроса 'Good, bad, evil'.
2025-06-17 07:39:37,393 - tmdb_agent - INFO - Получены детали для фильма 'Metalheads: The Good, the Bad, and the Evil' (TMDB ID: 50684).
2025-06-17 07:39:37,394 - tmdb_agent - INFO - Фильм 'Metalheads: The Good, the Bad, and the Evil' обогащен данными.
2025-06-17 07:39:37,394 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:39:39,155 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:39:41,456 - recommendation_engine - INFO - Fuzzy match found (LLM vs Translated Original TMDB) for 'Metalheads: The Good, the Bad, and the Evil'. Ratio: 0.52
2025-06-17 07:39:41,458 - movie_database - INFO - Фильм 'Metalheads: The Good, the Bad, and the Evil' (TMDB ID: 50684) добавлен/обновлен в базу данных.
2025-06-17 07:39:41,458 - recommendation_engine - INFO - Added movie 'Metalheads: The Good, the Bad, and the Evil' to DB as ID 28
2025-06-17 07:39:41,459 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=28, action_type='recommendation'.
2025-06-17 07:39:41,459 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 28
2025-06-17 07:39:41,459 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:39:43,293 - recommendation_engine - INFO - Translated Russian title 'Тайна Келей' to English for TMDB search: 'The Secret of Keley'
2025-06-17 07:39:43,294 - recommendation_engine - INFO - Searching TMDB for movie: 'The Secret of Keley' (original: 'Тайна Келей')
2025-06-17 07:39:43,576 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'The Secret of Keley'.
2025-06-17 07:39:43,576 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'The Secret of Keley'.
2025-06-17 07:39:43,577 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'The Secret of Keley' (original: 'Тайна Келей'). Skipping.
2025-06-17 07:39:43,577 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:39:44,941 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:39:44,942 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:39:45,274 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:39:45,486 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:39:45,486 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:39:45,486 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:39:47,170 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:39:50,621 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:39:50,621 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:39:50,622 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:39:50,622 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:39:50,622 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:39:52,389 - recommendation_engine - INFO - Translated Russian title 'С陳βANG: Удача клином' to English for TMDB search: 'Luck with a stylus'
2025-06-17 07:39:52,390 - recommendation_engine - INFO - Searching TMDB for movie: 'Luck with a stylus' (original: 'С陳βANG: Удача клином')
2025-06-17 07:39:52,698 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Luck with a stylus'.
2025-06-17 07:39:52,699 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Luck with a stylus'.
2025-06-17 07:39:52,699 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Luck with a stylus' (original: 'С陳βANG: Удача клином'). Skipping.
2025-06-17 07:39:52,699 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Господин Никто** (2009), **Metalheads: The Good, t...'
2025-06-17 07:40:03,644 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:40:03,930 - formatter - INFO - Сформированы детали фильма для Telegram: Spider-Man: Homecoming
2025-06-17 07:40:04,050 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 7.
2025-06-17 07:40:15,015 - formatter - INFO - Сформированы детали фильма для Telegram: Интерстеллар
2025-06-17 07:40:15,196 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 11.
2025-06-17 07:40:17,503 - formatter - INFO - Сформированы детали фильма для Telegram: Metalheads: The Good, the Bad, and the Evil
2025-06-17 07:40:17,604 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 28.
2025-06-17 07:40:21,546 - formatter - INFO - Сформированы детали фильма для Telegram: Господин Никто
2025-06-17 07:40:21,634 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 27.
2025-06-17 07:43:02,490 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 182, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 177, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:44:23,341 - main - INFO - Начало инициализации бота...
2025-06-17 07:44:23,345 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:44:23,345 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:44:23,349 - agents.genre_mapper - INFO - Loaded 18 unique genres from database.
2025-06-17 07:44:23,349 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:44:23,378 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:44:27,755 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:44:27,755 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:44:34,644 - callbacks - INFO - Запрос от пользователя 577976124: пипец
2025-06-17 07:44:34,892 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'пипец'
2025-06-17 07:44:34,893 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:44:36,608 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'пипец...'
2025-06-17 07:44:39,012 - recommendation_engine - INFO - LLM candidate response: Интерstellar (2014), Шпионский (2015), Звездные войны: Пробуждение силы (2015), Терминатор: Генезис (2015), Годзилла (2014).
2025-06-17 07:44:39,014 - recommendation_engine - INFO - Extracted initial candidate titles: [('Интерstellar', 2014), ('Шпионский', 2015), ('Звездные войны: Пробуждение силы', 2015), ('Терминатор: Генезис', 2015), ('Годзилла', 2014)]
2025-06-17 07:44:39,014 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:44:39,846 - recommendation_engine - INFO - Translated Russian title 'Интерstellar' to English for TMDB search: 'Interstellar'
2025-06-17 07:44:39,847 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерstellar')
2025-06-17 07:44:40,055 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:44:40,502 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:44:40,503 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:44:40,503 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:44:42,924 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:44:45,017 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 0.42
2025-06-17 07:44:45,018 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:44:45,021 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:44:45,021 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:44:45,021 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:44:46,156 - recommendation_engine - INFO - Translated Russian title 'Шпионский' to English for TMDB search: 'Spy'
2025-06-17 07:44:46,157 - recommendation_engine - INFO - Searching TMDB for movie: 'Spy' (original: 'Шпионский')
2025-06-17 07:44:46,754 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Spy'.
2025-06-17 07:44:47,195 - tmdb_agent - INFO - Получены детали для фильма 'Шпион' (TMDB ID: 238713).
2025-06-17 07:44:47,196 - tmdb_agent - INFO - Фильм 'Шпион' обогащен данными.
2025-06-17 07:44:47,196 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:44:48,904 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:44:49,662 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Шпион'. Ratio: 0.71
2025-06-17 07:44:49,663 - movie_database - INFO - Фильм 'Шпион' (TMDB ID: 238713) добавлен/обновлен в базу данных.
2025-06-17 07:44:49,664 - recommendation_engine - INFO - Added movie 'Шпион' to DB as ID 29
2025-06-17 07:44:49,665 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=29, action_type='recommendation'.
2025-06-17 07:44:49,665 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 29
2025-06-17 07:44:49,665 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:44:51,428 - recommendation_engine - INFO - Translated Russian title 'Звездные войны: Пробуждение силы' to English for TMDB search: 'Star Wars: The Force Awakens'
2025-06-17 07:44:51,428 - recommendation_engine - INFO - Searching TMDB for movie: 'Star Wars: The Force Awakens' (original: 'Звездные войны: Пробуждение силы')
2025-06-17 07:44:51,800 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Star Wars: The Force Awakens'.
2025-06-17 07:44:52,181 - tmdb_agent - INFO - Получены детали для фильма 'Звёздные войны: Эпизод 7 - Пробуждение силы' (TMDB ID: 140607).
2025-06-17 07:44:52,181 - tmdb_agent - INFO - Фильм 'Звёздные войны: Эпизод 7 - Пробуждение силы' обогащен данными.
2025-06-17 07:44:52,182 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:44:53,886 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:44:56,797 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Звёздные войны: Эпизод 7 - Пробуждение силы'. Ratio: 0.85
2025-06-17 07:44:56,798 - movie_database - INFO - Фильм 'Звёздные войны: Эпизод 7 - Пробуждение силы' (TMDB ID: 140607) добавлен/обновлен в базу данных.
2025-06-17 07:44:56,798 - recommendation_engine - INFO - Added movie 'Звёздные войны: Эпизод 7 - Пробуждение силы' to DB as ID 30
2025-06-17 07:44:56,798 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=30, action_type='recommendation'.
2025-06-17 07:44:56,799 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 30
2025-06-17 07:44:56,799 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:44:58,566 - recommendation_engine - INFO - Translated Russian title 'Терминатор: Генезис' to English for TMDB search: 'Terminator: Genisys'
2025-06-17 07:44:58,566 - recommendation_engine - INFO - Searching TMDB for movie: 'Terminator: Genisys' (original: 'Терминатор: Генезис')
2025-06-17 07:44:59,172 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Terminator: Genisys'.
2025-06-17 07:44:59,559 - tmdb_agent - INFO - Получены детали для фильма 'Терминатор: Генезис' (TMDB ID: 87101).
2025-06-17 07:44:59,559 - tmdb_agent - INFO - Фильм 'Терминатор: Генезис' обогащен данными.
2025-06-17 07:44:59,560 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:45:00,430 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:45:01,399 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Терминатор: Генезис'. Ratio: 1.00
2025-06-17 07:45:01,401 - movie_database - INFO - Фильм 'Терминатор: Генезис' (TMDB ID: 87101) добавлен/обновлен в базу данных.
2025-06-17 07:45:01,401 - recommendation_engine - INFO - Added movie 'Терминатор: Генезис' to DB as ID 31
2025-06-17 07:45:01,403 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=31, action_type='recommendation'.
2025-06-17 07:45:01,403 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 31
2025-06-17 07:45:01,403 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:45:02,286 - recommendation_engine - INFO - Translated Russian title 'Годзилла' to English for TMDB search: 'Godzilla'
2025-06-17 07:45:02,287 - recommendation_engine - INFO - Searching TMDB for movie: 'Godzilla' (original: 'Годзилла')
2025-06-17 07:45:02,620 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Godzilla'.
2025-06-17 07:45:03,136 - tmdb_agent - INFO - Получены детали для фильма 'Годзилла' (TMDB ID: 124905).
2025-06-17 07:45:03,137 - tmdb_agent - INFO - Фильм 'Годзилла' обогащен данными.
2025-06-17 07:45:03,137 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:45:05,101 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:45:06,669 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Годзилла'. Ratio: 1.00
2025-06-17 07:45:06,672 - movie_database - INFO - Фильм 'Годзилла' (TMDB ID: 124905) добавлен/обновлен в базу данных.
2025-06-17 07:45:06,672 - recommendation_engine - INFO - Added movie 'Годзилла' to DB as ID 32
2025-06-17 07:45:06,674 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=32, action_type='recommendation'.
2025-06-17 07:45:06,674 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 32
2025-06-17 07:45:06,675 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Интерстеллар** (2014), **Шпион** (2015), **Звёздны...'
2025-06-17 07:45:12,489 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:45:44,015 - callbacks - INFO - Запрос от пользователя 577976124: попкорн
2025-06-17 07:45:44,460 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'попкорн'
2025-06-17 07:45:44,461 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:45:46,016 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'попкорн...'
2025-06-17 07:45:48,639 - recommendation_engine - INFO - LLM candidate response: "Инception" (2010), "Бегущий по лезвию 2" (2017), "Тёмный рыцарь" (2008), "Игра престолов" (2011), "Шпионский джем" (2015)
2025-06-17 07:45:48,640 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Бегущий по лезвию 2', 2017), ('Тёмный рыцарь', 2008), ('Игра престолов', 2011), ('Шпионский джем', 2015), ('"Инception"', 2010), ('"Бегущий по лезвию 2"', 2017), ('"Тёмный рыцарь"', 2008), ('"Игра престолов"', 2011), ('"Шпионский джем"', 2015)]
2025-06-17 07:45:48,641 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:45:50,220 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 07:45:50,220 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 07:45:50,833 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 07:45:51,211 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 07:45:51,211 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 07:45:51,211 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:45:53,095 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:45:54,994 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'инсепсион'): 0.22
2025-06-17 07:45:54,995 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'попкорн...' or LLM suggestion. Skipping.
2025-06-17 07:45:54,995 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:45:56,248 - recommendation_engine - INFO - Translated Russian title 'Бегущий по лезвию 2' to English for TMDB search: 'Running along the edge 2'
2025-06-17 07:45:56,249 - recommendation_engine - INFO - Searching TMDB for movie: 'Running along the edge 2' (original: 'Бегущий по лезвию 2')
2025-06-17 07:45:56,553 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Running along the edge 2'.
2025-06-17 07:45:56,554 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Running along the edge 2'.
2025-06-17 07:45:56,554 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Running along the edge 2' (original: 'Бегущий по лезвию 2'). Skipping.
2025-06-17 07:45:56,554 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:45:57,326 - recommendation_engine - INFO - Translated Russian title 'Тёмный рыцарь' to English for TMDB search: 'Dark Knight'
2025-06-17 07:45:57,327 - recommendation_engine - INFO - Searching TMDB for movie: 'Dark Knight' (original: 'Тёмный рыцарь')
2025-06-17 07:45:57,511 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Dark Knight'.
2025-06-17 07:45:57,739 - tmdb_agent - INFO - Получены детали для фильма 'Тёмный рыцарь' (TMDB ID: 155).
2025-06-17 07:45:57,739 - tmdb_agent - INFO - Фильм 'Тёмный рыцарь' обогащен данными.
2025-06-17 07:45:57,740 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:45:59,517 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:46:01,119 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Тёмный рыцарь'. Ratio: 1.00
2025-06-17 07:46:01,121 - recommendation_engine - INFO - Movie 'Тёмный рыцарь' already in DB as ID 25
2025-06-17 07:46:01,124 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=25, action_type='recommendation'.
2025-06-17 07:46:01,124 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 25
2025-06-17 07:46:01,125 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:46:02,349 - recommendation_engine - INFO - Translated Russian title 'Игра престолов' to English for TMDB search: 'Game of Thrones'
2025-06-17 07:46:02,349 - recommendation_engine - INFO - Searching TMDB for movie: 'Game of Thrones' (original: 'Игра престолов')
2025-06-17 07:46:02,733 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Game of Thrones'.
2025-06-17 07:46:03,042 - tmdb_agent - INFO - Получены детали для фильма 'Игра престолов: Последний дозор' (TMDB ID: 591278).
2025-06-17 07:46:03,042 - tmdb_agent - INFO - Фильм 'Игра престолов: Последний дозор' обогащен данными.
2025-06-17 07:46:03,042 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:46:03,942 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:46:06,173 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Игра престолов: Последний дозор'. Ratio: 0.64
2025-06-17 07:46:06,181 - movie_database - INFO - Фильм 'Игра престолов: Последний дозор' (TMDB ID: 591278) добавлен/обновлен в базу данных.
2025-06-17 07:46:06,181 - recommendation_engine - INFO - Added movie 'Игра престолов: Последний дозор' to DB as ID 33
2025-06-17 07:46:06,186 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=33, action_type='recommendation'.
2025-06-17 07:46:06,186 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 33
2025-06-17 07:46:06,186 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:46:07,428 - recommendation_engine - INFO - Translated Russian title 'Шпионский джем' to English for TMDB search: 'Spy jam'
2025-06-17 07:46:07,429 - recommendation_engine - INFO - Searching TMDB for movie: 'Spy jam' (original: 'Шпионский джем')
2025-06-17 07:46:07,743 - tmdb_agent - INFO - Найдено 3 фильмов для запроса 'Spy jam'.
2025-06-17 07:46:08,092 - tmdb_agent - INFO - Получены детали для фильма 'Stalin's Super Spy' (TMDB ID: 1400195).
2025-06-17 07:46:08,092 - tmdb_agent - INFO - Фильм 'Stalin's Super Spy' обогащен данными.
2025-06-17 07:46:08,092 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:46:09,371 - recommendation_engine - INFO - No sufficient fuzzy match for 'Stalin's Super Spy'. Comparisons: LLM_vs_TMDB_Localized ('шпионский джем' vs 'stalins super spy'): 0.06
2025-06-17 07:46:09,373 - recommendation_engine - WARNING - Movie 'Stalin's Super Spy' deemed not relevant to original query: 'попкорн...' or LLM suggestion. Skipping.
2025-06-17 07:46:09,373 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Тёмный рыцарь** (2008), **Игра престолов: Последни...'
2025-06-17 07:46:13,610 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:48:02,247 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 182, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 177, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:52:13,029 - main - INFO - Начало инициализации бота...
2025-06-17 07:52:13,031 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:52:13,031 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:52:13,034 - agents.genre_mapper - INFO - Loaded 18 unique genres from database.
2025-06-17 07:52:13,034 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:52:13,058 - main - INFO - Бот запущен. Ожидаем входящие сообщения...
2025-06-17 07:52:20,788 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 07:52:20,790 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:52:22,797 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 07:52:26,505 - recommendation_engine - INFO - LLM candidate response: "Интерстеллар" (2014), "Гравити" (2013), "Мир Нейм" (2018), "Возвращение в будущее" (1985), "Логан" (2017).
2025-06-17 07:52:26,507 - recommendation_engine - INFO - Extracted initial candidate titles: [('Интерстеллар', 2014), ('Гравити', 2013), ('Мир Нейм', 2018), ('Возвращение в будущее', 1985), ('Логан', 2017), ('"Интерстеллар"', 2014), ('"Гравити"', 2013), ('"Мир Нейм"', 2018), ('"Возвращение в будущее"', 1985), ('"Логан"', 2017)]
2025-06-17 07:52:26,507 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:52:28,274 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:52:28,275 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:52:28,490 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:52:28,710 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:52:28,710 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:52:28,711 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:52:30,163 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:52:31,850 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:52:31,851 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:52:31,854 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:52:31,854 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:52:31,855 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:52:32,960 - recommendation_engine - INFO - Translated Russian title 'Гравити' to English for TMDB search: 'Gravity'
2025-06-17 07:52:32,961 - recommendation_engine - INFO - Searching TMDB for movie: 'Gravity' (original: 'Гравити')
2025-06-17 07:52:33,176 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Gravity'.
2025-06-17 07:52:33,415 - tmdb_agent - INFO - Получены детали для фильма 'Гравитация' (TMDB ID: 49047).
2025-06-17 07:52:33,416 - tmdb_agent - INFO - Фильм 'Гравитация' обогащен данными.
2025-06-17 07:52:33,416 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:52:34,901 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:52:36,160 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Гравитация'. Ratio: 0.82
2025-06-17 07:52:36,161 - recommendation_engine - INFO - Movie 'Гравитация' already in DB as ID 15
2025-06-17 07:52:36,163 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=15, action_type='recommendation'.
2025-06-17 07:52:36,164 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 15
2025-06-17 07:52:36,164 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:52:36,918 - recommendation_engine - INFO - Translated Russian title 'Мир Нейм' to English for TMDB search: 'World Name'
2025-06-17 07:52:36,919 - recommendation_engine - INFO - Searching TMDB for movie: 'World Name' (original: 'Мир Нейм')
2025-06-17 07:52:37,211 - tmdb_agent - INFO - Найдено 7 фильмов для запроса 'World Name'.
2025-06-17 07:52:37,586 - tmdb_agent - INFO - Получены детали для фильма 'Las Aves Cambiaron De Nombre Y El Mundo Se Convirtió De Hielo' (TMDB ID: 1036117).
2025-06-17 07:52:37,586 - tmdb_agent - INFO - Фильм 'Las Aves Cambiaron De Nombre Y El Mundo Se Convirtió De Hielo' обогащен данными.
2025-06-17 07:52:37,586 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:52:39,112 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:52:40,156 - recommendation_engine - INFO - No sufficient fuzzy match for 'Las Aves Cambiaron De Nombre Y El Mundo Se Convirtió De Hielo'. Comparisons: LLM_vs_TMDB_Localized ('мир нейм' vs 'las aves cambiaron de nombre y el mundo se convirtió de hielo'): 0.03; LLM_vs_TMDB_Original_Translated ('мир нейм' vs 'птицы изменили название и мир превратился в лед this translates to birds changed their name and the world turned into ice'): 0.08; User_vs_TMDB_Localized ('посоветуй чтонибудь интересное' vs 'las aves cambiaron de nombre y el mundo se convirtió de hielo'): 0.04; User_vs_TMDB_Original ('посоветуй чтонибудь интересное' vs 'las aves cambiaron de nombre y el mundo se convirtió de hielo'): 0.04; User_vs_TMDB_Original_Translated ('посоветуй чтонибудь интересное' vs 'птицы изменили название и мир превратился в лед this translates to birds changed their name and the world turned into ice'): 0.13
2025-06-17 07:52:40,156 - recommendation_engine - WARNING - Movie 'Las Aves Cambiaron De Nombre Y El Mundo Se Convirtió De Hielo' deemed not relevant to original query: 'посоветуй что-нибудь интересное...' or LLM suggestion. Skipping.
2025-06-17 07:52:40,156 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:52:47,108 - recommendation_engine - INFO - Translated Russian title 'Возвращение в будущее' to English for TMDB search: 'Time Travel

Russian: Этот роман описывает приключение группы молодых ученых, которые путешествуют во времени и пытаются изменить историю \nEnglish: This novel describes the adventure of a group of young scientists who travel through time and attempt to change history

Russian: В романе рассказывается о группе молодых ученых, которые создают машину времени и путешествуют в прошлое, чтобы спасти своего друга, который попал в плен к неизвестным врагам. \nEnglish: In the novel, a group of young scientists create a time machine and travel back in time to save their friend who has been captured by unknown enemies.

Russian: Ричард Дакинс, один из главных героев, является молодым и одаренным ученым, который пытается найти способ путешествовать во времени. \nEnglish: Richard Dackins, one of the main characters, is a young and gifted scientist who is trying to find a way to travel through time.

Russian: Он встречает группу ученых, которые уже успели создать машину времени, и присоединяется к ним в их путешествии во времени. \nEnglish: He meets a group of scientists who have already created a time machine, and joins them on their time travel adventure.

Russian: Группа путешествует во времени и посещает различные эпохи, в том числе Древний Египет, Римскую империю, Средневековую Европу, Американскую революцию, и даже будущее. \nEnglish: The group travels through time and visits various eras, including Ancient Egypt, the Roman Empire, Medieval Europe, the American Revolution, and even the future.

Russian: Они встречают различных исторических личностей и помогают изменить историю, но их действия имеют неожиданные последствия для будущего. \nEnglish: They meet various historical figures and help to change history, but their actions have unforeseen consequences for the future.

Russian: Роман написан в жанре научной фантастики и предлагает многие оригинальные идеи, связанные с путешествием во времени. \nEnglish: The novel is written in the genre of science fiction and offers many original ideas related to time travel.

Russian: Книга привлекательна своей интригующей сюжетной линией, оригинальными персонажами и проработанными деталями. \nEnglish: The book is appealing with its intriguing plot line, original characters, and well-developed details.

Russian: Я рекомендую эту книгу всем любителям научной фантастики и путешествий во времени. \nEnglish: I recommend this book to all lovers of science fiction and time travel.'
2025-06-17 07:52:47,109 - recommendation_engine - INFO - Searching TMDB for movie: 'Time Travel

Russian: Этот роман описывает приключение группы молодых ученых, которые путешествуют во времени и пытаются изменить историю \nEnglish: This novel describes the adventure of a group of young scientists who travel through time and attempt to change history

Russian: В романе рассказывается о группе молодых ученых, которые создают машину времени и путешествуют в прошлое, чтобы спасти своего друга, который попал в плен к неизвестным врагам. \nEnglish: In the novel, a group of young scientists create a time machine and travel back in time to save their friend who has been captured by unknown enemies.

Russian: Ричард Дакинс, один из главных героев, является молодым и одаренным ученым, который пытается найти способ путешествовать во времени. \nEnglish: Richard Dackins, one of the main characters, is a young and gifted scientist who is trying to find a way to travel through time.

Russian: Он встречает группу ученых, которые уже успели создать машину времени, и присоединяется к ним в их путешествии во времени. \nEnglish: He meets a group of scientists who have already created a time machine, and joins them on their time travel adventure.

Russian: Группа путешествует во времени и посещает различные эпохи, в том числе Древний Египет, Римскую империю, Средневековую Европу, Американскую революцию, и даже будущее. \nEnglish: The group travels through time and visits various eras, including Ancient Egypt, the Roman Empire, Medieval Europe, the American Revolution, and even the future.

Russian: Они встречают различных исторических личностей и помогают изменить историю, но их действия имеют неожиданные последствия для будущего. \nEnglish: They meet various historical figures and help to change history, but their actions have unforeseen consequences for the future.

Russian: Роман написан в жанре научной фантастики и предлагает многие оригинальные идеи, связанные с путешествием во времени. \nEnglish: The novel is written in the genre of science fiction and offers many original ideas related to time travel.

Russian: Книга привлекательна своей интригующей сюжетной линией, оригинальными персонажами и проработанными деталями. \nEnglish: The book is appealing with its intriguing plot line, original characters, and well-developed details.

Russian: Я рекомендую эту книгу всем любителям научной фантастики и путешествий во времени. \nEnglish: I recommend this book to all lovers of science fiction and time travel.' (original: 'Возвращение в будущее')
2025-06-17 07:52:47,323 - tmdb_agent - ERROR - TMDB HTTP error (attempt 1/3): 413 - <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>413 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Bad request.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: ix5IuJlpe_LyZNi0f8AxulQuV1e22wefB5vAnRkqq9WZkcwxSFwSug==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
2025-06-17 07:52:48,576 - tmdb_agent - ERROR - TMDB HTTP error (attempt 2/3): 413 - <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>413 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Bad request.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: KSBs3MtD93tKaoJRkL57JUdYdESfNQkiOjqKX59Z80R68ScXBEnrNA==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
2025-06-17 07:52:50,844 - tmdb_agent - ERROR - TMDB HTTP error (attempt 3/3): 413 - <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>413 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Bad request.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: jjwoanKCOR8F-yqbjJEpM4iI72p7ZIWuNQiDumdLepqn6nA4Es-JwA==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
2025-06-17 07:52:50,845 - tmdb_agent - ERROR - Failed to fetch data from TMDB after 3 attempts for endpoint: search/movie
2025-06-17 07:52:50,845 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Time Travel

Russian: Этот роман описывает приключение группы молодых ученых, которые путешествуют во времени и пытаются изменить историю \nEnglish: This novel describes the adventure of a group of young scientists who travel through time and attempt to change history

Russian: В романе рассказывается о группе молодых ученых, которые создают машину времени и путешествуют в прошлое, чтобы спасти своего друга, который попал в плен к неизвестным врагам. \nEnglish: In the novel, a group of young scientists create a time machine and travel back in time to save their friend who has been captured by unknown enemies.

Russian: Ричард Дакинс, один из главных героев, является молодым и одаренным ученым, который пытается найти способ путешествовать во времени. \nEnglish: Richard Dackins, one of the main characters, is a young and gifted scientist who is trying to find a way to travel through time.

Russian: Он встречает группу ученых, которые уже успели создать машину времени, и присоединяется к ним в их путешествии во времени. \nEnglish: He meets a group of scientists who have already created a time machine, and joins them on their time travel adventure.

Russian: Группа путешествует во времени и посещает различные эпохи, в том числе Древний Египет, Римскую империю, Средневековую Европу, Американскую революцию, и даже будущее. \nEnglish: The group travels through time and visits various eras, including Ancient Egypt, the Roman Empire, Medieval Europe, the American Revolution, and even the future.

Russian: Они встречают различных исторических личностей и помогают изменить историю, но их действия имеют неожиданные последствия для будущего. \nEnglish: They meet various historical figures and help to change history, but their actions have unforeseen consequences for the future.

Russian: Роман написан в жанре научной фантастики и предлагает многие оригинальные идеи, связанные с путешествием во времени. \nEnglish: The novel is written in the genre of science fiction and offers many original ideas related to time travel.

Russian: Книга привлекательна своей интригующей сюжетной линией, оригинальными персонажами и проработанными деталями. \nEnglish: The book is appealing with its intriguing plot line, original characters, and well-developed details.

Russian: Я рекомендую эту книгу всем любителям научной фантастики и путешествий во времени. \nEnglish: I recommend this book to all lovers of science fiction and time travel.'.
2025-06-17 07:52:50,845 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Time Travel

Russian: Этот роман описывает приключение группы молодых ученых, которые путешествуют во времени и пытаются изменить историю \nEnglish: This novel describes the adventure of a group of young scientists who travel through time and attempt to change history

Russian: В романе рассказывается о группе молодых ученых, которые создают машину времени и путешествуют в прошлое, чтобы спасти своего друга, который попал в плен к неизвестным врагам. \nEnglish: In the novel, a group of young scientists create a time machine and travel back in time to save their friend who has been captured by unknown enemies.

Russian: Ричард Дакинс, один из главных героев, является молодым и одаренным ученым, который пытается найти способ путешествовать во времени. \nEnglish: Richard Dackins, one of the main characters, is a young and gifted scientist who is trying to find a way to travel through time.

Russian: Он встречает группу ученых, которые уже успели создать машину времени, и присоединяется к ним в их путешествии во времени. \nEnglish: He meets a group of scientists who have already created a time machine, and joins them on their time travel adventure.

Russian: Группа путешествует во времени и посещает различные эпохи, в том числе Древний Египет, Римскую империю, Средневековую Европу, Американскую революцию, и даже будущее. \nEnglish: The group travels through time and visits various eras, including Ancient Egypt, the Roman Empire, Medieval Europe, the American Revolution, and even the future.

Russian: Они встречают различных исторических личностей и помогают изменить историю, но их действия имеют неожиданные последствия для будущего. \nEnglish: They meet various historical figures and help to change history, but their actions have unforeseen consequences for the future.

Russian: Роман написан в жанре научной фантастики и предлагает многие оригинальные идеи, связанные с путешествием во времени. \nEnglish: The novel is written in the genre of science fiction and offers many original ideas related to time travel.

Russian: Книга привлекательна своей интригующей сюжетной линией, оригинальными персонажами и проработанными деталями. \nEnglish: The book is appealing with its intriguing plot line, original characters, and well-developed details.

Russian: Я рекомендую эту книгу всем любителям научной фантастики и путешествий во времени. \nEnglish: I recommend this book to all lovers of science fiction and time travel.'.
2025-06-17 07:52:50,845 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Time Travel

Russian: Этот роман описывает приключение группы молодых ученых, которые путешествуют во времени и пытаются изменить историю \nEnglish: This novel describes the adventure of a group of young scientists who travel through time and attempt to change history

Russian: В романе рассказывается о группе молодых ученых, которые создают машину времени и путешествуют в прошлое, чтобы спасти своего друга, который попал в плен к неизвестным врагам. \nEnglish: In the novel, a group of young scientists create a time machine and travel back in time to save their friend who has been captured by unknown enemies.

Russian: Ричард Дакинс, один из главных героев, является молодым и одаренным ученым, который пытается найти способ путешествовать во времени. \nEnglish: Richard Dackins, one of the main characters, is a young and gifted scientist who is trying to find a way to travel through time.

Russian: Он встречает группу ученых, которые уже успели создать машину времени, и присоединяется к ним в их путешествии во времени. \nEnglish: He meets a group of scientists who have already created a time machine, and joins them on their time travel adventure.

Russian: Группа путешествует во времени и посещает различные эпохи, в том числе Древний Египет, Римскую империю, Средневековую Европу, Американскую революцию, и даже будущее. \nEnglish: The group travels through time and visits various eras, including Ancient Egypt, the Roman Empire, Medieval Europe, the American Revolution, and even the future.

Russian: Они встречают различных исторических личностей и помогают изменить историю, но их действия имеют неожиданные последствия для будущего. \nEnglish: They meet various historical figures and help to change history, but their actions have unforeseen consequences for the future.

Russian: Роман написан в жанре научной фантастики и предлагает многие оригинальные идеи, связанные с путешествием во времени. \nEnglish: The novel is written in the genre of science fiction and offers many original ideas related to time travel.

Russian: Книга привлекательна своей интригующей сюжетной линией, оригинальными персонажами и проработанными деталями. \nEnglish: The book is appealing with its intriguing plot line, original characters, and well-developed details.

Russian: Я рекомендую эту книгу всем любителям научной фантастики и путешествий во времени. \nEnglish: I recommend this book to all lovers of science fiction and time travel.' (original: 'Возвращение в будущее'). Skipping.
2025-06-17 07:52:50,845 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:52:53,114 - recommendation_engine - INFO - Translated Russian title 'Логан' to English for TMDB search: 'Logan'
2025-06-17 07:52:53,116 - recommendation_engine - INFO - Searching TMDB for movie: 'Logan' (original: 'Логан')
2025-06-17 07:52:53,304 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Logan'.
2025-06-17 07:52:53,531 - tmdb_agent - INFO - Получены детали для фильма 'Логан' (TMDB ID: 263115).
2025-06-17 07:52:53,531 - tmdb_agent - INFO - Фильм 'Логан' обогащен данными.
2025-06-17 07:52:53,531 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:52:56,204 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:52:57,312 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Логан'. Ratio: 1.00
2025-06-17 07:52:57,313 - recommendation_engine - INFO - Movie 'Логан' already in DB as ID 20
2025-06-17 07:52:57,317 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=20, action_type='recommendation'.
2025-06-17 07:52:57,317 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 20
2025-06-17 07:52:57,317 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Интерстеллар** (2014), **Гравитация** (2013), **Ло...'
2025-06-17 07:53:02,301 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:21,236 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=20, action_type='saved'.
2025-06-17 07:53:21,237 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:21,315 - callbacks - INFO - Фильм ID 20 сохранен пользователем 577976124.
2025-06-17 07:53:22,411 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=20, action_type='saved'.
2025-06-17 07:53:22,411 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:22,524 - callbacks - INFO - Фильм ID 20 сохранен пользователем 577976124.
2025-06-17 07:53:24,807 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:24,994 - callbacks - INFO - Достигнут конец списка рекомендаций для пользователя 577976124.
2025-06-17 07:53:27,517 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:27,599 - callbacks - INFO - Достигнут конец списка рекомендаций для пользователя 577976124.
2025-06-17 07:53:31,633 - formatter - INFO - Сформированы детали фильма для Telegram: Гравитация
2025-06-17 07:53:31,710 - callbacks - INFO - Пользователю 577976124 показан предыдущий фильм ID: 15.
2025-06-17 07:53:34,879 - formatter - INFO - Сформированы детали фильма для Telegram: Интерстеллар
2025-06-17 07:53:34,990 - callbacks - INFO - Пользователю 577976124 показан предыдущий фильм ID: 11.
2025-06-17 07:53:35,914 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:36,005 - callbacks - INFO - Достигнуто начало списка рекомендаций для пользователя 577976124.
2025-06-17 07:53:37,027 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:37,191 - callbacks - INFO - Достигнуто начало списка рекомендаций для пользователя 577976124.
2025-06-17 07:53:37,849 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:53:38,622 - callbacks - INFO - Достигнуто начало списка рекомендаций для пользователя 577976124.
2025-06-17 07:55:01,953 - main - ERROR - Ошибка при запуске бота: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 182, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 177, in main
    await app.run_polling(allowed_updates=Update.ALL_TYPES)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:57:25,114 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 07:57:25,117 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:57:25,117 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:57:25,117 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:57:25,139 - main - CRITICAL - Fatal error during bot startup: name 'collect_feedback' is not defined
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 179, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 129, in main
    MessageHandler(filters.TEXT & ~filters.COMMAND, collect_feedback)
                                                    ^^^^^^^^^^^^^^^^
NameError: name 'collect_feedback' is not defined
2025-06-17 07:58:20,910 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 07:58:20,915 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:58:20,915 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:58:20,915 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:58:20,953 - main - INFO - ✅ Бот успешно запущен. Ожидаем входящие сообщения...
2025-06-17 07:58:20,959 - main - CRITICAL - Fatal error during bot startup: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1006, in __run
    raise exc
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 995, in __run
    loop.run_until_complete(self.initialize())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1017, in __run
    loop.run_until_complete(self.shutdown())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 629, in run_until_complete
    self._check_running()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 588, in _check_running
    raise RuntimeError('This event loop is already running')
RuntimeError: This event loop is already running

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 180, in <module>
    asyncio.run(main())
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py", line 653, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 175, in main
    await app.run_polling(drop_pending_updates=True)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
2025-06-17 07:59:09,561 - main - INFO - 🚀 Запуск Telegram-бота...
2025-06-17 07:59:09,563 - movie_database - INFO - Все необходимые таблицы базы данных проверены/созданы.
2025-06-17 07:59:09,563 - movie_database - INFO - Соединение с базой данных data/movie_recommendations.db успешно установлено и таблицы проверены.
2025-06-17 07:59:09,564 - feedback_agent - INFO - Таблица 'feedback' успешно инициализирована в data/movie_feedback.db.
2025-06-17 07:59:09,587 - main - INFO - ✅ Бот успешно запущен. Ожидаем входящие сообщения...
2025-06-17 07:59:13,410 - movie_database - INFO - Пользователь GumGus (ID: 577976124) уже существует в базе данных.
2025-06-17 07:59:13,411 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 07:59:15,941 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'посоветуй что-нибудь интересное'
2025-06-17 07:59:15,943 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:59:17,880 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'посоветуй что-нибудь интересное...'
2025-06-17 07:59:20,251 - recommendation_engine - INFO - LLM candidate response: "Интерстеллар" (2014), "Бойцовский клуб" (1999), "Зловещие мертвецы" (2004), "Пираты Карибского моря: На краю света" (2007), "Война миров" (2005)
2025-06-17 07:59:20,253 - recommendation_engine - INFO - Extracted initial candidate titles: [('Интерстеллар', 2014), ('Бойцовский клуб', 1999), ('Зловещие мертвецы', 2004), ('Пираты Карибского моря: На краю света', 2007), ('Война миров', 2005), ('"Интерстеллар"', 2014), ('"Бойцовский клуб"', 1999), ('"Зловещие мертвецы"', 2004), ('"Пираты Карибского моря: На краю света"', 2007), ('"Война миров"', 2005)]
2025-06-17 07:59:20,253 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:59:22,349 - recommendation_engine - INFO - Translated Russian title 'Интерстеллар' to English for TMDB search: 'Interstellar'
2025-06-17 07:59:22,350 - recommendation_engine - INFO - Searching TMDB for movie: 'Interstellar' (original: 'Интерстеллар')
2025-06-17 07:59:23,120 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Interstellar'.
2025-06-17 07:59:23,800 - tmdb_agent - INFO - Получены детали для фильма 'Интерстеллар' (TMDB ID: 157336).
2025-06-17 07:59:23,800 - tmdb_agent - INFO - Фильм 'Интерстеллар' обогащен данными.
2025-06-17 07:59:23,800 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:59:26,844 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:59:29,125 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Интерстеллар'. Ratio: 1.00
2025-06-17 07:59:29,129 - recommendation_engine - INFO - Movie 'Интерстеллар' already in DB as ID 11
2025-06-17 07:59:29,149 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='recommendation'.
2025-06-17 07:59:29,149 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 11
2025-06-17 07:59:29,149 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:59:31,082 - recommendation_engine - INFO - Translated Russian title 'Бойцовский клуб' to English for TMDB search: 'Fighter's Club'
2025-06-17 07:59:31,082 - recommendation_engine - INFO - Searching TMDB for movie: 'Fighter's Club' (original: 'Бойцовский клуб')
2025-06-17 07:59:31,432 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Fighter's Club'.
2025-06-17 07:59:31,432 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Fighter's Club'.
2025-06-17 07:59:31,432 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Fighter's Club' (original: 'Бойцовский клуб'). Skipping.
2025-06-17 07:59:31,432 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:59:33,619 - recommendation_engine - INFO - Translated Russian title 'Зловещие мертвецы' to English for TMDB search: 'The Walking Dead'
2025-06-17 07:59:33,619 - recommendation_engine - INFO - Searching TMDB for movie: 'The Walking Dead' (original: 'Зловещие мертвецы')
2025-06-17 07:59:34,345 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'The Walking Dead'.
2025-06-17 07:59:34,675 - tmdb_agent - INFO - Получены детали для фильма 'Ходячий мертвец' (TMDB ID: 27115).
2025-06-17 07:59:34,676 - tmdb_agent - INFO - Фильм 'Ходячий мертвец' обогащен данными.
2025-06-17 07:59:34,676 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:59:36,655 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:59:40,175 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Ходячий мертвец'. Ratio: 0.62
2025-06-17 07:59:40,180 - movie_database - INFO - Фильм 'Ходячий мертвец' (TMDB ID: 27115) добавлен/обновлен в базу данных.
2025-06-17 07:59:40,180 - recommendation_engine - INFO - Added movie 'Ходячий мертвец' to DB as ID 34
2025-06-17 07:59:40,182 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=34, action_type='recommendation'.
2025-06-17 07:59:40,182 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 34
2025-06-17 07:59:40,183 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:59:42,698 - recommendation_engine - INFO - Translated Russian title 'Пираты Карибского моря: На краю света' to English for TMDB search: 'Pirates of the Caribbean: At World's End'
2025-06-17 07:59:42,698 - recommendation_engine - INFO - Searching TMDB for movie: 'Pirates of the Caribbean: At World's End' (original: 'Пираты Карибского моря: На краю света')
2025-06-17 07:59:43,279 - tmdb_agent - INFO - Найдено 1 фильмов для запроса 'Pirates of the Caribbean: At World's End'.
2025-06-17 07:59:43,968 - tmdb_agent - INFO - Получены детали для фильма 'Пираты Карибского моря: На краю света' (TMDB ID: 285).
2025-06-17 07:59:43,969 - tmdb_agent - INFO - Фильм 'Пираты Карибского моря: На краю света' обогащен данными.
2025-06-17 07:59:43,969 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:59:45,858 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:59:48,014 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Пираты Карибского моря: На краю света'. Ratio: 1.00
2025-06-17 07:59:48,015 - recommendation_engine - INFO - Movie 'Пираты Карибского моря: На краю света' already in DB as ID 14
2025-06-17 07:59:48,017 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=14, action_type='recommendation'.
2025-06-17 07:59:48,018 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 14
2025-06-17 07:59:48,018 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 07:59:50,172 - recommendation_engine - INFO - Translated Russian title 'Война миров' to English for TMDB search: 'War of the Worlds'
2025-06-17 07:59:50,173 - recommendation_engine - INFO - Searching TMDB for movie: 'War of the Worlds' (original: 'Война миров')
2025-06-17 07:59:51,134 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'War of the Worlds'.
2025-06-17 07:59:51,942 - tmdb_agent - INFO - Получены детали для фильма 'Война миров' (TMDB ID: 74).
2025-06-17 07:59:51,943 - tmdb_agent - INFO - Фильм 'Война миров' обогащен данными.
2025-06-17 07:59:51,943 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 07:59:53,721 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 07:59:54,752 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Война миров'. Ratio: 1.00
2025-06-17 07:59:54,755 - movie_database - INFO - Фильм 'Война миров' (TMDB ID: 74) добавлен/обновлен в базу данных.
2025-06-17 07:59:54,755 - recommendation_engine - INFO - Added movie 'Война миров' to DB as ID 35
2025-06-17 07:59:54,757 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=35, action_type='recommendation'.
2025-06-17 07:59:54,757 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 35
2025-06-17 07:59:54,757 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Интерстеллар** (2014), **Ходячий мертвец** (1936),...'
2025-06-17 08:00:05,529 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:00:10,642 - keyboards - INFO - Сформирована клавиатура оценки для фильма ID: 35 (0-10).
2025-06-17 08:00:10,764 - callbacks - WARNING - Ошибка при редактировании сообщения для выбора оценки для 577976124: There is no text in the message to edit. Отправка нового сообщения.
2025-06-17 08:00:13,618 - movie_database - INFO - Оценка 3 для фильма 35 от пользователя 577976124 добавлена/обновлена.
2025-06-17 08:00:13,619 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:00:13,801 - callbacks - INFO - Пользователь 577976124 оценил фильм ID 35 на 3.
2025-06-17 08:00:15,869 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Логан** (2017), **Логан** (2017), **Spider-Man: No Way Home** (2021...'
2025-06-17 08:00:21,489 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:00:26,541 - formatter - INFO - Сформированы детали фильма для Telegram: Интерстеллар
2025-06-17 08:00:26,847 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 11.
2025-06-17 08:00:28,692 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=11, action_type='saved'.
2025-06-17 08:00:28,693 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:00:28,781 - callbacks - INFO - Фильм ID 11 сохранен пользователем 577976124.
2025-06-17 08:00:37,472 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Интерстеллар** (2014), **Логан** (2017), **Логан** (2017), **Spider...'
2025-06-17 08:00:44,402 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:00:54,486 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Интерстеллар** (2014), **Логан** (2017), **Логан** (2017), **Spider...'
2025-06-17 08:01:04,124 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:01:08,224 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'У вас есть сохраненные фильмы: **Интерстеллар** (2014), **Логан** (2017), **Логан** (2017), **Spider...'
2025-06-17 08:01:16,514 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:01:18,869 - formatter - INFO - Сформированы детали фильма для Telegram: Дэдпул 2
2025-06-17 08:01:19,047 - callbacks - INFO - Пользователю 577976124 показаны детали фильма ID: 16.
2025-06-17 08:01:27,735 - handlers - INFO - Запрос от пользователя 577976124: хлеб
2025-06-17 08:01:27,995 - recommendation_engine - INFO - Начало генерации рекомендаций для пользователя 577976124 по запросу: 'хлеб'
2025-06-17 08:01:27,995 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 08:01:29,473 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'хлеб

НЕ рекомендуй эти фильмы (уже известны пользователю): Война миров...'
2025-06-17 08:01:30,835 - recommendation_engine - INFO - LLM candidate response: Инception (2010), Мехадром (2019), Вторжение (2018), Фортилаче (2021), Шпионский мир (2015).
2025-06-17 08:01:30,835 - recommendation_engine - INFO - Extracted initial candidate titles: [('Инception', 2010), ('Мехадром', 2019), ('Вторжение', 2018), ('Фортилаче', 2021), ('Шпионский мир', 2015)]
2025-06-17 08:01:30,835 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 08:01:31,806 - recommendation_engine - INFO - Translated Russian title 'Инception' to English for TMDB search: 'Inception'
2025-06-17 08:01:31,807 - recommendation_engine - INFO - Searching TMDB for movie: 'Inception' (original: 'Инception')
2025-06-17 08:01:32,387 - tmdb_agent - INFO - Найдено 9 фильмов для запроса 'Inception'.
2025-06-17 08:01:32,891 - tmdb_agent - INFO - Получены детали для фильма 'Начало' (TMDB ID: 27205).
2025-06-17 08:01:32,892 - tmdb_agent - INFO - Фильм 'Начало' обогащен данными.
2025-06-17 08:01:32,892 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 08:01:33,735 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 08:01:35,512 - recommendation_engine - INFO - No sufficient fuzzy match for 'Начало'. Comparisons: LLM_vs_TMDB_Localized ('инception' vs 'начало'): 0.13; LLM_vs_TMDB_Original_Translated ('инception' vs 'взлёт'): 0.00
2025-06-17 08:01:35,513 - recommendation_engine - WARNING - Movie 'Начало' deemed not relevant to original query: 'хлеб...' or LLM suggestion. Skipping.
2025-06-17 08:01:35,513 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 08:01:36,711 - recommendation_engine - INFO - Translated Russian title 'Мехадром' to English for TMDB search: 'Mechanism'
2025-06-17 08:01:36,711 - recommendation_engine - INFO - Searching TMDB for movie: 'Mechanism' (original: 'Мехадром')
2025-06-17 08:01:37,238 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Mechanism'.
2025-06-17 08:01:37,697 - tmdb_agent - INFO - Получены детали для фильма 'Mechanism' (TMDB ID: 1378739).
2025-06-17 08:01:37,697 - tmdb_agent - INFO - Фильм 'Mechanism' обогащен данными.
2025-06-17 08:01:37,698 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 08:01:38,985 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 08:01:40,860 - recommendation_engine - INFO - Fuzzy match found (LLM vs Translated Original TMDB) for 'Mechanism'. Ratio: 0.62
2025-06-17 08:01:40,865 - movie_database - INFO - Фильм 'Mechanism' (TMDB ID: 1378739) добавлен/обновлен в базу данных.
2025-06-17 08:01:40,865 - recommendation_engine - INFO - Added movie 'Mechanism' to DB as ID 36
2025-06-17 08:01:40,867 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=36, action_type='recommendation'.
2025-06-17 08:01:40,867 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 36
2025-06-17 08:01:40,867 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 08:01:41,986 - recommendation_engine - INFO - Translated Russian title 'Вторжение' to English for TMDB search: 'Invasion'
2025-06-17 08:01:41,986 - recommendation_engine - INFO - Searching TMDB for movie: 'Invasion' (original: 'Вторжение')
2025-06-17 08:01:42,506 - tmdb_agent - INFO - Найдено 20 фильмов для запроса 'Invasion'.
2025-06-17 08:01:43,516 - tmdb_agent - INFO - Получены детали для фильма 'Invasión' (TMDB ID: 1244880).
2025-06-17 08:01:43,516 - tmdb_agent - INFO - Фильм 'Invasión' обогащен данными.
2025-06-17 08:01:43,517 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 08:01:44,629 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 08:01:45,697 - recommendation_engine - INFO - No sufficient fuzzy match for 'Invasión'. Comparisons: LLM_vs_TMDB_Localized ('вторжение' vs 'invasión'): 0.00; LLM_vs_TMDB_Original_Translated ('вторжение' vs 'захват'): 0.27
2025-06-17 08:01:45,698 - recommendation_engine - WARNING - Movie 'Invasión' deemed not relevant to original query: 'хлеб...' or LLM suggestion. Skipping.
2025-06-17 08:01:45,698 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 08:01:46,882 - recommendation_engine - INFO - Translated Russian title 'Фортилаче' to English for TMDB search: 'Fortilache'
2025-06-17 08:01:46,882 - recommendation_engine - INFO - Searching TMDB for movie: 'Fortilache' (original: 'Фортилаче')
2025-06-17 08:01:47,318 - tmdb_agent - INFO - Найдено 0 фильмов для запроса 'Fortilache'.
2025-06-17 08:01:47,319 - tmdb_agent - WARNING - Не удалось обогатить данные для запроса: 'Fortilache'.
2025-06-17 08:01:47,319 - recommendation_engine - WARNING - Could not find or enrich movie data for candidate title: 'Fortilache' (original: 'Фортилаче'). Skipping.
2025-06-17 08:01:47,319 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following Russian text into fluent English. Provide...'
2025-06-17 08:01:48,724 - recommendation_engine - INFO - Translated Russian title 'Шпионский мир' to English for TMDB search: 'Spy world'
2025-06-17 08:01:48,725 - recommendation_engine - INFO - Searching TMDB for movie: 'Spy world' (original: 'Шпионский мир')
2025-06-17 08:01:49,088 - tmdb_agent - INFO - Найдено 5 фильмов для запроса 'Spy world'.
2025-06-17 08:01:49,361 - tmdb_agent - INFO - Получены детали для фильма 'Дети шпионов 4D' (TMDB ID: 56288).
2025-06-17 08:01:49,361 - tmdb_agent - INFO - Фильм 'Дети шпионов 4D' обогащен данными.
2025-06-17 08:01:49,362 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Detect the language of the following text and return ONLY the ISO 639-1 code (e.g., 'en', 'ru', 'fr'...'
2025-06-17 08:01:51,356 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'You are a professional translator. Translate the following English text into fluent Russian. Provide...'
2025-06-17 08:01:53,824 - recommendation_engine - INFO - Fuzzy match found (LLM vs Localized TMDB) for 'Дети шпионов 4D'. Ratio: 0.43
2025-06-17 08:01:53,829 - movie_database - INFO - Фильм 'Дети шпионов 4D' (TMDB ID: 56288) добавлен/обновлен в базу данных.
2025-06-17 08:01:53,830 - recommendation_engine - INFO - Added movie 'Дети шпионов 4D' to DB as ID 37
2025-06-17 08:01:53,831 - movie_database - INFO - Запись истории добавлена: user_id=577976124, movie_id=37, action_type='recommendation'.
2025-06-17 08:01:53,832 - recommendation_engine - INFO - Saved recommendation history for user 577976124, movie 37
2025-06-17 08:01:53,832 - agents.llm_generator - INFO - Sending prompt to LLM (attempt 1/3): 'Вот список фильмов, которые я для вас подобрал: **Mechanism** (2024), **Дети шпионов 4D** (2011).Нап...'
2025-06-17 08:02:00,418 - keyboards - INFO - Сформирована клавиатура 'post_action' для контекста: main_menu.
2025-06-17 08:02:02,467 - main - CRITICAL - Fatal error during bot startup: Cannot close a running event loop
Traceback (most recent call last):
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 176, in <module>
    asyncio.run(main())
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 30, in run
    return loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/nest_asyncio.py", line 98, in run_until_complete
    return f.result()
           ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/futures.py", line 203, in result
    raise self._exception.with_traceback(self._exception_tb)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/tasks.py", line 267, in __step
    result = coro.send(None)
             ^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/main.py", line 171, in main
    await app.run_polling(drop_pending_updates=True)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 818, in run_polling
    return self.__run(
           ^^^^^^^^^^^
  File "/Users/gumbatali/PycharmProjects/MainDuane/.venv/lib/python3.11/site-packages/telegram/ext/_application.py", line 1022, in __run
    loop.close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/unix_events.py", line 68, in close
    super().close()
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/selector_events.py", line 88, in close
    raise RuntimeError("Cannot close a running event loop")
RuntimeError: Cannot close a running event loop
